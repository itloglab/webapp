<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³  ê´€ë¦¬ - ê±´ì„¤ ìì¬ ERP</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s;
        }
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--gray-50);
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item-code {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }
        .autocomplete-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .autocomplete-item-info {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }
        #materialTable.hide-as-receive th.as-receive-col,
        #materialTable.hide-as-receive td.as-receive-col {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="dashboard.html">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
        <a href="contract.html">ğŸ“‹ ê²¬ì </a>
        <a href="inventory.html">ğŸ“¦ ì¬ê³ </a>
        <a href="order.html">ğŸ“ ë°œì£¼</a>
        <a href="receiving.html" class="active">ğŸ“¥ ì…ê³ </a>
        <a href="shipment.html">ğŸšš ì¶œê³ </a>
        <!-- <a href="purchase.html">ğŸ›’ êµ¬ë§¤</a> -->
        <a href="as.html">ğŸ”§ AS</a>
        <a href="materials.html">ğŸ“ ìì¬ì •ë³´</a>
        <a href="project.html">ğŸ“Š í˜„ì¥ í†µí•© í˜„í™©</a>
    </nav>
    
    <main class="main">
        <div class="search-box">
            <div class="search-row">
                <select class="filter-select"><option>ìœ í˜• ì „ì²´</option><option>êµ¬ë§¤ ì…ê³ </option><option>í˜„ì¥ íšŒìˆ˜</option><option>AS ì…ê³ </option><option>ê¸°íƒ€ ì…ê³ </option></select>
                <select class="filter-select"><option>ìƒíƒœ ì „ì²´</option><option>ëŒ€ê¸°</option><option>ê²€ìˆ˜ì¤‘</option><option>ì™„ë£Œ</option></select>
                <select class="filter-select"><option>ì°½ê³  ì „ì²´</option><option>ë³¸ì‚¬ ì°½ê³ </option><option>ê°•ë‚¨ ì°½ê³ </option></select>
                <div style="display:flex;gap:0.5rem;flex:1;min-width:200px">
                    <input type="text" class="search-input" placeholder="ì…ê³ ë²ˆí˜¸/êµ¬ë§¤ë²ˆí˜¸/ìì¬ëª… ê²€ìƒ‰..." style="flex:1">
                    <button class="btn btn-primary" onclick="handleSearch()">ê²€ìƒ‰</button>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <div class="summary-box" style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;flex-wrap:wrap;gap:1.5rem">
                <span class="summary-item">êµ¬ë§¤: <strong>120ê±´</strong></span>
                <span class="summary-item">í˜„ì¥ íšŒìˆ˜: <strong>53ê±´</strong></span>
                <span class="summary-item">AS: <strong>15ê±´</strong></span>
                <span class="summary-item">ê¸°íƒ€: <strong>8ê±´</strong></span>
            </div>
            <button class="btn btn-primary" onclick="openAddModal()" style="white-space:nowrap">+ ì‹ ê·œ ì…ê³ </button>
        </div>
        
        <div class="table-container">
            <table>
                <thead><tr><th>ì…ê³  ë²ˆí˜¸</th><th>ìœ í˜•</th><th>ì°¸ì¡° ë²ˆí˜¸</th><th>ë°œì£¼</th><th>ê³µê¸‰ì‚¬/í˜„ì¥</th><th>ì…ê³ ì¼</th><th>ìì¬</th><th>ì°½ê³ </th><th>ìƒíƒœ</th><th>ì‘ì—…</th></tr></thead>
                <tbody>
                    <tr onclick="showDetail('purchase')" style="cursor:pointer">
                        <td><strong>IN-2024-050</strong></td>
                        <td><span class="status-badge status-ok">êµ¬ë§¤</span></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">PO-2024-001</a></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                        <td>í•œí™”í…Œí¬ìœˆ</td>
                        <td>2024-02-03</td>
                        <td>2ì¢… 60ê°œ</td>
                        <td>ë³¸ì‚¬</td>
                        <td><span class="status-badge status-complete">ì™„ë£Œ</span></td>
                        <td></td>
                    </tr>
                    <tr onclick="showDetail('return')" style="cursor:pointer">
                        <td><strong>IN-2024-049</strong></td>
                        <td><span class="status-badge status-approved">í˜„ì¥ íšŒìˆ˜</span></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">OUT-2024-029</a></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                        <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                        <td>2024-02-02</td>
                        <td>5ì¢… 85ê°œ</td>
                        <td>ë³¸ì‚¬</td>
                        <td><span class="status-badge status-complete">ì™„ë£Œ</span></td>
                        <td></td>
                    </tr>
                    <tr onclick="showDetail('purchase')" style="cursor:pointer">
                        <td><strong>IN-2024-048</strong></td>
                        <td><span class="status-badge status-ok">êµ¬ë§¤</span></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">PO-2024-002</a></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260118-01</a></td>
                        <td>í•˜ì´í¬ë¹„ì „</td>
                        <td>2024-02-01</td>
                        <td>3ì¢… 45ê°œ</td>
                        <td>ë³¸ì‚¬</td>
                        <td><span class="status-badge status-pending">ê²€ìˆ˜ì¤‘</span></td>
                        <td onclick="event.stopPropagation()">
                            <button class="btn btn-primary btn-sm" onclick="openInspection()">ê²€ìˆ˜</button>
                        </td>
                    </tr>
                    <tr onclick="showDetail('as')" style="cursor:pointer">
                        <td><strong>IN-2024-047</strong></td>
                        <td><span class="status-badge status-warning">AS</span></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">AS-2024-002</a></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260118-01</a></td>
                        <td>íŒêµ ê³µì¥</td>
                        <td>2024-01-30</td>
                        <td>1ì¢… 1ê°œ</td>
                        <td>ASì°½ê³ </td>
                        <td><span class="status-badge status-complete">ì™„ë£Œ</span></td>
                        <td></td>
                    </tr>
                    <tr onclick="showDetail('return')" style="cursor:pointer">
                        <td><strong>IN-2024-046</strong></td>
                        <td><span class="status-badge status-approved">í˜„ì¥ íšŒìˆ˜</span></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">OUT-2024-030</a></td>
                        <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                        <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                        <td>2024-01-28</td>
                        <td>1ì¢… 2ê°œ</td>
                        <td>ë³¸ì‚¬</td>
                        <td><span class="status-badge status-complete">ì™„ë£Œ</span></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination">
                <button class="page-btn">â—€</button>
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
                <button class="page-btn">â–¶</button>
            </div>
        </div>
    </main>
    
    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="detailModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title" id="detailTitle">ğŸ“¥ ì…ê³  ìƒì„¸ - IN-2024-050</h2>
                <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box" id="detailInfo">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
                <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">ğŸ“¦ ì…ê³  ìì¬</div>
                <table id="detailTable">
                    <thead><tr><th>ìì¬ëª…</th><th>ë¡œíŠ¸/ì‹œë¦¬ì–¼</th><th>ìˆ˜ëŸ‰</th><th>ê²€ìˆ˜ ê²°ê³¼</th><th>ì…ê³  ìœ„ì¹˜</th></tr></thead>
                    <tbody id="detailMaterials"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
                <button class="btn btn-primary">ì…ê³ ì¦ ì¶œë ¥</button>
            </div>
        </div>
    </div>
    
    <!-- ì‹ ê·œ ì…ê³  ëª¨ë‹¬ -->
    <div class="modal" id="addModal">
        <div class="modal-content xl">
            <div class="modal-header">
                <h2 class="modal-title">ì‹ ê·œ ì…ê³  ë“±ë¡</h2>
                <button class="close-btn" onclick="closeModal('addModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ì…ê³  ìœ í˜• *</label>
                    <div style="display:flex;gap:1rem;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:0.375rem;cursor:pointer"><input type="radio" name="receiveType" value="purchase" checked onchange="changeReceiveType()"> êµ¬ë§¤ ì…ê³ </label>
                        <label style="display:flex;align-items:center;gap:0.375rem;cursor:pointer"><input type="radio" name="receiveType" value="return" onchange="changeReceiveType()"> í˜„ì¥ íšŒìˆ˜</label>
                        <label style="display:flex;align-items:center;gap:0.375rem;cursor:pointer"><input type="radio" name="receiveType" value="etc" onchange="changeReceiveType()"> ê¸°íƒ€ ì…ê³ </label>
                    </div>
                </div>
                <div class="form-row" id="companySiteGroup" style="display:none">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">ë³¸ì‚¬/í˜„ì¥ *</label>
                        <div style="position:relative">
                            <input type="text" class="form-input" id="companySiteSearch" placeholder="ë³¸ì‚¬ëª… ë˜ëŠ” í˜„ì¥ëª… ê²€ìƒ‰..." autocomplete="off" oninput="handleCompanySiteSearch()" onfocus="handleCompanySiteSearch()" onkeydown="handleCompanySiteKeydown(event)" onblur="setTimeout(() => hideCompanySiteAutocomplete(), 200)">
                            <div id="companySiteAutocomplete" class="autocomplete-dropdown" style="display:none"></div>
                        </div>
                        <input type="hidden" id="selectedCompany" value="">
                        <input type="hidden" id="selectedSite" value="">
                    </div>
                    <div class="form-group" style="display:flex;align-items:flex-end">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="loadReference()" id="loadBtn" style="white-space:nowrap;margin-bottom:0" disabled>ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>
                <div class="form-row" id="refSelectGroup" style="display:none">
                    <div class="form-group">
                        <label class="form-label" id="refLabel">êµ¬ë§¤ ë²ˆí˜¸</label>
                        <select class="form-select" id="refSelect">
                            <option value="">ì„ íƒ</option>
                            <option value="PO-2024-005">PO-2024-005 - í•œí™”í…Œí¬ìœˆ</option>
                            <option value="PO-2024-006">PO-2024-006 - í•˜ì´í¬ë¹„ì „</option>
                        </select>
                    </div>
                </div>
                <div class="info-box highlight" id="refInfo" style="display:none">
                    <div id="refInfoContent"></div>
                </div>
                <div class="form-group" id="returnReasonGroup" style="display:none">
                    <label class="form-label">íšŒìˆ˜ ì‚¬ìœ  *</label>
                    <select class="form-select" id="returnReason" required>
                        <option value="">ì„ íƒ</option>
                        <option value="ë¯¸ì‚¬ìš©">ë¯¸ì‚¬ìš© ì”ì—¬</option>
                        <option value="í˜„ì¥ì¢…ë£Œ">í˜„ì¥ ì¢…ë£Œ</option>
                        <option value="ì„¤ì¹˜ì·¨ì†Œ">ì„¤ì¹˜ ì·¨ì†Œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ì…ê³ ì¼ *</label>
                        <input type="datetime-local" class="form-input" value="2024-02-03T14:00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì…ê³  ì°½ê³  *</label>
                        <select class="form-select" id="warehouseSelect" required>
                            <option value="">ì°½ê³  ì„ íƒ</option>
                            <option value="1">ë³¸ì‚¬ ì°½ê³ </option>
                            <option value="2">ê°•ë‚¨ ì°½ê³ </option>
                            <option value="3">AS ì°½ê³ </option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ì…ê³  ìì¬ *</label>
                    <div style="border:1px solid var(--gray-200);border-radius:6px;overflow:visible;position:relative">
                        <div style="padding:0.75rem;background:var(--gray-50);display:flex;gap:0.5rem">
                            <div style="position:relative;flex:1;z-index:10">
                                <input type="text" id="materialSearch" class="form-input" placeholder="ìì¬ ì½”ë“œ, ìì¬ëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..." style="width:100%" autocomplete="off" oninput="handleMaterialSearch()" onkeydown="handleMaterialKeydown(event)" onfocus="handleMaterialFocus()" onblur="setTimeout(() => hideMaterialAutocomplete(), 200)">
                                <div id="materialAutocomplete" class="autocomplete-dropdown" style="display:none;z-index:1001"></div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addMaterial()">+ ì¶”ê°€</button>
                        </div>
                        <table style="margin:0" id="materialTable">
                            <thead><tr><th>ìì¬ëª… / ê·œê²©</th><th style="width:110px" class="as-receive-col">AS ì…ê³  ì—¬ë¶€</th><th style="width:180px" class="as-receive-col">ìˆ˜ëŸ‰ (AS/ì¼ë°˜)</th><th style="width:120px">ì‹œë¦¬ì–¼</th><th style="width:50px">ì‚­ì œ</th></tr></thead>
                            <tbody id="materialList"><tr><td colspan="5" style="text-align:center;color:var(--gray-500);padding:2rem">ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ê³ </label>
                    <textarea class="form-textarea" placeholder="ì…ê³  ê´€ë ¨ íŠ¹ì´ì‚¬í•­"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModal')">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="submitReceiving()">ì…ê³  ë“±ë¡</button>
            </div>
        </div>
    </div>
    
    <!-- ê²€ìˆ˜ ëª¨ë‹¬ -->
    <div class="modal" id="inspectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì…ê³  ê²€ìˆ˜ - IN-2024-049</h2>
                <button class="close-btn" onclick="closeModal('inspectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box highlight">
                    <div style="font-size:0.875rem">êµ¬ë§¤: <strong>PO-2024-002</strong> | ê³µê¸‰ì‚¬: <strong>í•˜ì´í¬ë¹„ì „</strong> | ì…ê³ ì¼: <strong>2024-02-02</strong></div>
                </div>
                <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">ğŸ“¦ ê²€ìˆ˜ ìì¬</div>
                <table>
                    <thead><tr><th>ìì¬ëª…</th><th>ì…ê³  ìˆ˜ëŸ‰</th><th style="width:100px">ì •ìƒ</th><th style="width:100px">ë¶ˆëŸ‰</th><th style="width:100px">ê²€ìˆ˜ ê²°ê³¼</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>IPì¹´ë©”ë¼ 4MP</td>
                            <td>30ê°œ</td>
                            <td><input type="number" class="form-input" value="30" style="padding:0.25rem"></td>
                            <td><input type="number" class="form-input" value="0" style="padding:0.25rem"></td>
                            <td><select class="form-select" style="padding:0.25rem"><option>ì •ìƒ</option><option>ì¼ë¶€ë¶ˆëŸ‰</option><option>ì „ëŸ‰ë¶ˆëŸ‰</option></select></td>
                        </tr>
                        <tr>
                            <td>NVR 32ì±„ë„</td>
                            <td>10ê°œ</td>
                            <td><input type="number" class="form-input" value="9" style="padding:0.25rem"></td>
                            <td><input type="number" class="form-input" value="1" style="padding:0.25rem"></td>
                            <td><select class="form-select" style="padding:0.25rem"><option>ì •ìƒ</option><option selected>ì¼ë¶€ë¶ˆëŸ‰</option><option>ì „ëŸ‰ë¶ˆëŸ‰</option></select></td>
                        </tr>
                        <tr>
                            <td>PoE ìŠ¤ìœ„ì¹˜</td>
                            <td>5ê°œ</td>
                            <td><input type="number" class="form-input" value="5" style="padding:0.25rem"></td>
                            <td><input type="number" class="form-input" value="0" style="padding:0.25rem"></td>
                            <td><select class="form-select" style="padding:0.25rem"><option>ì •ìƒ</option><option>ì¼ë¶€ë¶ˆëŸ‰</option><option>ì „ëŸ‰ë¶ˆëŸ‰</option></select></td>
                        </tr>
                    </tbody>
                </table>
                <div class="form-group" style="margin-top:1rem">
                    <label class="form-label">ê²€ìˆ˜ ì˜ê²¬</label>
                    <textarea class="form-textarea" placeholder="ê²€ìˆ˜ ê²°ê³¼ ë° íŠ¹ì´ì‚¬í•­">NVR 32ì±„ë„ 1ëŒ€ ì™¸ê´€ íŒŒì† - ê³µê¸‰ì‚¬ ë°˜í’ˆ ì²˜ë¦¬ ì˜ˆì •</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('inspectionModal')">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="completeInspection()">ê²€ìˆ˜ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ì‹œë¦¬ì–¼ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="serialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì‹œë¦¬ì–¼ ì„ íƒ - <span id="serialMaterialName">IPì¹´ë©”ë¼ 2MP</span></h2>
                <button class="close-btn" onclick="closeModal('serialModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box highlight" style="margin-bottom:1rem">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>ì…ê³  ìˆ˜ëŸ‰: <strong id="serialQty">4</strong>ê°œ</div>
                        <button class="btn btn-sm btn-secondary" onclick="selectAllSerials()">ì „ì²´ ì„ íƒ</button>
                    </div>
                </div>
                
                <div style="max-height:300px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:6px">
                    <table style="margin:0">
                        <thead style="position:sticky;top:0;background:#fff">
                            <tr>
                                <th style="width:40px"></th>
                                <th>ì‹œë¦¬ì–¼ ë²ˆí˜¸</th>
                                <th>ìœ„ì¹˜</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="serialList">
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-001</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-002</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-003</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-004</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-005</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-03</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-006</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-007</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-008</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="info-box" style="margin-top:1rem;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        ì„ íƒ: <strong id="selectedCount">4</strong>ê°œ / ì…ê³ ìˆ˜ëŸ‰: <strong id="requiredCount">4</strong>ê°œ
                    </div>
                    <div id="serialMatchStatus">
                        <span style="color:var(--success);font-weight:600">âœ… ì¼ì¹˜</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('serialModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmSerialSelection()">ì„ íƒ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
    
    <script>
        function showDetail(type) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailTitle');
            const info = document.getElementById('detailInfo');
            const materials = document.getElementById('detailMaterials');
            
            if (type === 'purchase') {
                title.textContent = 'ğŸ“¥ êµ¬ë§¤ ì…ê³  ìƒì„¸ - IN-2024-050';
                info.innerHTML = `
                    <div class="info-row"><span class="info-label">ì…ê³  ë²ˆí˜¸</span><strong>IN-2024-050</strong></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ìœ í˜•</span><span class="status-badge status-ok">êµ¬ë§¤ ì…ê³ </span></div>
                    <div class="info-row"><span class="info-label">êµ¬ë§¤ ë²ˆí˜¸</span><a href="#" class="btn-link">PO-2024-001</a></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼</span><a href="#" class="btn-link">ORD-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV</a></div>
                    <div class="info-row"><span class="info-label">ê³µê¸‰ì‚¬</span><span>í•œí™”í…Œí¬ìœˆ</span></div>
                    <div class="info-row"><span class="info-label">ì…ê³ ì¼</span><span>2024-02-03 14:00</span></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ì°½ê³ </span><span>ë³¸ì‚¬ ì°½ê³ </span></div>
                    <div class="info-row"><span class="info-label">ë‹´ë‹¹ì</span><span>ê¹€ì°½ê³ </span></div>
                    <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="status-badge status-complete">ì™„ë£Œ</span></div>
                `;
                materials.innerHTML = `
                    <tr><td>IPì¹´ë©”ë¼ 2MP</td><td>LOT-2024-050</td><td>50ê°œ</td><td><span class="status-badge status-ok">ì •ìƒ</span></td><td>A-01-01</td></tr>
                    <tr><td>NVR 16ì±„ë„</td><td>LOT-2024-051</td><td>10ê°œ</td><td><span class="status-badge status-ok">ì •ìƒ</span></td><td>A-02-01</td></tr>
                `;
            } else if (type === 'as') {
                title.textContent = 'ğŸ“¥ AS ì…ê³  ìƒì„¸ - IN-2024-049';
                info.innerHTML = `
                    <div class="info-row"><span class="info-label">ì…ê³  ë²ˆí˜¸</span><strong>IN-2024-049</strong></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ìœ í˜•</span><span class="status-badge status-warning">AS ì…ê³ </span></div>
                    <div class="info-row"><span class="info-label">AS ë²ˆí˜¸</span><a href="#" class="btn-link">AS-2024-001</a></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼</span><a href="#" class="btn-link">ORD-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV</a></div>
                    <div class="info-row"><span class="info-label">íšŒìˆ˜ í˜„ì¥</span><span>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</span></div>
                    <div class="info-row"><span class="info-label">ë¬¸ì œ ìœ í˜•</span><strong style="color:var(--danger)">ì´ˆê¸° ë¶ˆëŸ‰</strong></div>
                    <div class="info-row"><span class="info-label">ì…ê³ ì¼</span><span>2024-02-02 09:00</span></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ì°½ê³ </span><span>AS ì°½ê³ </span></div>
                    <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="status-badge status-pending">ê²€ìˆ˜ì¤‘</span></div>
                `;
                materials.innerHTML = `
                    <tr><td>IPì¹´ë©”ë¼ 2MP</td><td>CAM-2024-015</td><td>1ê°œ</td><td><span class="status-badge status-warning">ê²€ìˆ˜ì¤‘</span></td><td>AS-ZONE</td></tr>
                `;
            } else if (type === 'return') {
                title.textContent = 'ğŸ“¥ í˜„ì¥ íšŒìˆ˜ ì…ê³  ìƒì„¸ - IN-2024-046';
                info.innerHTML = `
                    <div class="info-row"><span class="info-label">ì…ê³  ë²ˆí˜¸</span><strong>IN-2024-046</strong></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ìœ í˜•</span><span class="status-badge status-approved">í˜„ì¥ íšŒìˆ˜</span></div>
                    <div class="info-row"><span class="info-label">ì¶œê³  ë²ˆí˜¸</span><a href="#" class="btn-link">OUT-2024-030</a></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼</span><a href="#" class="btn-link">IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV</a></div>
                    <div class="info-row"><span class="info-label">íšŒìˆ˜ í˜„ì¥</span><span>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</span></div>
                    <div class="info-row"><span class="info-label">íšŒìˆ˜ ì‚¬ìœ </span><span>ë¯¸ì‚¬ìš© ì”ì—¬</span></div>
                    <div class="info-row"><span class="info-label">ì…ê³ ì¼</span><span>2024-01-28 15:00</span></div>
                    <div class="info-row"><span class="info-label">ì…ê³  ì°½ê³ </span><span>ë³¸ì‚¬ ì°½ê³ </span></div>
                    <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="status-badge status-complete">ì™„ë£Œ</span></div>
                `;
                materials.innerHTML = `
                    <tr><td>IPì¹´ë©”ë¼ 2MP</td><td>LOT-2024-030</td><td>15ê°œ</td><td><span class="status-badge status-ok">ì •ìƒ</span></td><td>A-01-01</td></tr>
                    <tr><td>NVR 16ì±„ë„</td><td>LOT-2024-031</td><td>2ê°œ</td><td><span class="status-badge status-ok">ì •ìƒ</span></td><td>A-02-01</td></tr>
                `;
            }
            modal.classList.add('active');
        }
        
        function openAddModal() { document.getElementById('addModal').classList.add('active'); }
        function openInspection() { document.getElementById('inspectionModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // ë³¸ì‚¬ë³„ í˜„ì¥ ë°ì´í„°
        const SITES_BY_COMPANY = {
            'ê°•ë‚¨ê±´ì„¤': ['ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”', 'ê°•ë‚¨ ìƒê°€'],
            'ì‚¼ì„±ë¬¼ì‚°': ['íŒêµ ê³µì¥', 'íŒêµ ì—°êµ¬ì†Œ'],
            'ì¸ì²œê±´ì„¤': ['ì¸ì²œ ë¬¼ë¥˜ì„¼í„°', 'ì¸ì²œ ê³µì¥']
        };
        
        // í†µí•© ê²€ìƒ‰ì„ ìœ„í•œ ì „ì²´ ë³¸ì‚¬/í˜„ì¥ ëª©ë¡
        const ALL_COMPANY_SITES = [];
        Object.keys(SITES_BY_COMPANY).forEach(company => {
            const sites = SITES_BY_COMPANY[company];
            sites.forEach(site => {
                ALL_COMPANY_SITES.push({
                    company: company,
                    site: site,
                    searchText: `${company} ${site}`.toLowerCase()
                });
            });
        });
        
        // ë³¸ì‚¬/í˜„ì¥ í†µí•© ê²€ìƒ‰ ê¸°ëŠ¥
        let companySiteAutocompleteIndex = -1;
        let companySiteAutocompleteItems = [];
        
        function handleCompanySiteSearch() {
            const keyword = document.getElementById('companySiteSearch').value.trim().toLowerCase();
            const dropdown = document.getElementById('companySiteAutocomplete');
            
            if (!keyword) {
                hideCompanySiteAutocomplete();
                return;
            }
            
            // ë³¸ì‚¬ëª…, í˜„ì¥ëª…ìœ¼ë¡œ ê²€ìƒ‰
            const filtered = ALL_COMPANY_SITES.filter(item => 
                item.searchText.includes(keyword) ||
                item.company.toLowerCase().includes(keyword) ||
                item.site.toLowerCase().includes(keyword)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);cursor:default">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            companySiteAutocompleteItems = filtered;
            companySiteAutocompleteIndex = -1;
            
            dropdown.innerHTML = filtered.map((item, idx) => `
                <div class="autocomplete-item" data-index="${idx}" onclick="selectCompanySite(${idx})" onmouseover="highlightCompanySite(${idx})">
                    <div class="autocomplete-item-name">${item.site}</div>
                    <div class="autocomplete-item-info">${item.company}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function handleCompanySiteKeydown(event) {
            const dropdown = document.getElementById('companySiteAutocomplete');
            if (dropdown.style.display === 'none' || companySiteAutocompleteItems.length === 0) {
                return;
            }
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                companySiteAutocompleteIndex = Math.min(companySiteAutocompleteIndex + 1, companySiteAutocompleteItems.length - 1);
                highlightCompanySite(companySiteAutocompleteIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                companySiteAutocompleteIndex = Math.max(companySiteAutocompleteIndex - 1, -1);
                highlightCompanySite(companySiteAutocompleteIndex);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (companySiteAutocompleteIndex >= 0 && companySiteAutocompleteIndex < companySiteAutocompleteItems.length) {
                    selectCompanySite(companySiteAutocompleteIndex);
                }
            } else if (event.key === 'Escape') {
                hideCompanySiteAutocomplete();
            }
        }
        
        function highlightCompanySite(index) {
            const items = document.getElementById('companySiteAutocomplete').querySelectorAll('.autocomplete-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            companySiteAutocompleteIndex = index;
        }
        
        function selectCompanySite(index) {
            const item = companySiteAutocompleteItems[index];
            if (!item) return;
            
            document.getElementById('companySiteSearch').value = `${item.company} - ${item.site}`;
            document.getElementById('selectedCompany').value = item.company;
            document.getElementById('selectedSite').value = item.site;
            hideCompanySiteAutocomplete();
            
            // ë³¸ì‚¬/í˜„ì¥ ì„ íƒ ì‹œ ë°œì£¼ ëª©ë¡ ë¡œë“œ
            loadOrderOptions();
        }
        
        function hideCompanySiteAutocomplete() {
            document.getElementById('companySiteAutocomplete').style.display = 'none';
            companySiteAutocompleteIndex = -1;
        }
        
        function changeReceiveType() {
            const type = document.querySelector('input[name="receiveType"]:checked').value;
            const refLabel = document.getElementById('refLabel');
            const refSelect = document.getElementById('refSelect');
            const refSelectGroup = document.getElementById('refSelectGroup');
            const companySiteGroup = document.getElementById('companySiteGroup');
            const warehouseSelect = document.getElementById('warehouseSelect');
            const showAsReceiveCol = type !== 'purchase';
            setAsReceiveColumnVisibility(showAsReceiveCol);
            
            // ê¸°íƒ€ ì…ê³ ëŠ” ì°¸ì¡° ë¬¸ì„œ ì—†ìŒ
            if (type === 'etc') {
                refSelectGroup.style.display = 'none';
                companySiteGroup.style.display = 'none';
                warehouseSelect.value = '1';
                document.getElementById('returnReasonGroup').style.display = 'none';
                document.getElementById('refInfo').style.display = 'none';
                document.getElementById('materialList').innerHTML = `<tr><td colspan="${showAsReceiveCol ? 5 : 4}" style="text-align:center;color:var(--gray-500);padding:2rem">ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>`;
                return;
            }
            
            refSelectGroup.style.display = 'block';
            
            if (type === 'purchase') {
                companySiteGroup.style.display = 'none';
                refLabel.innerHTML = 'êµ¬ë§¤ ë²ˆí˜¸';
                refSelect.innerHTML = '<option value="">ì„ íƒ</option><option value="PO-2024-005">PO-2024-005 - í•œí™”í…Œí¬ìœˆ</option><option value="PO-2024-006">PO-2024-006 - í•˜ì´í¬ë¹„ì „</option>';
                warehouseSelect.value = '1';
                document.getElementById('returnReasonGroup').style.display = 'none';
            } else if (type === 'return') {
                companySiteGroup.style.display = 'grid';
                refSelectGroup.style.display = 'none';
                warehouseSelect.value = '1';
                document.getElementById('returnReasonGroup').style.display = 'block';
                // ë³¸ì‚¬/í˜„ì¥ ì´ˆê¸°í™”
                document.getElementById('companySiteSearch').value = '';
                document.getElementById('selectedCompany').value = '';
                document.getElementById('selectedSite').value = '';
                hideCompanySiteAutocomplete();
                // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
                const loadBtn = document.getElementById('loadBtn');
                if (loadBtn) loadBtn.disabled = true;
            }
            
            document.getElementById('refInfo').style.display = 'none';
            document.getElementById('materialList').innerHTML = `<tr><td colspan="${showAsReceiveCol ? 5 : 4}" style="text-align:center;color:var(--gray-500);padding:2rem">ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>`;
        }

        function setAsReceiveColumnVisibility(show) {
            const table = document.getElementById('materialTable');
            if (!table) return;
            table.classList.toggle('hide-as-receive', !show);
            const emptyTd = document.querySelector('#materialList td[colspan]');
            if (emptyTd) {
                emptyTd.setAttribute('colspan', show ? '5' : '4');
            }
        }
        
        // ë³¸ì‚¬/í˜„ì¥ë³„ ë°œì£¼ ë°ì´í„° (ëª©ì—…)
        const ORDERS_BY_COMPANY_SITE = {
            'ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”': [
                { value: 'IT260115-01', text: 'IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV' },
                { value: 'IT260120-01', text: 'IT260120-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” ì¶”ê°€ ì„¤ì¹˜' }
            ],
            'ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ìƒê°€': [
                { value: 'IT260125-01', text: 'IT260125-01 - ê°•ë‚¨ ìƒê°€ CCTV' }
            ],
            'ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥': [
                { value: 'IT260118-01', text: 'IT260118-01 - íŒêµ ê³µì¥ ì„¼ì„œ' }
            ],
            'ì‚¼ì„±ë¬¼ì‚°_íŒêµ ì—°êµ¬ì†Œ': [
                { value: 'IT260130-01', text: 'IT260130-01 - íŒêµ ì—°êµ¬ì†Œ ì„¤ì¹˜' }
            ],
            'ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°': [
                { value: 'IT260140-01', text: 'IT260140-01 - ì¸ì²œ ë¬¼ë¥˜ì„¼í„° í†µí•©' }
            ],
            'ì¸ì²œê±´ì„¤_ì¸ì²œ ê³µì¥': [
                { value: 'IT260145-01', text: 'IT260145-01 - ì¸ì²œ ê³µì¥ ì„¼ì„œ' }
            ]
        };
        
        // ë°œì£¼ë³„ ìì¬ ë°ì´í„° (ëª©ì—…)
        const ORDER_MATERIALS = {
            'IT260115-01': [
                { name: 'IPì¹´ë©”ë¼ 2MP', spec: '2MP, IP67', quantity: 50, lot: 'LOT-2024-052', location: 'A-01-01' },
                { name: 'NVR 16ì±„ë„', spec: '16CH, H.265', quantity: 10, lot: 'LOT-2024-053', location: 'A-02-01' },
                { name: 'UTP ì¼€ì´ë¸” CAT6', spec: '305m/ë°•ìŠ¤', quantity: 30, lot: 'LOT-2024-054', location: 'A-03-01' }
            ],
            'IT260118-01': [
                { name: 'IPì¹´ë©”ë¼ 4MP', spec: '4MP, ì‹¤ë‚´ìš©', quantity: 20, lot: 'LOT-2024-055', location: 'A-01-02' },
                { name: 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', spec: '24í¬íŠ¸, 250W', quantity: 5, lot: 'LOT-2024-056', location: 'A-02-02' }
            ],
            'IT260120-01': [
                { name: 'IPì¹´ë©”ë¼ 2MP', spec: '2MP, IP67', quantity: 30, lot: 'LOT-2024-060', location: 'A-01-03' }
            ],
            'IT260125-01': [
                { name: 'IPì¹´ë©”ë¼ 4MP', spec: '4MP, ì‹¤ë‚´ìš©', quantity: 15, lot: 'LOT-2024-061', location: 'A-01-04' },
                { name: 'NVR 32ì±„ë„', spec: '32CH, H.265', quantity: 5, lot: 'LOT-2024-062', location: 'A-02-04' }
            ],
            'IT260130-01': [
                { name: 'ì˜¨ë„ ì„¼ì„œ', spec: 'ì˜¨ë„ ì¸¡ì •, -40~85â„ƒ', quantity: 10, lot: 'LOT-2024-063', location: 'B-01-01' }
            ],
            'IT260140-01': [
                { name: 'IPì¹´ë©”ë¼ 2MP', spec: '2MP, IP67', quantity: 40, lot: 'LOT-2024-064', location: 'A-01-05' },
                { name: 'NVR 16ì±„ë„', spec: '16CH, H.265', quantity: 8, lot: 'LOT-2024-065', location: 'A-02-05' }
            ],
            'IT260145-01': [
                { name: 'ìŠµë„ ì„¼ì„œ', spec: 'ìŠµë„ ì¸¡ì •, 0~100%RH', quantity: 12, lot: 'LOT-2024-066', location: 'B-01-02' }
            ]
        };
        
        function loadOrderOptions() {
            const company = document.getElementById('selectedCompany').value;
            const site = document.getElementById('selectedSite').value;
            const loadBtn = document.getElementById('loadBtn');
            
            if (!company || !site) {
                if (loadBtn) loadBtn.disabled = true;
                return;
            }
            
            // ë³¸ì‚¬/í˜„ì¥ì´ ì„ íƒë˜ë©´ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í™œì„±í™”
            if (loadBtn) loadBtn.disabled = false;
        }
        
        function loadReference() {
            const type = document.querySelector('input[name="receiveType"]:checked').value;
            const refInfo = document.getElementById('refInfo');
            const refContent = document.getElementById('refInfoContent');
            const tbody = document.getElementById('materialList');
            
            // ê¸°ì¡´ ë¡œì§ (êµ¬ë§¤ë²ˆí˜¸ ë“±)
            if (type === 'purchase') {
                if (!document.getElementById('refSelect').value) {
                    refInfo.style.display = 'none';
                    return;
                }
                
                refInfo.style.display = 'block';
                
                if (type === 'purchase') {
                    refContent.innerHTML = '<div style="font-size:0.875rem">ê³µê¸‰ì‚¬: <strong>í•œí™”í…Œí¬ìœˆ</strong> | êµ¬ë§¤ì¼: <strong>2024-01-25</strong> | ê¸ˆì•¡: <strong style="color:var(--primary)">32,450,000ì›</strong></div>';
                    const rowId1 = 'row_' + Date.now() + '_1';
                    const rowId2 = 'row_' + Date.now() + '_2';
                    // IPì¹´ë©”ë¼ 2MPì™€ NVR 16ì±„ë„ì€ ì‹œë¦¬ì–¼ ìì¬
                    const serialHtml1 = `<div class="serial-container" data-row-id="${rowId1}">
                        <div class="serial-list" data-row-id="${rowId1}">
                            <div class="serial-item" style="display:flex;gap:0.25rem;margin-bottom:0.25rem;align-items:center">
                                <input type="text" class="form-input serial-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸" style="padding:0.25rem;flex:1" data-row-id="${rowId1}">
                                <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem" onclick="removeSerialInput(this, '${rowId1}')" style="display:none">ì‚­ì œ</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm" style="background:var(--primary);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem;width:100%;margin-top:0.25rem" onclick="addSerialInput('${rowId1}')">+ ì‹œë¦¬ì–¼ ì¶”ê°€</button>
                    </div>`;
                    const serialHtml2 = `<div class="serial-container" data-row-id="${rowId2}">
                        <div class="serial-list" data-row-id="${rowId2}">
                            <div class="serial-item" style="display:flex;gap:0.25rem;margin-bottom:0.25rem;align-items:center">
                                <input type="text" class="form-input serial-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸" style="padding:0.25rem;flex:1" data-row-id="${rowId2}">
                                <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem" onclick="removeSerialInput(this, '${rowId2}')" style="display:none">ì‚­ì œ</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm" style="background:var(--primary);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem;width:100%;margin-top:0.25rem" onclick="addSerialInput('${rowId2}')">+ ì‹œë¦¬ì–¼ ì¶”ê°€</button>
                    </div>`;
                    tbody.innerHTML = `
                        <tr data-row-id="${rowId1}" data-serial-tracking="true">
                            <td>
                                <div style="font-weight:500">IPì¹´ë©”ë¼ 2MP</div>
                                <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">2MP, IP67</div>
                            </td>
                            <td style="text-align:center" class="as-receive-col">
                                <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.8125rem">
                                    <input type="checkbox" class="as-receive-check" onchange="toggleAsQtyInput(this, '${rowId1}')">
                                    AS
                                </label>
                            </td>
                            <td class="as-receive-col">
                                <div style="display:flex;gap:0.5rem;align-items:center">
                                    <div style="flex:1">
                                        <input type="number" class="form-input as-qty-input" value="0" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId1}');updateSerialInputs('${rowId1}')" disabled>
                                    </div>
                                    <div style="flex:1">
                                        <input type="number" class="form-input normal-qty-input" value="50" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId1}');updateSerialInputs('${rowId1}')">
                                    </div>
                                </div>
                            </td>
                            <td style="min-width:200px">${serialHtml1}</td>
                            <td><button class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
                        </tr>
                        <tr data-row-id="${rowId2}" data-serial-tracking="true">
                            <td>
                                <div style="font-weight:500">NVR 16ì±„ë„</div>
                                <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">16CH, H.265</div>
                            </td>
                            <td style="text-align:center" class="as-receive-col">
                                <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.8125rem">
                                    <input type="checkbox" class="as-receive-check" onchange="toggleAsQtyInput(this, '${rowId2}')">
                                    AS
                                </label>
                            </td>
                            <td class="as-receive-col">
                                <div style="display:flex;gap:0.5rem;align-items:center">
                                    <div style="flex:1">
                                        <input type="number" class="form-input as-qty-input" value="0" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId2}');updateSerialInputs('${rowId2}')" disabled>
                                    </div>
                                    <div style="flex:1">
                                        <input type="number" class="form-input normal-qty-input" value="10" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId2}');updateSerialInputs('${rowId2}')">
                                    </div>
                                </div>
                            </td>
                            <td style="min-width:200px">${serialHtml2}</td>
                            <td><button class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
                        </tr>
                    `;
                }
            } else if (type === 'return') {
                // í˜„ì¥ íšŒìˆ˜ëŠ” ë³¸ì‚¬/í˜„ì¥ ì„ íƒ ì‹œ í•´ë‹¹ í˜„ì¥ì˜ ë°œì£¼ ìì¬ ë¶ˆëŸ¬ì˜¤ê¸°
                const company = document.getElementById('selectedCompany').value;
                const site = document.getElementById('selectedSite').value;
                
                if (!company || !site) {
                    alert('ë³¸ì‚¬/í˜„ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // í•´ë‹¹ í˜„ì¥ì˜ ì²« ë²ˆì§¸ ë°œì£¼ ì°¾ê¸°
                const key = `${company}_${site}`;
                const orders = ORDERS_BY_COMPANY_SITE[key] || [];
                
                if (orders.length === 0) {
                    alert('í•´ë‹¹ í˜„ì¥ì˜ ë°œì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì²« ë²ˆì§¸ ë°œì£¼ì˜ ìì¬ ë¶ˆëŸ¬ì˜¤ê¸°
                const orderNo = orders[0].value;
                if (ORDER_MATERIALS[orderNo]) {
                    const materials = ORDER_MATERIALS[orderNo];
                    tbody.innerHTML = '';
                    materials.forEach((material, index) => {
                        const spec = material.spec || '-';
                        const rowId = 'row_' + Date.now() + '_' + index;
                        // MATERIALS ë°°ì—´ì—ì„œ ìì¬ ì°¾ì•„ì„œ ì‹œë¦¬ì–¼ ìì¬ ì—¬ë¶€ í™•ì¸
                        const masterMaterial = MATERIALS.find(m => m.name === material.name || m.code === material.code);
                        const isSerialTracking = masterMaterial ? (masterMaterial.serialTracking === true) : false;
                        // í˜„ì¥ íšŒìˆ˜ì¸ ê²½ìš° ì‹œë¦¬ì–¼ ìì¬ëŠ” ëª¨ë‹¬ë¡œ ì„ íƒ
                        const serialHtml = isSerialTracking 
                            ? `<div class="serial-container" data-row-id="${rowId}" data-material-code="${masterMaterial ? masterMaterial.code : ''}" data-material-name="${material.name}">
                                <div class="selected-serial-list" data-row-id="${rowId}" style="min-height:60px;border:1px solid var(--gray-200);border-radius:4px;padding:0.5rem;margin-bottom:0.5rem;font-size:0.8125rem;color:var(--gray-500)">
                                    ì„ íƒëœ ì‹œë¦¬ì–¼ì´ ì—†ìŠµë‹ˆë‹¤.
                                </div>
                                <button type="button" class="btn btn-sm" style="background:var(--primary);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem;width:100%" onclick="openSerialModalForReturn('${rowId}', '${masterMaterial ? masterMaterial.code : ''}', '${material.name}', ${material.quantity})">+ ì‹œë¦¬ì–¼ ì„ íƒ</button>
                            </div>`
                            : `<input type="text" class="form-input" value="${material.lot || ''}" placeholder="LOT/ì‹œë¦¬ì–¼" style="padding:0.25rem">`;
                        
                        tbody.insertAdjacentHTML('beforeend', 
                            `<tr data-row-id="${rowId}" data-serial-tracking="${isSerialTracking}">
                                <td>
                                    <div style="font-weight:500">${material.name}</div>
                                    <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">${spec}</div>
                                </td>
                                <td style="text-align:center" class="as-receive-col">
                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.8125rem">
                                        <input type="checkbox" class="as-receive-check" onchange="toggleAsQtyInput(this, '${rowId}')">
                                        AS
                                    </label>
                                </td>
                                <td class="as-receive-col">
                                    <div style="display:flex;gap:0.5rem;align-items:center">
                                        <div style="flex:1">
                                            <input type="number" class="form-input as-qty-input" value="0" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')" disabled>
                                        </div>
                                        <div style="flex:1">
                                            <input type="number" class="form-input normal-qty-input" value="${material.quantity}" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')">
                                        </div>
                                    </div>
                                </td>
                                <td style="min-width:200px">${serialHtml}</td>
                                <td><button class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
                            </tr>`
                        );
                    });
                } else {
                    alert('í•´ë‹¹ ë°œì£¼ì— ë“±ë¡ëœ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ë§ˆìŠ¤í„° ìì¬ ë°ì´í„°
        const MATERIALS = [
            { code: 'CAM-001', name: 'IPì¹´ë©”ë¼ 2MP', spec: '2MP, IP67', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'CAM-002', name: 'IPì¹´ë©”ë¼ 4MP', spec: '4MP, ì‹¤ë‚´ìš©', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'NVR-016', name: 'NVR 16ì±„ë„', spec: '16CH, H.265', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'NET-024', name: 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', spec: '24í¬íŠ¸, 250W', unit: 'ê°œ', category: 'ë„¤íŠ¸ì›Œí¬', useYn: 'Y', serialTracking: false },
            { code: 'CBL-C6', name: 'UTP ì¼€ì´ë¸” CAT6', spec: '305m/ë°•ìŠ¤', unit: 'ë°•ìŠ¤', category: 'ë„¤íŠ¸ì›Œí¬', useYn: 'Y', serialTracking: false },
            { code: 'ACC-001', name: 'ë¸Œë¼ì¼“', spec: 'ë²”ìš©í˜•, ìŠ¤í‹¸', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'ACC-002', name: 'ì¼€ì´ë¸” íƒ€ì´', spec: '200mm, í°ìƒ‰', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'HDD-4TB', name: 'HDD 4TB', spec: '4TB, 7200RPM', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'OLD-001', name: 'êµ¬í˜• ì¹´ë©”ë¼ ë¸Œë¼ì¼“', spec: 'ë‹¨ì¢…', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'N', serialTracking: false }
        ];
        
        // ìì¬ ìë™ì™„ì„± ê¸°ëŠ¥
        let materialAutocompleteIndex = -1;
        let materialAutocompleteItems = [];
        
        function handleMaterialSearch() {
            const keyword = document.getElementById('materialSearch').value.trim().toLowerCase();
            const dropdown = document.getElementById('materialAutocomplete');
            
            if (!keyword) {
                hideMaterialAutocomplete();
                return;
            }
            
            // ìì¬ ì½”ë“œ, ìì¬ëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰
            const filtered = MATERIALS.filter(m => 
                m.useYn === 'Y' && (
                    m.code.toLowerCase().includes(keyword) ||
                    m.name.toLowerCase().includes(keyword) ||
                    m.category.toLowerCase().includes(keyword)
                )
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);cursor:default">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            materialAutocompleteItems = filtered;
            materialAutocompleteIndex = -1;
            
            dropdown.innerHTML = filtered.map((m, idx) => `
                <div class="autocomplete-item" data-index="${idx}" onclick="selectMaterial(${idx})" onmouseover="highlightMaterial(${idx})">
                    <div class="autocomplete-item-code">${m.code}</div>
                    <div class="autocomplete-item-name">${m.name}</div>
                    <div class="autocomplete-item-info">${m.spec} | ${m.category} | ${m.unit}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function handleMaterialKeydown(event) {
            const dropdown = document.getElementById('materialAutocomplete');
            if (dropdown.style.display === 'none' || materialAutocompleteItems.length === 0) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const keyword = document.getElementById('materialSearch').value.trim();
                    if (keyword) {
                        // ê²€ìƒ‰ì–´ë¡œ ì§ì ‘ ì¶”ê°€ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
                        addMaterialByName(keyword);
                    }
                }
                return;
            }
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                materialAutocompleteIndex = Math.min(materialAutocompleteIndex + 1, materialAutocompleteItems.length - 1);
                highlightMaterial(materialAutocompleteIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                materialAutocompleteIndex = Math.max(materialAutocompleteIndex - 1, -1);
                highlightMaterial(materialAutocompleteIndex);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (materialAutocompleteIndex >= 0 && materialAutocompleteIndex < materialAutocompleteItems.length) {
                    selectMaterial(materialAutocompleteIndex);
                }
            } else if (event.key === 'Escape') {
                hideMaterialAutocomplete();
            }
        }
        
        function handleMaterialFocus() {
            const keyword = document.getElementById('materialSearch').value.trim();
            if (keyword) {
                handleMaterialSearch();
            }
        }
        
        function highlightMaterial(index) {
            const items = document.getElementById('materialAutocomplete').querySelectorAll('.autocomplete-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            materialAutocompleteIndex = index;
        }
        
        function selectMaterial(index) {
            const material = materialAutocompleteItems[index];
            if (!material) return;
            
            addMaterialFromData(material);
            hideMaterialAutocomplete();
        }
        
        function hideMaterialAutocomplete() {
            document.getElementById('materialAutocomplete').style.display = 'none';
            materialAutocompleteIndex = -1;
        }
        
        function addMaterialFromData(material) {
            const tbody = document.getElementById('materialList');
            if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
            
            // ì¤‘ë³µ ì²´í¬
            const existingRows = tbody.querySelectorAll('tr');
            for (let row of existingRows) {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    const nameDiv = nameCell.querySelector('div[style*="font-weight"]');
                    if (nameDiv && nameDiv.textContent.trim() === material.name) {
                        alert('ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì…ë‹ˆë‹¤.');
                        return;
                    }
                }
            }
            
            const spec = material.spec || '-';
            const rowId = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const isSerialTracking = material.serialTracking === true;
            const serialHtml = isSerialTracking 
                ? `<div class="serial-container" data-row-id="${rowId}">
                    <div class="serial-list" data-row-id="${rowId}">
                        <div class="serial-item" style="display:flex;gap:0.25rem;margin-bottom:0.25rem;align-items:center">
                            <input type="text" class="form-input serial-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸" style="padding:0.25rem;flex:1" data-row-id="${rowId}">
                            <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem" onclick="removeSerialInput(this, '${rowId}')" style="display:none">ì‚­ì œ</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm" style="background:var(--primary);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem;width:100%;margin-top:0.25rem" onclick="addSerialInput('${rowId}')">+ ì‹œë¦¬ì–¼ ì¶”ê°€</button>
                </div>`
                : `<input type="text" class="form-input" placeholder="LOT/ì‹œë¦¬ì–¼" style="padding:0.25rem">`;
            
            tbody.insertAdjacentHTML('beforeend', 
                `<tr data-row-id="${rowId}" data-serial-tracking="${isSerialTracking}">
                    <td>
                        <div style="font-weight:500">${material.name}</div>
                        <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">${spec}</div>
                    </td>
                    <td style="text-align:center" class="as-receive-col">
                        <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.8125rem">
                            <input type="checkbox" class="as-receive-check" onchange="toggleAsQtyInput(this, '${rowId}')">
                            AS
                        </label>
                    </td>
                    <td class="as-receive-col">
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <div style="flex:1">
                                <input type="number" class="form-input as-qty-input" value="0" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')" disabled>
                            </div>
                            <div style="flex:1">
                                <input type="number" class="form-input normal-qty-input" value="1" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')">
                            </div>
                        </div>
                    </td>
                    <td style="min-width:200px">${serialHtml}</td>
                    <td><button class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
                </tr>`
            );
            document.getElementById('materialSearch').value = '';
        }
        
        function addMaterialByName(name) {
            if (!name || !name.trim()) return;
            const tbody = document.getElementById('materialList');
            if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
            
            // MATERIALS ë°°ì—´ì—ì„œ ìì¬ ì°¾ê¸°
            const material = MATERIALS.find(m => m.name.toLowerCase().includes(name.toLowerCase()));
            const spec = material ? material.spec : '-';
            const isSerialTracking = material ? (material.serialTracking === true) : false;
            const rowId = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const serialHtml = isSerialTracking 
                ? `<div class="serial-container" data-row-id="${rowId}">
                    <div class="serial-list" data-row-id="${rowId}">
                        <div class="serial-item" style="display:flex;gap:0.25rem;margin-bottom:0.25rem;align-items:center">
                            <input type="text" class="form-input serial-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸" style="padding:0.25rem;flex:1" data-row-id="${rowId}">
                            <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem" onclick="removeSerialInput(this, '${rowId}')" style="display:none">ì‚­ì œ</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm" style="background:var(--primary);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem;width:100%;margin-top:0.25rem" onclick="addSerialInput('${rowId}')">+ ì‹œë¦¬ì–¼ ì¶”ê°€</button>
                </div>`
                : `<input type="text" class="form-input" placeholder="LOT/ì‹œë¦¬ì–¼" style="padding:0.25rem">`;
            
            tbody.insertAdjacentHTML('beforeend', 
                `<tr data-row-id="${rowId}" data-serial-tracking="${isSerialTracking}">
                    <td>
                        <div style="font-weight:500">${name}</div>
                        <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">${spec}</div>
                    </td>
                    <td style="text-align:center" class="as-receive-col">
                        <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.8125rem">
                            <input type="checkbox" class="as-receive-check" onchange="toggleAsQtyInput(this, '${rowId}')">
                            AS
                        </label>
                    </td>
                    <td class="as-receive-col">
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <div style="flex:1">
                                <input type="number" class="form-input as-qty-input" value="0" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')" disabled>
                            </div>
                            <div style="flex:1">
                                <input type="number" class="form-input normal-qty-input" value="1" min="0" style="padding:0.25rem;width:100%" onchange="updateQtyTotal('${rowId}');updateSerialInputs('${rowId}')">
                            </div>
                        </div>
                    </td>
                    <td style="min-width:200px">${serialHtml}</td>
                    <td><button class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
                </tr>`
            );
            document.getElementById('materialSearch').value = '';
        }
        
        function addMaterial() {
            const search = document.getElementById('materialSearch').value.trim();
            if (!search) {
                alert('ìì¬ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
                return;
            }
            // ê²€ìƒ‰ì–´ë¡œ ì§ì ‘ ì¶”ê°€ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
            addMaterialByName(search);
        }
        
        function toggleAsQtyInput(checkbox, rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const asQtyInput = row.querySelector('.as-qty-input');
            if (!asQtyInput) return;
            
            if (checkbox.checked) {
                asQtyInput.disabled = false;
                asQtyInput.value = asQtyInput.value || '0';
            } else {
                asQtyInput.disabled = true;
                asQtyInput.value = '0';
            }
            updateQtyTotal(rowId);
        }
        
        function updateQtyTotal(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const asQtyInput = row.querySelector('.as-qty-input');
            const normalQtyInput = row.querySelector('.normal-qty-input');
            const totalSpan = row.querySelector(`.qty-total[data-row-id="${rowId}"]`);
            
            if (!asQtyInput || !normalQtyInput || !totalSpan) return;
            
            const asQty = parseInt(asQtyInput.value) || 0;
            const normalQty = parseInt(normalQtyInput.value) || 0;
            const total = asQty + normalQty;
            
            totalSpan.textContent = total;
        }
        
        function addSerialInput(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const serialList = row.querySelector(`.serial-list[data-row-id="${rowId}"]`);
            if (!serialList) return;
            
            const serialItem = document.createElement('div');
            serialItem.className = 'serial-item';
            serialItem.style.cssText = 'display:flex;gap:0.25rem;margin-bottom:0.25rem;align-items:center';
            serialItem.innerHTML = `
                <input type="text" class="form-input serial-input" placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸" style="padding:0.25rem;flex:1" data-row-id="${rowId}">
                <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.25rem 0.5rem;font-size:0.75rem" onclick="removeSerialInput(this, '${rowId}')">ì‚­ì œ</button>
            `;
            serialList.appendChild(serialItem);
            
            // ì²« ë²ˆì§¸ í•­ëª©ì´ ì•„ë‹Œ ê²½ìš° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            updateSerialDeleteButtons(rowId);
        }
        
        function removeSerialInput(button, rowId) {
            const serialItem = button.closest('.serial-item');
            if (serialItem) {
                serialItem.remove();
                updateSerialDeleteButtons(rowId);
            }
        }
        
        function updateSerialDeleteButtons(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const serialItems = row.querySelectorAll('.serial-item');
            serialItems.forEach((item, index) => {
                const deleteBtn = item.querySelector('button');
                if (deleteBtn) {
                    // ì²« ë²ˆì§¸ í•­ëª©ì´ ì•„ë‹ˆë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                    deleteBtn.style.display = serialItems.length > 1 ? 'block' : 'none';
                }
            });
        }
        
        function updateSerialInputs(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const isSerialTracking = row.getAttribute('data-serial-tracking') === 'true';
            if (!isSerialTracking) return;
            
            const asQtyInput = row.querySelector('.as-qty-input');
            const normalQtyInput = row.querySelector('.normal-qty-input');
            const serialList = row.querySelector(`.serial-list[data-row-id="${rowId}"]`);
            
            if (!asQtyInput || !normalQtyInput || !serialList) return;
            
            const asQty = parseInt(asQtyInput.value) || 0;
            const normalQty = parseInt(normalQtyInput.value) || 0;
            const totalQty = asQty + normalQty;
            
            const currentSerialCount = serialList.querySelectorAll('.serial-item').length;
            
            // ìˆ˜ëŸ‰ë³´ë‹¤ ì‹œë¦¬ì–¼ ì…ë ¥ í•„ë“œê°€ ì ìœ¼ë©´ ì¶”ê°€
            if (currentSerialCount < totalQty) {
                const addCount = totalQty - currentSerialCount;
                for (let i = 0; i < addCount; i++) {
                    addSerialInput(rowId);
                }
            }
            // ìˆ˜ëŸ‰ë³´ë‹¤ ì‹œë¦¬ì–¼ ì…ë ¥ í•„ë“œê°€ ë§ìœ¼ë©´ ì œê±° (ë§ˆì§€ë§‰ë¶€í„°)
            else if (currentSerialCount > totalQty) {
                const removeCount = currentSerialCount - totalQty;
                const serialItems = serialList.querySelectorAll('.serial-item');
                for (let i = 0; i < removeCount && serialItems.length > 1; i++) {
                    const lastItem = serialItems[serialItems.length - 1 - i];
                    if (lastItem) {
                        lastItem.remove();
                    }
                }
                updateSerialDeleteButtons(rowId);
            }
        }
        
        function submitReceiving() {
            if (document.getElementById('materialList').querySelector('td[colspan]')) return alert('ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”');
            const type = document.querySelector('input[name="receiveType"]:checked').value;
            
            if (type === 'return') {
                if (!document.getElementById('selectedCompany').value || !document.getElementById('selectedSite').value) return alert('ë³¸ì‚¬/í˜„ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                if (!document.getElementById('returnReason').value) return alert('íšŒìˆ˜ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                alert('âœ… í˜„ì¥ íšŒìˆ˜ ì…ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nì…ê³  ë²ˆí˜¸: IN-2024-051');
            } else {
                // êµ¬ë§¤ ì…ê³ , ê¸°íƒ€ ì…ê³ ëŠ” ë°œì£¼ ì„ íƒì‚¬í•­
                const typeText = type === 'purchase' ? 'êµ¬ë§¤' : 'ê¸°íƒ€';
                alert(`âœ… ${typeText} ì…ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nì…ê³  ë²ˆí˜¸: IN-2024-051`);
            }
            
            closeModal('addModal');
        }
        
        function completeInspection() {
            alert('âœ… ê²€ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n- ì •ìƒ ì…ê³ : 44ê°œ\n- ë¶ˆëŸ‰ ë°˜í’ˆ: 1ê°œ');
            closeModal('inspectionModal');
        }
        
        // ì´ˆê¸° ìƒíƒœ(êµ¬ë§¤ ì…ê³ )ì—ì„œ AS ì…ê³  ì—¬ë¶€ ì»¬ëŸ¼ ìˆ¨ê¹€ ì ìš©
        setAsReceiveColumnVisibility(false);
        
        // ì‹œë¦¬ì–¼ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
        let currentSerialRowId = null;
        let currentSerialMaterialCode = null;
        let currentSerialMaterialName = null;
        let requiredSerialQty = 0;
        
        // í˜„ì¥ íšŒìˆ˜ìš© ì‹œë¦¬ì–¼ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
        function openSerialModalForReturn(rowId, materialCode, materialName, qty) {
            currentSerialRowId = rowId;
            currentSerialMaterialCode = materialCode;
            currentSerialMaterialName = materialName;
            requiredSerialQty = qty;
            
            document.getElementById('serialMaterialName').textContent = materialName;
            document.getElementById('serialQty').textContent = qty;
            document.getElementById('requiredCount').textContent = qty;
            
            updateSerialCount();
            document.getElementById('serialModal').classList.add('active');
        }
        
        // ì „ì²´ ì‹œë¦¬ì–¼ ì„ íƒ
        function selectAllSerials() {
            const checkboxes = document.querySelectorAll('#serialModal .serial-check');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach((cb, index) => {
                cb.checked = !allChecked && index < requiredSerialQty;
            });
            
            updateSerialCount();
        }
        
        // ì„ íƒëœ ì‹œë¦¬ì–¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateSerialCount() {
            const checked = document.querySelectorAll('#serialModal .serial-check:checked').length;
            document.getElementById('selectedCount').textContent = checked;
            
            const statusEl = document.getElementById('serialMatchStatus');
            if (checked === requiredSerialQty) {
                statusEl.innerHTML = '<span style="color:var(--success);font-weight:600">âœ… ì¼ì¹˜</span>';
            } else if (checked < requiredSerialQty) {
                statusEl.innerHTML = `<span style="color:var(--danger);font-weight:600">âŒ ${requiredSerialQty - checked}ê°œ ë¶€ì¡±</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:var(--warning);font-weight:600">âš ï¸ ${checked - requiredSerialQty}ê°œ ì´ˆê³¼</span>`;
            }
        }
        
        // ì‹œë¦¬ì–¼ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('serial-check') && e.target.closest('#serialModal')) {
                updateSerialCount();
            }
        });
        
        // ì‹œë¦¬ì–¼ ì„ íƒ í™•ì¸
        function confirmSerialSelection() {
            if (!currentSerialRowId) return;
            
            const checked = document.querySelectorAll('#serialModal .serial-check:checked').length;
            
            // ìˆ˜ëŸ‰ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ë„ ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì§„í–‰
            if (checked !== requiredSerialQty) {
                if (!confirm(`ì…ê³  ìˆ˜ëŸ‰(${requiredSerialQty}ê°œ)ê³¼ ì„ íƒí•œ ì‹œë¦¬ì–¼ ìˆ˜(${checked}ê°œ)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }
            
            // ì„ íƒëœ ì‹œë¦¬ì–¼ ë²ˆí˜¸ ìˆ˜ì§‘
            const selectedSerials = [];
            document.querySelectorAll('#serialModal .serial-check:checked').forEach(checkbox => {
                const row = checkbox.closest('tr');
                const serialNo = row.querySelector('td:nth-child(2) strong').textContent;
                selectedSerials.push(serialNo);
            });
            
            // ì„ íƒëœ ì‹œë¦¬ì–¼ì„ í–‰ì— í‘œì‹œ
            const row = document.querySelector(`tr[data-row-id="${currentSerialRowId}"]`);
            if (row) {
                const selectedSerialList = row.querySelector(`.selected-serial-list[data-row-id="${currentSerialRowId}"]`);
                if (selectedSerialList) {
                    if (selectedSerials.length > 0) {
                        selectedSerialList.innerHTML = selectedSerials.map(serial => 
                            `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.25rem;background:var(--gray-50);border-radius:4px;margin-bottom:0.25rem">
                                <span><strong>${serial}</strong></span>
                                <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;padding:0.125rem 0.375rem;font-size:0.75rem" onclick="removeSelectedSerial('${currentSerialRowId}', '${serial}')">ì‚­ì œ</button>
                            </div>`
                        ).join('');
                    } else {
                        selectedSerialList.innerHTML = 'ì„ íƒëœ ì‹œë¦¬ì–¼ì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }
            }
            
            alert('âœ… ì‹œë¦¬ì–¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeModal('serialModal');
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            currentSerialRowId = null;
            currentSerialMaterialCode = null;
            currentSerialMaterialName = null;
            requiredSerialQty = 0;
        }
        
        // ì„ íƒëœ ì‹œë¦¬ì–¼ ì‚­ì œ
        function removeSelectedSerial(rowId, serialNo) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const selectedSerialList = row.querySelector(`.selected-serial-list[data-row-id="${rowId}"]`);
            if (!selectedSerialList) return;
            
            // ì‹œë¦¬ì–¼ ë²ˆí˜¸ê°€ í¬í•¨ëœ div ì œê±°
            const serialDivs = selectedSerialList.querySelectorAll('div');
            serialDivs.forEach(div => {
                if (div.textContent.includes(serialNo)) {
                    div.remove();
                }
            });
            
            // ì‹œë¦¬ì–¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
            if (selectedSerialList.querySelectorAll('div').length === 0) {
                selectedSerialList.innerHTML = 'ì„ íƒëœ ì‹œë¦¬ì–¼ì´ ì—†ìŠµë‹ˆë‹¤.';
            }
        }
        
        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); });
    </script>
</body>
</html>
