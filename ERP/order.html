<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œì£¼ ê´€ë¦¬ - ê±´ì„¤ ìì¬ ERP</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .draggable-row {
            cursor: move;
            transition: background-color 0.2s;
        }
        .draggable-row:hover {
            background-color: var(--gray-50);
        }
        .draggable-row.drag-over {
            border-top: 2px solid var(--primary);
            background-color: var(--gray-50);
        }
        .draggable-row:active {
            cursor: grabbing;
        }
        .modal-content.xl {
            width: 90vw;
            max-width: 1200px;
            max-height: 90vh;
        }
        .modal-content.fullscreen {
            width: 95vw !important;
            height: 95vh !important;
            max-width: 95vw !important;
            max-height: 95vh !important;
            margin: 2.5vh auto;
        }
        .modal-content.fullscreen .modal-body {
            max-height: calc(95vh - 140px);
            overflow-y: auto;
        }
        #fullscreenToggle:hover {
            background: var(--gray-200) !important;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s;
        }
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--gray-50);
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item-code {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }
        .autocomplete-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .autocomplete-item-info {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }
        @media (max-width: 1200px) {
            .contract-select-grid {
                grid-template-columns: 1fr 2fr !important;
            }
            .contract-select-grid > div:nth-child(n+3) {
                grid-column: span 2;
            }
        }
        @media (max-width: 768px) {
            .contract-select-grid {
                grid-template-columns: 1fr !important;
            }
            .contract-select-grid > div:nth-child(n+3) {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="dashboard.html">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
        <a href="contract.html">ğŸ“‹ ê²¬ì </a>
        <a href="inventory.html">ğŸ“¦ ì¬ê³ </a>
        <a href="order.html" class="active">ğŸ“ ë°œì£¼</a>
        <a href="receiving.html">ğŸ“¥ ì…ê³ </a>
        <a href="shipment.html">ğŸšš ì¶œê³ </a>
        <!-- <a href="purchase.html">ğŸ›’ êµ¬ë§¤</a> -->
        <a href="as.html">ğŸ”§ AS</a>
        <a href="materials.html">ğŸ“ ìì¬ì •ë³´</a>
        <a href="project.html">ğŸ“Š í˜„ì¥ í†µí•© í˜„í™©</a>
    </nav>
    
    <main class="main">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">ë°œì£¼ ëª©ë¡</button>
            <button class="tab" onclick="switchTab('register')">ë°œì£¼ ë“±ë¡</button>
        </div>
        
        <!-- ë°œì£¼ ëª©ë¡ íƒ­ -->
        <div id="listTab" class="tab-content">
            <div class="search-box">
                <div class="search-row">
                    <select class="filter-select"><option>ìƒíƒœ ì „ì²´</option><option>ì¶œê³ ëŒ€ê¸°</option><option>ì¶œê³ ì™„ë£Œ</option></select>
                    <select class="filter-select"><option>ê²¬ì  ì „ì²´</option><option>CT-2024-001</option><option>CT-2024-002</option></select>
                    <div style="display:flex;gap:0.5rem;flex:1;min-width:200px">
                        <input type="text" class="search-input" placeholder="ë°œì£¼ë²ˆí˜¸/ê²¬ì ëª… ê²€ìƒ‰..." style="flex:1">
                        <button class="btn btn-primary" onclick="handleSearch()">ê²€ìƒ‰</button>
                    </div>
                    <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="summary-box" style="display:flex;justify-content:space-between;align-items:center">
                <div style="display:flex;flex-wrap:wrap;gap:1.5rem">
                    <span class="summary-item">ì „ì²´: <strong>28ê±´</strong></span>
                    <span class="summary-item">ì¶œê³ ëŒ€ê¸°: <strong>5ê±´</strong></span>
                    <span class="summary-item">ì¶œê³ ì™„ë£Œ: <strong>23ê±´</strong></span>
                </div>
                <button class="btn btn-primary" onclick="switchTab('register')" style="white-space:nowrap">+ ìƒˆ ë°œì£¼ ë“±ë¡</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ë°œì£¼ ë²ˆí˜¸</th>
                            <th>ë³¸ì‚¬</th>
                            <th>í˜„ì¥</th>
                            <th>ê²¬ì ëª…</th>
                            <th>ë°œì£¼ì¼</th>
                            <th>ìì¬ ìˆ˜</th>
                            <th>ì´ ìˆ˜ëŸ‰</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="showDetail('IT260115-01')" style="cursor:pointer">
                            <td><strong>IT260115-01</strong></td>
                            <td>ê°•ë‚¨ê±´ì„¤</td>
                            <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                            <td>
                                ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜
                                <span class="status-badge status-warning" style="margin-left:4px">ê²¬ì ë³€ê²½</span>
                            </td>
                            <td>2024-01-15</td>
                            <td>5ì¢…</td>
                            <td>120ê°œ</td>
                            <td><span class="status-badge status-active">ì¶œê³ ì™„ë£Œ</span></td>
                            <td></td>
                        </tr>
                        <tr onclick="showDetail('IT260118-01')" style="cursor:pointer">
                            <td><strong>IT260118-01</strong></td>
                            <td>íŒêµê±´ì„¤</td>
                            <td>íŒêµ ê³µì¥</td>
                            <td>
                                íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜
                                <span class="status-badge status-warning" style="margin-left:4px">ê²¬ì ë³€ê²½</span>
                            </td>
                            <td>2024-01-18</td>
                            <td>8ì¢…</td>
                            <td>200ê°œ</td>
                            <td><span class="status-badge status-active">ì¶œê³ ì™„ë£Œ</span></td>
                            <td></td>
                        </tr>
                        <tr onclick="showDetail('IT260125-01')" style="cursor:pointer">
                            <td><strong>IT260125-01</strong></td>
                            <td>ì¸ì²œê±´ì„¤</td>
                            <td>ì¸ì²œ ë¬¼ë¥˜ì„¼í„°</td>
                            <td>ì¸ì²œ ë¬¼ë¥˜ì„¼í„° í†µí•© ì„¤ì¹˜</td>
                            <td>2024-01-25</td>
                            <td>12ì¢…</td>
                            <td>150ê°œ</td>
                            <td><span class="status-badge status-pending">ì¶œê³ ëŒ€ê¸°</span></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ë°œì£¼ ë“±ë¡ íƒ­ -->
        <div id="registerTab" class="tab-content" style="display:none">
            <div class="card" style="margin-bottom:0">
                <div class="card-header" style="padding:0.5rem 1rem"><span class="card-title" style="font-size:0.9375rem">ğŸ“ ë°œì£¼ ê¸°ë³¸ì •ë³´</span></div>
                <div class="card-body" style="padding:0.75rem 1rem">
                    <!-- í•œ ì¤„ ë°°ì¹˜: ê²€ìƒ‰(2) + í˜„ì¥/ê²¬ì  ì„ íƒ + ìµœê·¼ ìˆ˜ì£¼ ê±´(1) -->
                    <div class="contract-select-grid" style="display:grid;grid-template-columns:1.5fr 1.2fr 1.2fr 1fr;gap:1rem;align-items:start">
                        <!-- ì¢Œì¸¡: í†µí•© ê²€ìƒ‰ -->
                        <div>
                            <label class="form-label" style="margin-bottom:0.375rem">ğŸ” ê²€ìƒ‰</label>
                            <div style="position:relative">
                                <input type="text" class="form-input" id="regContractSearch" placeholder="ë³¸ì‚¬, í˜„ì¥ ë˜ëŠ” ê²¬ì ëª… ê²€ìƒ‰..." oninput="handleContractSearch()" onfocus="handleContractSearch()" onkeydown="handleContractSearchKeydown(event)" onblur="setTimeout(() => hideContractSearchResults(), 200)">
                                <div id="contractSearchResults" class="autocomplete-dropdown" style="display:none"></div>
                            </div>
                        </div>
                        
                        <!-- ì¤‘ì•™: í˜„ì¥ ì„ íƒ -->
                        <div class="form-group" style="margin-bottom:0">
                            <label class="form-label">í˜„ì¥ ì„ íƒ *</label>
                            <select class="form-select" id="regSiteSelect" onchange="loadRegisterSite()">
                                <option value="">í˜„ì¥ ì„ íƒ</option>
                                <option value="ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”">ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” (ê°•ë‚¨ê±´ì„¤)</option>
                                <option value="ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥">íŒêµ ê³µì¥ (ì‚¼ì„±ë¬¼ì‚°)</option>
                                <option value="ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°">ì¸ì²œ ë¬¼ë¥˜ì„¼í„° (ì¸ì²œê±´ì„¤)</option>
                            </select>
                        </div>
                        
                        <!-- ì¤‘ì•™: ê²¬ì  ì„ íƒ -->
                        <div class="form-group" style="margin-bottom:0">
                            <label class="form-label">ê²¬ì  ì„ íƒ *</label>
                            <select class="form-select" id="regContractSelect" onchange="loadRegisterContract()" disabled>
                                <option value="">í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            </select>
                        </div>
                        
                        <!-- ìš°ì¸¡: ìµœê·¼ ìˆ˜ì£¼ ê±´ -->
                        <div>
                            <label class="form-label" style="margin-bottom:0.375rem">ğŸ“‹ ìµœê·¼ ìˆ˜ì£¼ ê±´</label>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openRecentContractsModal()" style="width:100%;font-size:0.8125rem;padding:0.5rem 0.75rem;white-space:nowrap;text-align:center">
                                ìµœê·¼ ìˆ˜ì£¼ ê±´ ì„ íƒ
                            </button>
                        </div>
                    </div>
                    <div class="info-box highlight" id="regContractInfo" style="display:none;margin-top:0.5rem;padding:0.5rem 0.75rem;font-size:0.8125rem">
                        <div style="font-weight:600;margin-bottom:0.25rem">ğŸ“‹ ê²¬ì  ì •ë³´</div>
                        <div style="margin-bottom:0.5rem">í˜„ì¥: <strong>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</strong> | ë°œì£¼ì²˜: <strong>ê°•ë‚¨ê±´ì„¤</strong> | ê¸ˆì•¡: <strong style="color:var(--primary)">150,000,000ì›</strong> | ì†Œìœ êµ¬ë¶„: <strong>íŒë§¤</strong> | í’ˆì§ˆ: <strong>ì‹ í’ˆ</strong></div>
                        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--gray-200)">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="viewContractDocument()" style="font-size:0.8125rem;padding:0.375rem 0.75rem">
                                ğŸ“„ ê²¬ì ì„œ ë³´ê¸°
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="downloadContractDocument()" style="font-size:0.8125rem;padding:0.375rem 0.75rem">
                                â¬‡ï¸ ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top:0.75rem">
                <div class="card-header"><span class="card-title">ğŸ“¦ ë°œì£¼ ìì¬ ì„ íƒ</span></div>
                <div class="card-body">
                    <div style="display:flex;gap:1rem;align-items:stretch;min-height:620px">
                        <!-- ì¢Œì¸¡: ìì¬ ê²€ìƒ‰/ì¶”ê°€ -->
                        <div style="flex:0 0 40%;min-width:320px;border:1px solid var(--gray-200);border-radius:8px;overflow:hidden;background:#fff">
                            <div style="padding:0.75rem;background:var(--gray-50);border-bottom:1px solid var(--gray-200);display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
                                <select class="filter-select" id="regMaterialCategory" onchange="renderMaterialSearchResults()" style="min-width:130px">
                                    <option value="">ì¹´í…Œê³ ë¦¬ ì „ì²´</option>
                                    <option value="CCTV">CCTV</option>
                                    <option value="ë„¤íŠ¸ì›Œí¬">ë„¤íŠ¸ì›Œí¬</option>
                                    <option value="ë¶€ìì¬">ë¶€ìì¬</option>
                                </select>
                                <select class="filter-select" id="regMaterialSerial" onchange="renderMaterialSearchResults()" style="min-width:140px">
                                    <option value="false" selected>ì‹œë¦¬ì–¼ ë¯¸ëŒ€ìƒ</option>
                                    <option value="true">ì‹œë¦¬ì–¼ ëŒ€ìƒ</option>
                                </select>
                                <input type="text" id="regMaterialKeyword" class="form-input" placeholder="ğŸ” ìì¬ì½”ë“œ/ìì¬ëª…/ê·œê²© ê²€ìƒ‰..." style="flex:1;min-width:160px" oninput="renderMaterialSearchResults()">
                            </div>
                            <div class="table-container" style="box-shadow:none;margin:0;min-height:560px;max-height:560px;overflow:auto">
                                <table style="margin:0">
                                    <thead>
                                        <tr>
                                            <th style="width:100px">ì½”ë“œ</th>
                                            <th>ìì¬ëª… / ê·œê²©</th>
                                            <th style="width:60px">ë‹¨ìœ„</th>
                                            <th style="width:70px">ì¶”ê°€</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regMaterialResultBody">
                                        <tr><td colspan="4" style="text-align:center;color:var(--gray-500);padding:1.5rem">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í•„í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ìš°ì¸¡: ë°œì£¼ í’ˆëª© í¸ì§‘ -->
                        <div style="flex:0 0 60%;border:1px solid var(--gray-200);border-radius:8px;overflow:hidden;background:#fff">
                            <div style="padding:0.75rem;background:var(--gray-50);border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center;gap:0.75rem">
                                <div style="display:flex;gap:0.75rem;align-items:center">
                                    <div style="font-weight:600">ğŸ“‹ ë°œì£¼ í’ˆëª©</div>
                                    <div style="display:flex;gap:0.5rem;align-items:center;font-size:0.8125rem;color:var(--gray-500)">
                                        <span>í’ˆëª© ìˆ˜: <strong id="regItemCount">0</strong></span>
                                        <span style="width:1px;height:12px;background:var(--gray-200)"></span>
                                        <span>ì´ ìˆ˜ëŸ‰: <strong id="regTotalQty">0</strong></span>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="openSetSelectModal()" style="white-space:nowrap">ğŸ“¦ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            </div>
                            <!-- ë¬¶ìŒ ìˆ˜ëŸ‰ ê³„ì‚° ì˜ì—­ -->
                            <div style="padding:0.5rem 0.75rem;border-bottom:1px solid var(--gray-200);display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center;font-size:0.8125rem;color:var(--gray-600)">
                                <span style="font-weight:600">ğŸ”— ë¬¶ìŒ ìˆ˜ëŸ‰ ê³„ì‚°</span>
                                <input type="text" id="bundleKeyInput" class="form-input" placeholder="ì˜ˆ: CCTV-1ì‹" style="width:130px;padding:0.35rem;font-size:0.8125rem">
                                <span>Ã—</span>
                                <input type="number" id="bundleCountInput" class="form-input" min="1" value="1" style="width:80px;padding:0.35rem;font-size:0.8125rem">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyBundleQuantity()">ê³„ì‚°</button>
                                <span style="color:var(--gray-400)">â€» ë¬¶ìŒ IDê°€ ê°™ì€ í–‰ë“¤ì˜ [1ì‹ ê¸°ì¤€ ìˆ˜ëŸ‰] Ã— ì‹ ìˆ˜ëŸ‰ìœ¼ë¡œ ë°œì£¼ ìˆ˜ëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</span>
                            </div>
                            <div class="table-container" style="box-shadow:none;margin:0;min-height:560px;max-height:560px;overflow:auto">
                                <table style="margin:0">
                                    <thead>
                                        <tr>
                                            <th style="width:30px"></th>
                                            <th>ìì¬ëª… / ê·œê²©</th>
                                            <th style="width:120px">ë¬¶ìŒ ID</th>
                                            <th style="width:110px">ë°œì£¼ ìˆ˜ëŸ‰</th>
                                            <th style="width:70px">ë‹¨ìœ„</th>
                                            <th style="width:100px">í’ˆì§ˆ</th>
                                            <th style="width:60px">ì‚­ì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regSelectedBody">
                                        <tr><td colspan="7" style="text-align:center;color:var(--gray-500);padding:2rem">ì¢Œì¸¡ì—ì„œ ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--gray-200)">
                        <label class="form-label">ë¹„ê³ </label>
                        <textarea class="form-textarea" id="regOrderNote" placeholder="ë°œì£¼ ê´€ë ¨ íŠ¹ì´ì‚¬í•­" rows="2"></textarea>
                    </div>
                    
                    <!-- ì•¡ì…˜ ë²„íŠ¼ (ì¶œê³ ë“±ë¡ê³¼ ë™ì¼í•˜ê²Œ ë°•ìŠ¤ ë°–) -->
                    <div style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;flex-wrap:wrap">
                        <button class="btn btn-secondary" onclick="resetRegisterForm()">ì´ˆê¸°í™”</button>
                        <button class="btn btn-secondary" onclick="mockTempSave()">ì„ì‹œì €ì¥</button>
                        <button class="btn btn-success" onclick="submitRegisterOrder()">ë“±ë¡</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- íƒ­ ì´ë™ ì‹œ ì‘ì„±ì¤‘ ì•ˆë‚´(ëª©ì—…) -->
    <div class="modal" id="leaveConfirmModal">
        <div class="modal-content" style="max-width:420px">
            <div class="modal-header">
                <h2 class="modal-title">ì‘ì„± ì¤‘ì…ë‹ˆë‹¤.</h2>
                <button class="close-btn" onclick="closeLeaveConfirm()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="font-size:0.875rem;color:var(--gray-600);line-height:1.5">
                    ë°œì£¼ ë“±ë¡ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                    ì´ë™í•˜ê¸° ì „ì— ì„ì‹œì €ì¥ì„ í•˜ê±°ë‚˜, ê·¸ëƒ¥ ë‚˜ê°€ê¸°ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="mockTempSave()">ì„ì‹œì €ì¥</button>
                <button class="btn btn-danger" onclick="leaveWithoutSaving()">ê·¸ëƒ¥ ë‚˜ê°€ê¸°</button>
                <button class="btn btn-primary" onclick="closeLeaveConfirm()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ë°œì£¼ ìƒì„¸ - IT260115-01</h2>
                <button class="close-btn" onclick="closeDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-row"><span class="info-label">ë°œì£¼ ë²ˆí˜¸</span><strong>IT260115-01</strong></div>
                    <div class="info-row">
                        <span class="info-label">ê²¬ì </span>
                        <span>
                            CT-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜
                            <span class="status-badge status-warning" style="margin-left:4px">ê²¬ì ë³€ê²½</span>
                        </span>
                    </div>
                    <div class="info-row"><span class="info-label">ë³¸ì‚¬</span><span>ê°•ë‚¨ê±´ì„¤</span></div>
                    <div class="info-row"><span class="info-label">í˜„ì¥</span><span>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</span></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼ì¼</span><span>2024-01-15</span></div>
                    <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="status-badge status-active">ì¶œê³ ì™„ë£Œ</span></div>
                </div>
                <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">ğŸ“¦ ë°œì£¼ ìì¬</div>
                <table><thead><tr><th>ìì¬ëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ìœ„</th></tr></thead>
                <tbody>
                    <tr><td>IPì¹´ë©”ë¼ 2MP</td><td>50</td><td>ê°œ</td></tr>
                    <tr><td>NVR 16ì±„ë„</td><td>10</td><td>ê°œ</td></tr>
                    <tr><td>UTP ì¼€ì´ë¸”</td><td>30</td><td>ë°•ìŠ¤</td></tr>
                </tbody></table>
                <div style="font-weight:600;margin:1.25rem 0 0.5rem;font-size:0.875rem">ğŸ“‹ ìˆ˜ì • ì´ë ¥</div>
                <div class="table-container" style="box-shadow:none;margin:0">
                    <table>
                        <thead><tr><th style="width:140px">ìˆ˜ì •ì¼ì‹œ</th><th style="width:80px">ìˆ˜ì •ì</th><th>ìˆ˜ì • ì‚¬ìœ </th></tr></thead>
                        <tbody id="detailOrderHistory">
                            <tr><td style="font-size:0.8125rem">2024-01-20 14:30</td><td>ê¹€ë°œì£¼</td><td style="font-size:0.875rem">UTP ì¼€ì´ë¸” ìˆ˜ëŸ‰ 20ë°•ìŠ¤ì—ì„œ 30ë°•ìŠ¤ë¡œ ì¦ëŸ‰ ìš”ì²­ ë°˜ì˜</td></tr>
                            <tr><td style="font-size:0.8125rem">2024-01-18 09:15</td><td>ì´ë‹´ë‹¹</td><td style="font-size:0.875rem">ê²¬ì  ë³€ê²½ì— ë”°ë¥¸ ìì¬ êµ¬ì„± ìˆ˜ì •</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="detailOrderHistoryEmpty" style="display:none;text-align:center;padding:1.5rem;color:var(--gray-500);font-size:0.875rem">ìˆ˜ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetail()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="closeDetail(); openEditOrderModal(currentOrderNo)">ìˆ˜ì •</button>
            </div>
        </div>
    </div>
    
    <!-- ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="editOrderModal">
        <div class="modal-content xl" id="editOrderModalContent">
            <div class="modal-header">
                <h2 class="modal-title">ë°œì£¼ ìˆ˜ì • - <span id="editOrderNo">IT260115-01</span></h2>
                <div style="display:flex;gap:0.5rem;align-items:center">
                    <button class="btn btn-sm" id="fullscreenToggle" onclick="toggleFullscreenModal()" style="background:var(--gray-100);border:1px solid var(--gray-300);padding:0.25rem 0.5rem;font-size:1rem" title="ì „ì²´ í™”ë©´">â›¶</button>
                    <button class="close-btn" onclick="closeEditOrderModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ë°œì£¼ ë²ˆí˜¸</label>
                        <input type="text" class="form-input" id="editOrderNumber" value="IT260115-01" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ê²¬ì  *</label>
                        <select class="form-select" id="editContractSelect" onchange="loadEditContract()" disabled>
                            <option value="1" selected>CT-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜</option>
                            <option value="2">CT-2024-002 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜</option>
                        </select>
                    </div>
                </div>
                <div class="info-box highlight" id="editContractInfo">
                    <div style="font-weight:600;margin-bottom:0.5rem">ğŸ“‹ ê²¬ì  ì •ë³´</div>
                    <div style="font-size:0.875rem;margin-bottom:0.375rem">ë³¸ì‚¬: <strong>ê°•ë‚¨ê±´ì„¤</strong> | í˜„ì¥: <strong>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</strong> | ê¸ˆì•¡: <strong style="color:var(--primary)">150,000,000ì›</strong></div>
                    <div style="font-size:0.875rem">ì†Œìœ êµ¬ë¶„: <strong>íŒë§¤</strong> | í’ˆì§ˆ: <strong>ì‹ í’ˆ</strong></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ë°œì£¼ ìì¬ *</label>
                    <div style="border:1px solid var(--gray-200);border-radius:6px;overflow:hidden;position:relative">
                        <div style="padding:0.75rem;background:var(--gray-50);display:flex;gap:0.5rem">
                            <div style="flex:1;position:relative">
                                <input type="text" id="editMaterialSearch" class="form-input" placeholder="ìì¬ ì½”ë“œ, ìì¬ëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..." style="width:100%" autocomplete="off" oninput="handleEditMaterialSearch()" onkeydown="handleEditMaterialKeydown(event)" onfocus="handleEditMaterialFocus()" onblur="setTimeout(() => hideEditMaterialAutocomplete(), 200)">
                                <div id="editMaterialAutocomplete" class="autocomplete-dropdown" style="display:none"></div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openSetSelectModal()">ì„¸íŠ¸ ì„ íƒ</button>
                        </div>
                        <table style="margin:0">
                            <thead><tr><th style="width:30px"></th><th style="width:100px">ìì¬ ì½”ë“œ</th><th>ìì¬ëª…</th><th style="width:150px">ê·œê²©</th><th style="width:100px">ìˆ˜ëŸ‰</th><th style="width:80px">ë‹¨ìœ„</th><th style="width:100px">í’ˆì§ˆ</th><th style="width:60px">ì‚­ì œ</th></tr></thead>
                            <tbody id="editMaterialList">
                                <tr draggable="true" class="draggable-row"><td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td><td><strong>CAM-001</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>2MP, IP67</td><td><input type="number" class="form-input" value="50" min="1" style="padding:0.25rem"></td><td>ê°œ</td><td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td><td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest('tr').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td></tr>
                                <tr draggable="true" class="draggable-row"><td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td><td><strong>NVR-016</strong></td><td>NVR 16ì±„ë„</td><td>16CH, H.265</td><td><input type="number" class="form-input" value="10" min="1" style="padding:0.25rem"></td><td>ê°œ</td><td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td><td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest('tr').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td></tr>
                                <tr draggable="true" class="draggable-row"><td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td><td><strong>CBL-C6</strong></td><td>UTP ì¼€ì´ë¸”</td><td>CAT6, 305m</td><td><input type="number" class="form-input" value="30" min="1" style="padding:0.25rem"></td><td>ë°•ìŠ¤</td><td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td><td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest('tr').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ìˆ˜ì • ì‚¬ìœ  *</label>
                    <textarea class="form-textarea" id="editOrderReason" placeholder="ìˆ˜ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" rows="2" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ê³ </label>
                    <textarea class="form-textarea" id="editOrderNote" placeholder="ë°œì£¼ ê´€ë ¨ íŠ¹ì´ì‚¬í•­" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditOrderModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitEditOrder()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- ê²¬ì ì„œ ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal" id="contractViewModal">
        <div class="modal-content" style="max-width:fit-content;max-height:90vh;width:auto">
            <div class="modal-header">
                <h2 class="modal-title">ê²¬ì ì„œ ë³´ê¸° - <span id="contractViewNo">-</span></h2>
                <button class="close-btn" onclick="closeContractViewModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:1rem;overflow:auto">
                <img src="quote.png" alt="ê²¬ì ì„œ" id="contractViewImage" style="max-width:100%;height:auto;border:1px solid var(--gray-300);display:block">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeContractViewModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ìµœê·¼ ìˆ˜ì£¼ ê±´ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="recentContractsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“‹ ìµœê·¼ ìˆ˜ì£¼ ê±´ ì„ íƒ</h2>
                <button class="close-btn" onclick="closeModal('recentContractsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;flex-direction:column;gap:0.5rem">
                    <button type="button" class="btn btn-secondary" onclick="selectRecentContractFromModal('1')" style="font-size:0.875rem;padding:0.75rem;text-align:left;justify-content:flex-start">
                        <div style="font-weight:600;margin-bottom:0.25rem">CT-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)">ê°•ë‚¨ê±´ì„¤ > ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="selectRecentContractFromModal('2')" style="font-size:0.875rem;padding:0.75rem;text-align:left;justify-content:flex-start">
                        <div style="font-weight:600;margin-bottom:0.25rem">CT-2024-002 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)">ì‚¼ì„±ë¬¼ì‚° > íŒêµ ê³µì¥</div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('recentContractsModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="setSelectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ìì¬ ì„¸íŠ¸ ì„ íƒ</h2>
                <button class="close-btn" onclick="closeSetSelectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;flex-direction:column;gap:0.75rem">
                    <label style="padding:1rem;border:1px solid var(--gray-200);border-radius:6px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='#fff'" onclick="selectSet('1')">
                        <div style="display:flex;align-items:center;gap:0.75rem">
                            <input type="radio" name="setSelect" value="1">
                            <div style="flex:1">
                                <div style="font-weight:600;margin-bottom:0.25rem">í‘œì¤€ CCTV ì„¸íŠ¸ (16ì±„ë„)</div>
                                <div style="font-size:0.8125rem;color:var(--gray-500)">8ì¢… ìì¬ í¬í•¨</div>
                            </div>
                        </div>
                    </label>
                    <label style="padding:1rem;border:1px solid var(--gray-200);border-radius:6px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='#fff'" onclick="selectSet('2')">
                        <div style="display:flex;align-items:center;gap:0.75rem">
                            <input type="radio" name="setSelect" value="2">
                            <div style="flex:1">
                                <div style="font-weight:600;margin-bottom:0.25rem">ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ êµ¬ì„±</div>
                                <div style="font-size:0.8125rem;color:var(--gray-500)">5ì¢… ìì¬ í¬í•¨</div>
                            </div>
                        </div>
                    </label>
                    <label style="padding:1rem;border:1px solid var(--gray-200);border-radius:6px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='#fff'" onclick="selectSet('3')">
                        <div style="display:flex;align-items:center;gap:0.75rem">
                            <input type="radio" name="setSelect" value="3">
                            <div style="flex:1">
                                <div style="font-weight:600;margin-bottom:0.25rem">ì„¼ì„œ íŒ¨í‚¤ì§€</div>
                                <div style="font-size:0.8125rem;color:var(--gray-500)">6ì¢… ìì¬ í¬í•¨</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSetSelectModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="loadSelectedSet()">ì„ íƒ</button>
            </div>
        </div>
    </div>
    
    <!-- ìì¬ ìˆ˜ëŸ‰ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal" id="materialQtyModal">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h2 class="modal-title">ìì¬ ìˆ˜ëŸ‰ ì…ë ¥</h2>
                <button class="close-btn" onclick="closeMaterialQtyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box highlight" id="materialQtyInfo" style="margin-bottom:1rem">
                    <div style="font-size:0.875rem">
                        <div style="font-weight:600;margin-bottom:0.25rem" id="materialQtyName">-</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)" id="materialQtySpec">-</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600);margin-top:0.25rem">ë‹¨ìœ„: <span id="materialQtyUnit">-</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ìˆ˜ëŸ‰ *</label>
                    <input type="number" class="form-input" id="materialQtyInput" min="1" value="1" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMaterialQtyModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmMaterialQty()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
    
    <script>
        let selectedSetId = null;
        let pendingTab = null;
        let isRegisterDirty = false;
        let activeTab = 'list';
        
        const MATERIALS = [
            { code: 'CAM-001', name: 'IPì¹´ë©”ë¼ 2MP ì‹¤ì™¸í˜•', spec: '2MP, 1920x1080, IR 30m, IP67', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'CAM-002', name: 'IPì¹´ë©”ë¼ 4MP ì‹¤ë‚´ìš©', spec: '4MP, 2560x1440, WDR, ì‹¤ë‚´ìš© ë”', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'CAM-003', name: 'IPì¹´ë©”ë¼ 5MP ì‹¤ì™¸í˜•', spec: '5MP, 2592x1944, IR 40m, IP67', unit: 'ê°œ', category: 'CCTV', useYn: 'Y', serialTracking: true },
            { code: 'NVR-016', name: 'NVR 16ì±„ë„', spec: '16CH, H.265, 2Bay', unit: 'ê°œ', category: 'ë…¹í™”ê¸°', useYn: 'Y', serialTracking: true },
            { code: 'NVR-032', name: 'NVR 32ì±„ë„', spec: '32CH, H.265, 4Bay', unit: 'ê°œ', category: 'ë…¹í™”ê¸°', useYn: 'Y', serialTracking: true },
            { code: 'MON-032', name: '32ì¸ì¹˜ ëª¨ë‹ˆí„°', spec: '32\", FHD, ë²½ê±¸ì´/ìŠ¤íƒ ë“œ ê²¸ìš©', unit: 'ê°œ', category: 'ëª¨ë‹ˆí„°', useYn: 'Y', serialTracking: false },
            { code: 'SW-024P', name: 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', spec: '24í¬íŠ¸ PoE, 250W, ê¸°ê°€ë¹„íŠ¸', unit: 'ê°œ', category: 'ë„¤íŠ¸ì›Œí¬', useYn: 'Y', serialTracking: false },
            { code: 'SW-008P', name: 'PoE ìŠ¤ìœ„ì¹˜ 8í¬íŠ¸', spec: '8í¬íŠ¸ PoE, 120W, ê¸°ê°€ë¹„íŠ¸', unit: 'ê°œ', category: 'ë„¤íŠ¸ì›Œí¬', useYn: 'Y', serialTracking: false },
            { code: 'CBL-C6-305', name: 'UTP ì¼€ì´ë¸” CAT6', spec: 'CAT6, 305m/Box, LSZH', unit: 'ë°•ìŠ¤', category: 'ì¼€ì´ë¸”', useYn: 'Y', serialTracking: false },
            { code: 'CBL-C5E-305', name: 'UTP ì¼€ì´ë¸” CAT5E', spec: 'CAT5E, 305m/Box, PVC', unit: 'ë°•ìŠ¤', category: 'ì¼€ì´ë¸”', useYn: 'Y', serialTracking: false },
            { code: 'BRKT-CAM-UNV', name: 'ì¹´ë©”ë¼ ë²½ë¶€ ë¸Œë¼ì¼“', spec: 'ì•Œë£¨ë¯¸ëŠ„, ë²”ìš©í˜•', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'BRKT-POLE', name: 'ì¹´ë©”ë¼ í´ ë¸Œë¼ì¼“', spec: 'í´ ë§ˆìš´íŠ¸, ìŠ¤í…Œì¸ë¦¬ìŠ¤ ë°´ë“œ í¬í•¨', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'TIE-200W', name: 'ì¼€ì´ë¸” íƒ€ì´ 200mm', spec: '200mm, ë°±ìƒ‰, 100EA/PK', unit: 'íŒ©', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'TIE-300B', name: 'ì¼€ì´ë¸” íƒ€ì´ 300mm', spec: '300mm, í‘ìƒ‰, 100EA/PK', unit: 'íŒ©', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'JBOX-150', name: 'ë°©ìˆ˜ ì ê²€í•¨ 150x150', spec: '150x150x70, IP66', unit: 'ê°œ', category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false },
            { code: 'CON-UTP', name: 'UTP RJ45 ì»¤ë„¥í„°', spec: 'CAT6, 100EA/PK', unit: 'íŒ©', category: 'ì»¤ë„¥í„°', useYn: 'Y', serialTracking: false },
            { code: 'PS-48V-2A', name: '48V 2A ì–´ëŒ‘í„°', spec: '48V DC, 2A, í”ŒëŸ¬ê·¸í˜•', unit: 'ê°œ', category: 'ì „ì›', useYn: 'Y', serialTracking: false },
            { code: 'HDD-4TB', name: 'HDD 4TB', spec: '4TB, 3.5\", 7200RPM', unit: 'ê°œ', category: 'ì €ì¥ì¥ì¹˜', useYn: 'Y', serialTracking: true },
            { code: 'SEN-TEMP', name: 'ì˜¨ë„ ì„¼ì„œ', spec: ' -40~85â„ƒ, MODBUS RTU', unit: 'ê°œ', category: 'ì„¼ì„œ', useYn: 'Y', serialTracking: true },
            { code: 'SEN-HUMI', name: 'ì˜¨ìŠµë„ ì„¼ì„œ', spec: '0~100%RH, -20~60â„ƒ, RS-485', unit: 'ê°œ', category: 'ì„¼ì„œ', useYn: 'Y', serialTracking: true }
        ];
        
        // íƒ­ ì „í™˜ (ì¶œê³ ê´€ë¦¬ì™€ ë™ì¼ íŒ¨í„´)
        function switchTab(tab) {
            if (tab === activeTab) return;
            if (activeTab === 'register' && tab === 'list' && isRegisterDirty) {
                pendingTab = tab;
                openLeaveConfirm();
                return;
            }
            
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            if (tab === 'list') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('listTab').style.display = 'block';
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('registerTab').style.display = 'block';
                renderMaterialSearchResults();
            }
        }
        
        function markRegisterDirty() { isRegisterDirty = true; }
        
        function openLeaveConfirm() {
            document.getElementById('leaveConfirmModal').classList.add('active');
        }
        function closeLeaveConfirm() {
            document.getElementById('leaveConfirmModal').classList.remove('active');
            pendingTab = null;
        }
        function leaveWithoutSaving() {
            document.getElementById('leaveConfirmModal').classList.remove('active');
            isRegisterDirty = false;
            const tab = pendingTab || 'list';
            pendingTab = null;
            switchTab(tab);
        }
        
        let currentOrderNo = 'IT260115-01';
        function showDetail(orderNo) {
            currentOrderNo = orderNo || 'IT260115-01';
            document.querySelector('#detailModal .modal-title').textContent = 'ë°œì£¼ ìƒì„¸ - ' + currentOrderNo;
            
            // ë°œì£¼ ì •ë³´ ë°ì´í„°
            const orderData = {
                'IT260115-01': {
                    company: 'ê°•ë‚¨ê±´ì„¤',
                    site: 'ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”',
                    contract: 'CT-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜',
                    date: '2024-01-15',
                    status: 'active',
                    statusText: 'ì¶œê³ ì™„ë£Œ',
                    hasChange: true
                },
                'IT260118-01': {
                    company: 'íŒêµê±´ì„¤',
                    site: 'íŒêµ ê³µì¥',
                    contract: 'CT-2024-002 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜',
                    date: '2024-01-18',
                    status: 'active',
                    statusText: 'ì¶œê³ ì™„ë£Œ',
                    hasChange: true
                },
                'IT260125-01': {
                    company: 'ì¸ì²œê±´ì„¤',
                    site: 'ì¸ì²œ ë¬¼ë¥˜ì„¼í„°',
                    contract: 'CT-2024-003 - ì¸ì²œ ë¬¼ë¥˜ì„¼í„° í†µí•© ì„¤ì¹˜',
                    date: '2024-01-25',
                    status: 'pending',
                    statusText: 'ì¶œê³ ëŒ€ê¸°',
                    hasChange: false
                }
            };
            
            const order = orderData[currentOrderNo] || orderData['IT260115-01'];
            
            // ì •ë³´ ì—…ë°ì´íŠ¸
            const infoRows = document.querySelectorAll('#detailModal .info-box .info-row');
            if (infoRows.length >= 6) {
                // ë°œì£¼ ë²ˆí˜¸
                infoRows[0].querySelector('strong').textContent = currentOrderNo;
                // ê²¬ì 
                const contractSpan = infoRows[1].querySelector('span:last-child');
                if (contractSpan) {
                    contractSpan.innerHTML = order.contract + (order.hasChange ? ' <span class="status-badge status-warning" style="margin-left:4px">ê²¬ì ë³€ê²½</span>' : '');
                }
                // ë³¸ì‚¬
                infoRows[2].querySelector('span:last-child').textContent = order.company;
                // í˜„ì¥
                infoRows[3].querySelector('span:last-child').textContent = order.site;
                // ë°œì£¼ì¼
                infoRows[4].querySelector('span:last-child').textContent = order.date;
                // ìƒíƒœ
                const statusBadge = infoRows[5].querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-' + order.status;
                    statusBadge.textContent = order.statusText;
                }
            }
            
            document.getElementById('detailModal').classList.add('active');
        }
        function closeDetail() { document.getElementById('detailModal').classList.remove('active'); }
        
        function openEditOrderModal(orderNo) {
            orderNo = orderNo || 'IT260115-01';
            document.getElementById('editOrderNo').textContent = orderNo;
            document.getElementById('editOrderNumber').value = orderNo;
            document.getElementById('editOrderReason').value = '';
            // ëª¨ë‹¬ ì—´ ë•Œ ì „ì²´ í™”ë©´ ëª¨ë“œ ì´ˆê¸°í™”
            const content = document.getElementById('editOrderModalContent');
            const toggleBtn = document.getElementById('fullscreenToggle');
            if (content) {
                content.classList.remove('fullscreen');
            }
            if (toggleBtn) {
                toggleBtn.textContent = 'â›¶';
                toggleBtn.title = 'ì „ì²´ í™”ë©´';
            }
            // ìì¬ ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
            const searchInput = document.getElementById('editMaterialSearch');
            if (searchInput) {
                searchInput.value = '';
                hideEditMaterialAutocomplete();
            }
            document.getElementById('editOrderModal').classList.add('active');
            setTimeout(initEditDragAndDrop, 100);
        }
        
        // ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ - ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        let draggedEditRow = null;
        function initEditDragAndDrop() {
            const tbody = document.getElementById('editMaterialList');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr.draggable-row');
            rows.forEach(function(row) {
                row.draggable = true;
                row.removeEventListener('dragstart', handleEditDragStart);
                row.removeEventListener('dragend', handleEditDragEnd);
                row.removeEventListener('dragover', handleEditDragOver);
                row.removeEventListener('dragleave', handleEditDragLeave);
                row.removeEventListener('drop', handleEditDrop);
                
                row.addEventListener('dragstart', handleEditDragStart);
                row.addEventListener('dragend', handleEditDragEnd);
                row.addEventListener('dragover', handleEditDragOver);
                row.addEventListener('dragleave', handleEditDragLeave);
                row.addEventListener('drop', handleEditDrop);
            });
        }
        
        function handleEditDragStart(e) {
            draggedEditRow = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleEditDragEnd(e) {
            this.style.opacity = '';
            const tbody = document.getElementById('editMaterialList');
            if (tbody) {
                const allRows = tbody.querySelectorAll('tr.draggable-row');
                allRows.forEach(function(r) {
                    r.classList.remove('drag-over');
                });
            }
        }
        
        function handleEditDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedEditRow) {
                this.classList.add('drag-over');
            }
        }
        
        function handleEditDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleEditDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (draggedEditRow && this !== draggedEditRow) {
                const tbody = document.getElementById('editMaterialList');
                if (tbody) {
                    const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));
                    const draggedIndex = allRows.indexOf(draggedEditRow);
                    const targetIndex = allRows.indexOf(this);
                    if (draggedIndex < targetIndex) {
                        tbody.insertBefore(draggedEditRow, this.nextSibling);
                    } else {
                        tbody.insertBefore(draggedEditRow, this);
                    }
                }
            }
        }
        function closeEditOrderModal() { 
            const modal = document.getElementById('editOrderModal');
            const content = document.getElementById('editOrderModalContent');
            modal.classList.remove('active');
            // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì „ì²´ í™”ë©´ ëª¨ë“œ í•´ì œ
            if (content) {
                content.classList.remove('fullscreen');
                const toggleBtn = document.getElementById('fullscreenToggle');
                if (toggleBtn) toggleBtn.textContent = 'â›¶';
            }
            // ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            hideEditMaterialAutocomplete();
        }
        
        function toggleFullscreenModal() {
            const content = document.getElementById('editOrderModalContent');
            const toggleBtn = document.getElementById('fullscreenToggle');
            if (!content || !toggleBtn) return;
            
            if (content.classList.contains('fullscreen')) {
                content.classList.remove('fullscreen');
                toggleBtn.textContent = 'â›¶';
                toggleBtn.title = 'ì „ì²´ í™”ë©´';
            } else {
                content.classList.add('fullscreen');
                toggleBtn.textContent = 'âŠ¡';
                toggleBtn.title = 'ì¼ë°˜ í™”ë©´';
            }
        }
        function loadEditContract() { document.getElementById('editContractInfo').style.display = document.getElementById('editContractSelect').value ? 'block' : 'none'; }
        // ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ - ìì¬ ìë™ì™„ì„± ê¸°ëŠ¥
        let editMaterialAutocompleteIndex = -1;
        let editMaterialAutocompleteItems = [];
        
        function handleEditMaterialSearch() {
            const keyword = document.getElementById('editMaterialSearch').value.trim().toLowerCase();
            const dropdown = document.getElementById('editMaterialAutocomplete');
            
            if (!keyword) {
                hideEditMaterialAutocomplete();
                return;
            }
            
            // ìì¬ ì½”ë“œ, ìì¬ëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰
            const filtered = MATERIALS.filter(m => 
                m.useYn === 'Y' && (
                    m.code.toLowerCase().includes(keyword) ||
                    m.name.toLowerCase().includes(keyword) ||
                    m.category.toLowerCase().includes(keyword)
                )
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);cursor:default">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            editMaterialAutocompleteItems = filtered;
            editMaterialAutocompleteIndex = -1;
            
            dropdown.innerHTML = filtered.map((m, idx) => `
                <div class="autocomplete-item" data-index="${idx}" onclick="selectEditMaterial(${idx})" onmouseover="highlightEditMaterial(${idx})">
                    <div class="autocomplete-item-code">${m.code}</div>
                    <div class="autocomplete-item-name">${m.name}</div>
                    <div class="autocomplete-item-info">${m.spec} | ${m.category} | ${m.unit}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function handleEditMaterialKeydown(event) {
            const dropdown = document.getElementById('editMaterialAutocomplete');
            if (dropdown.style.display === 'none' || editMaterialAutocompleteItems.length === 0) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const keyword = document.getElementById('editMaterialSearch').value.trim();
                    if (keyword) {
                        // ê²€ìƒ‰ì–´ë¡œ ì§ì ‘ ì¶”ê°€ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
                        addEditMaterialByName(keyword);
                    }
                }
                return;
            }
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                editMaterialAutocompleteIndex = Math.min(editMaterialAutocompleteIndex + 1, editMaterialAutocompleteItems.length - 1);
                highlightEditMaterial(editMaterialAutocompleteIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                editMaterialAutocompleteIndex = Math.max(editMaterialAutocompleteIndex - 1, -1);
                if (editMaterialAutocompleteIndex >= 0) {
                    highlightEditMaterial(editMaterialAutocompleteIndex);
                } else {
                    clearEditMaterialHighlight();
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (editMaterialAutocompleteIndex >= 0) {
                    selectEditMaterial(editMaterialAutocompleteIndex);
                }
            } else if (event.key === 'Escape') {
                hideEditMaterialAutocomplete();
            }
        }
        
        function handleEditMaterialFocus() {
            const keyword = document.getElementById('editMaterialSearch').value.trim();
            if (keyword) {
                handleEditMaterialSearch();
            }
        }
        
        function highlightEditMaterial(index) {
            clearEditMaterialHighlight();
            editMaterialAutocompleteIndex = index;
            const items = document.querySelectorAll('#editMaterialAutocomplete .autocomplete-item');
            if (items[index]) {
                items[index].classList.add('selected');
                items[index].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
        
        function clearEditMaterialHighlight() {
            document.querySelectorAll('#editMaterialAutocomplete .autocomplete-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        function selectEditMaterial(index) {
            const material = editMaterialAutocompleteItems[index];
            if (!material) return;
            
            addEditMaterialFromData(material);
            hideEditMaterialAutocomplete();
        }
        
        function hideEditMaterialAutocomplete() {
            document.getElementById('editMaterialAutocomplete').style.display = 'none';
            editMaterialAutocompleteIndex = -1;
        }
        
        function addEditMaterialFromData(material) {
            const tbody = document.getElementById('editMaterialList');
            // ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì¸ì§€ í™•ì¸
            const existingRows = tbody.querySelectorAll('tr.draggable-row');
            for (let row of existingRows) {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell && nameCell.textContent.trim() === material.name) {
                    alert('ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì…ë‹ˆë‹¤.');
                    return;
                }
            }
            
            tbody.insertAdjacentHTML('beforeend',
                '<tr draggable="true" class="draggable-row">' +
                    '<td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td>' +
                    '<td><strong>' + material.code + '</strong></td>' +
                    '<td>' + material.name + '</td>' +
                    '<td>' + material.spec + '</td>' +
                    '<td><input type="number" class="form-input" value="1" min="1" style="padding:0.25rem"></td>' +
                    '<td>' + material.unit + '</td>' +
                    '<td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td>' +
                    '<td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest(\'tr\').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td>' +
                '</tr>'
            );
            document.getElementById('editMaterialSearch').value = '';
            initEditDragAndDrop();
        }
        
        // ê¸°ì¡´ ë°©ì‹ ìœ ì§€ (ê²€ìƒ‰ì–´ë¡œ ì§ì ‘ ì¶”ê°€)
        function addEditMaterialByName(name) {
            if (!name || !name.trim()) return;
            const tbody = document.getElementById('editMaterialList');
            tbody.insertAdjacentHTML('beforeend',
                '<tr draggable="true" class="draggable-row">' +
                    '<td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td>' +
                    '<td>-</td>' +
                    '<td>' + name.trim() + '</td>' +
                    '<td>-</td>' +
                    '<td><input type="number" class="form-input" value="1" min="1" style="padding:0.25rem"></td>' +
                    '<td>ê°œ</td>' +
                    '<td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td>' +
                    '<td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest(\'tr\').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td>' +
                '</tr>'
            );
            document.getElementById('editMaterialSearch').value = '';
            initEditDragAndDrop();
        }
        function submitEditOrder() {
            const reason = document.getElementById('editOrderReason').value.trim();
            if (!reason) {
                alert('ìˆ˜ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('editOrderReason').focus();
                return;
            }
            const rows = document.querySelectorAll('#editMaterialList tr');
            if (!rows.length) return alert('ë°œì£¼ ìì¬ë¥¼ 1ì¢… ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”');
            alert('âœ… ë°œì£¼ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeEditOrderModal();
        }
        
        // ê²¬ì  ë°ì´í„° êµ¬ì¡° (ë³¸ì‚¬_í˜„ì¥ í‚¤ë¡œ ê´€ë¦¬)
        const CONTRACTS_DATA = {
            'ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”': {
                company: 'ê°•ë‚¨ê±´ì„¤',
                site: 'ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”',
                contracts: [
                    { value: '1', text: 'CT-2024-001 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜', site: 'ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”', company: 'ê°•ë‚¨ê±´ì„¤', amount: '150,000,000', ownership: 'íŒë§¤', quality: 'ì‹ í’ˆ' }
                ]
            },
            'ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥': {
                company: 'ì‚¼ì„±ë¬¼ì‚°',
                site: 'íŒêµ ê³µì¥',
                contracts: [
                    { value: '2', text: 'CT-2024-002 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜', site: 'íŒêµ ê³µì¥', company: 'ì‚¼ì„±ë¬¼ì‚°', amount: '80,000,000', ownership: 'íŒë§¤', quality: 'ì‹ í’ˆ' }
                ]
            },
            'ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°': {
                company: 'ì¸ì²œê±´ì„¤',
                site: 'ì¸ì²œ ë¬¼ë¥˜ì„¼í„°',
                contracts: []
            }
        };
        
        // í†µí•© ê²€ìƒ‰ì„ ìœ„í•œ ì „ì²´ ê²¬ì  ëª©ë¡
        const ALL_CONTRACTS = [];
        Object.keys(CONTRACTS_DATA).forEach(key => {
            const data = CONTRACTS_DATA[key];
            data.contracts.forEach(contract => {
                ALL_CONTRACTS.push({
                    ...contract,
                    key: key,
                    searchText: `${data.company} ${data.site} ${contract.text}`.toLowerCase()
                });
            });
        });
        
        function loadRegisterSite() {
            const siteKey = document.getElementById('regSiteSelect').value;
            const contractSelect = document.getElementById('regContractSelect');
            const contractInfo = document.getElementById('regContractInfo');
            
            // ê²¬ì  ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            contractSelect.innerHTML = '<option value="">ê²¬ì  ì„ íƒ</option>';
            contractSelect.disabled = !siteKey;
            
            if (!siteKey) {
                contractInfo.style.display = 'none';
                markRegisterDirty();
                return;
            }
            
            // ì„ íƒëœ í˜„ì¥ì˜ ê²¬ì  ëª©ë¡ ë¡œë“œ
            const siteData = CONTRACTS_DATA[siteKey];
            if (!siteData || !siteData.contracts || siteData.contracts.length === 0) {
                contractSelect.innerHTML = '<option value="">í•´ë‹¹ í˜„ì¥ì˜ ê²¬ì ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                contractInfo.style.display = 'none';
            } else {
                siteData.contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.value;
                    option.textContent = contract.text;
                    contractSelect.appendChild(option);
                });
            }
            
            // ê¸°ì¡´ ê²¬ì  ì •ë³´ ìˆ¨ê¸°ê¸°
            contractInfo.style.display = 'none';
            contractSelect.value = '';
            markRegisterDirty();
        }
        
        function loadRegisterContract() {
            const siteKey = document.getElementById('regSiteSelect').value;
            const contractId = document.getElementById('regContractSelect').value;
            const contractInfo = document.getElementById('regContractInfo');
            
            if (!contractId || !siteKey) {
                contractInfo.style.display = 'none';
                markRegisterDirty();
                return;
            }
            
            // ì„ íƒëœ ê²¬ì  ì •ë³´ í‘œì‹œ
            const siteData = CONTRACTS_DATA[siteKey];
            if (!siteData) {
                contractInfo.style.display = 'none';
                markRegisterDirty();
                return;
            }
            const contract = siteData.contracts.find(c => c.value === contractId);
            
            if (contract) {
                // ê²¬ì  ì •ë³´ ì—…ë°ì´íŠ¸
                const infoDivs = contractInfo.querySelectorAll('div');
                if (infoDivs.length >= 2) {
                    infoDivs[1].innerHTML = `í˜„ì¥: <strong>${contract.site}</strong> | ë°œì£¼ì²˜: <strong>${contract.company}</strong> | ê¸ˆì•¡: <strong style="color:var(--primary)">${contract.amount}ì›</strong> | ì†Œìœ êµ¬ë¶„: <strong>${contract.ownership}</strong> | í’ˆì§ˆ: <strong>${contract.quality}</strong>`;
                }
                contractInfo.style.display = 'block';
            } else {
                contractInfo.style.display = 'none';
            }
            
            markRegisterDirty();
        }
        
        function openRecentContractsModal() {
            document.getElementById('recentContractsModal').classList.add('active');
        }
        
        function selectRecentContractFromModal(contractId) {
            selectRecentContract(contractId);
            closeModal('recentContractsModal');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // ìµœê·¼ ì´ë ¥ì—ì„œ ê²¬ì  ì„ íƒ
        function selectRecentContract(contractId) {
            // ì „ì²´ ë°ì´í„°ì—ì„œ í•´ë‹¹ ê²¬ì  ì°¾ê¸°
            let foundContract = null;
            let foundKey = null;
            
            Object.keys(CONTRACTS_DATA).forEach(key => {
                const siteData = CONTRACTS_DATA[key];
                const contract = siteData.contracts.find(c => c.value === contractId);
                if (contract) {
                    foundContract = contract;
                    foundKey = key;
                }
            });
            
            if (!foundContract || !foundKey) return;
            
            // ë“œë¡­ë‹¤ìš´ì— ìë™ ì„ íƒ
            document.getElementById('regSiteSelect').value = foundKey;
            loadRegisterSite();
            
            setTimeout(() => {
                document.getElementById('regContractSelect').value = contractId;
                loadRegisterContract();
            }, 50);
        }
        
        // í†µí•© ê²€ìƒ‰ ê¸°ëŠ¥
        let contractSearchSelectedIndex = -1;
        function handleContractSearch() {
            const query = document.getElementById('regContractSearch').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('contractSearchResults');
            
            if (!query) {
                resultsDiv.style.display = 'none';
                contractSearchSelectedIndex = -1;
                return;
            }
            
            // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
            const results = ALL_CONTRACTS.filter(contract => 
                contract.searchText.includes(query)
            ).slice(0, 10); // ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);text-align:center;padding:1rem">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            resultsDiv.innerHTML = '';
            results.forEach((contract, index) => {
                const siteData = CONTRACTS_DATA[contract.key];
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.index = index;
                item.onclick = () => selectContractFromSearch(contract.key, contract.value);
                item.onmouseover = () => highlightContractSearchItem(index);
                
                item.innerHTML = `
                    <div class="autocomplete-item-name">${contract.text}</div>
                    <div class="autocomplete-item-info">${siteData.company} > ${siteData.site}</div>
                `;
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.style.display = 'block';
            contractSearchSelectedIndex = -1;
        }
        
        function handleContractSearchKeydown(event) {
            const resultsDiv = document.getElementById('contractSearchResults');
            const items = resultsDiv.querySelectorAll('.autocomplete-item');
            
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                contractSearchSelectedIndex = Math.min(contractSearchSelectedIndex + 1, items.length - 1);
                highlightContractSearchItem(contractSearchSelectedIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                contractSearchSelectedIndex = Math.max(contractSearchSelectedIndex - 1, -1);
                highlightContractSearchItem(contractSearchSelectedIndex);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (contractSearchSelectedIndex >= 0 && contractSearchSelectedIndex < items.length) {
                    items[contractSearchSelectedIndex].click();
                }
            }
        }
        
        function highlightContractSearchItem(index) {
            const items = document.getElementById('contractSearchResults').querySelectorAll('.autocomplete-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            contractSearchSelectedIndex = index;
        }
        
        function selectContractFromSearch(siteKey, contractId) {
            // ë“œë¡­ë‹¤ìš´ì— ìë™ ì„ íƒ
            document.getElementById('regSiteSelect').value = siteKey;
            loadRegisterSite();
            
            setTimeout(() => {
                document.getElementById('regContractSelect').value = contractId;
                loadRegisterContract();
            }, 50);
            
            // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            document.getElementById('regContractSearch').value = '';
            hideContractSearchResults();
        }
        
        function hideContractSearchResults() {
            document.getElementById('contractSearchResults').style.display = 'none';
            contractSearchSelectedIndex = -1;
        }
        
        function viewContractDocument() {
            const contractSelect = document.getElementById('regContractSelect');
            const contractId = contractSelect.value;
            if (!contractId) {
                alert('ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            // ê²¬ì ì„œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œ)
            const selectedOption = contractSelect.options[contractSelect.selectedIndex];
            const contractNo = selectedOption ? selectedOption.textContent.split(' - ')[0] : '-';
            
            // ê²¬ì ì„œ ì´ë¯¸ì§€ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
            const modal = document.getElementById('contractViewModal');
            if (modal) {
                document.getElementById('contractViewNo').textContent = contractNo;
                modal.classList.add('active');
            }
        }
        
        function downloadContractDocument() {
            const contractId = document.getElementById('regContractSelect').value;
            if (!contractId) {
                alert('ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            // ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ
            const contractNames = {
                '1': 'CT-2024-001_ê²¬ì ì„œ.pdf',
                '2': 'CT-2024-002_ê²¬ì ì„œ.pdf'
            };
            const fileName = contractNames[contractId] || contractNames['1'];
            alert('âœ… ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.\níŒŒì¼ëª…: ' + fileName + '\n\n(ì‹¤ì œ êµ¬í˜„ ì‹œ ì„œë²„ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤)');
            // ì‹¤ì œ êµ¬í˜„ ì‹œ:
            // const link = document.createElement('a');
            // link.href = '/api/contracts/' + contractId + '/download';
            // link.download = fileName;
            // link.click();
        }
        
        function closeContractViewModal() {
            document.getElementById('contractViewModal').classList.remove('active');
        }
        
        function renderMaterialSearchResults() {
            const keyword = (document.getElementById('regMaterialKeyword')?.value || '').trim().toLowerCase();
            const category = document.getElementById('regMaterialCategory')?.value || '';
            const serialFilter = document.getElementById('regMaterialSerial')?.value || 'false';
            
            let rows = MATERIALS.slice();
            // ì‚¬ìš© ì¤‘ì¸ ìì¬ë§Œ í‘œì‹œ
            rows = rows.filter(m => m.useYn === 'Y');
            // ì‹œë¦¬ì–¼ í•„í„° ì ìš© (í•­ìƒ í•„í„°ë§ë¨)
            const isSerial = serialFilter === 'true';
            rows = rows.filter(m => m.serialTracking === isSerial);
            if (category) rows = rows.filter(m => m.category === category);
            if (keyword) {
                rows = rows.filter(m =>
                    (m.code || '').toLowerCase().includes(keyword) ||
                    (m.name || '').toLowerCase().includes(keyword) ||
                    (m.spec || '').toLowerCase().includes(keyword)
                );
            }
            
            const tbody = document.getElementById('regMaterialResultBody');
            if (!tbody) return;
            
            // ì‹œë¦¬ì–¼ í•„í„°ëŠ” í•­ìƒ ì ìš©ë˜ë¯€ë¡œ, ê²€ìƒ‰ì–´ë‚˜ ì¹´í…Œê³ ë¦¬ê°€ ì—†ì–´ë„ ê²°ê³¼ í‘œì‹œ
            // (ì‹œë¦¬ì–¼ í•„í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ)
            if (!rows.length) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--gray-500);padding:1.5rem">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
                return;
            }
            
            tbody.innerHTML = rows.map(m => `
                <tr>
                    <td><strong>${m.code}</strong></td>
                    <td>
                        <div style="font-weight:500">${m.name}</div>
                        <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">${m.spec || '-'}</div>
                    </td>
                    <td>${m.unit}</td>
                    <td>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openMaterialQtyModal('${m.code}')" style="white-space:nowrap;writing-mode:horizontal-tb">ì¶”ê°€</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function getSelectedRowByCode(code) {
            return document.querySelector(`#regSelectedBody tr[data-code="${code}"]`);
        }
        
        let pendingMaterialCode = null;
        
        function openMaterialQtyModal(code) {
            const material = MATERIALS.find(m => m.code === code);
            if (!material) return alert('ìì¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            pendingMaterialCode = code;
            document.getElementById('materialQtyName').textContent = material.name;
            document.getElementById('materialQtySpec').textContent = material.spec || '-';
            document.getElementById('materialQtyUnit').textContent = material.unit || '-';
            document.getElementById('materialQtyInput').value = '1';
            document.getElementById('materialQtyModal').classList.add('active');
        }
        
        function closeMaterialQtyModal() {
            document.getElementById('materialQtyModal').classList.remove('active');
            pendingMaterialCode = null;
        }
        
        function confirmMaterialQty() {
            if (!pendingMaterialCode) return;
            
            const qtyInput = document.getElementById('materialQtyInput');
            const qty = parseInt(qtyInput.value, 10);
            
            if (!qty || qty < 1) {
                alert('ìˆ˜ëŸ‰ì„ 1 ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                qtyInput.focus();
                return;
            }
            
            addMaterialToRegister(pendingMaterialCode, qty);
            closeMaterialQtyModal();
        }
        
        function addMaterialToRegister(code, qtyToAdd = 1) {
            const material = MATERIALS.find(m => m.code === code);
            if (!material) return alert('ìì¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            const tbody = document.getElementById('regSelectedBody');
            if (!tbody) return;
            
            // ë¹ˆ ì•ˆë‚´ row ì œê±°
            if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
            
            // ë™ì¼ ìì¬ë¥¼ ë˜ ì¶”ê°€í•´ë„ í•­ìƒ ìƒˆë¡œìš´ í–‰ìœ¼ë¡œ ì¶”ê°€
            const uniqueId = Date.now() + Math.random(); // ê³ ìœ  ID ìƒì„±
            
            tbody.insertAdjacentHTML('beforeend', `
                <tr draggable="true" class="draggable-row" data-code="${material.code}" data-row-id="${uniqueId}" data-unit-per-set="${qtyToAdd}">
                    <td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td>
                    <td>
                        <div style="font-weight:500">${material.name}</div>
                        <div style="font-size:0.8125rem;color:var(--gray-500);margin-top:0.25rem">${material.spec}</div>
                    </td>
                    <td>
                        <input data-role="bundle" type="text" class="form-input" placeholder="ì˜ˆ: CCTV-1ì‹" style="padding:0.25rem;font-size:0.8125rem" oninput="markRegisterDirty()">
                    </td>
                    <td>
                        <input data-role="qty" type="number" class="form-input" value="${qtyToAdd}" min="0" style="padding:0.25rem" onchange="updateRegisterSummary(); markRegisterDirty()">
                    </td>
                    <td>${material.unit}</td>
                    <td>
                        <select class="form-select" style="padding:0.25rem;font-size:0.875rem" onchange="markRegisterDirty()">
                            <option value="new" selected>ì‹ í’ˆ</option>
                            <option value="used">ì¤‘ê³ </option>
                        </select>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff;white-space:nowrap;writing-mode:horizontal-tb" onclick="removeRegisterRowById('${uniqueId}')">ì‚­ì œ</button>
                    </td>
                </tr>
            `);
            
            initRegisterDragAndDrop();
            updateRegisterSummary();
            markRegisterDirty();
        }
        
        function removeRegisterRowById(rowId) {
            const row = document.querySelector(`#regSelectedBody tr[data-row-id="${rowId}"]`);
            let bundleKey = '';
            if (row) {
                const bundleInput = row.querySelector('input[data-role="bundle"]');
                bundleKey = (bundleInput?.value || '').trim();
                row.remove();
            }
            
            const tbody = document.getElementById('regSelectedBody');
            if (tbody && !tbody.querySelector('tr')) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--gray-500);padding:2rem">ì¢Œì¸¡ì—ì„œ ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>`;
            }
            initRegisterDragAndDrop();
            updateRegisterSummary();
            // í•´ë‹¹ ë¬¶ìŒì— ë” ì´ìƒ í–‰ì´ ì—†ìœ¼ë©´ í—¤ë”ë„ ì œê±°
            if (bundleKey) {
                const stillExists = tbody && tbody.querySelectorAll('tr[data-code] input[data-role="bundle"]').length &&
                    Array.from(tbody.querySelectorAll('tr[data-code] input[data-role="bundle"]')).some(input => (input.value || '').trim() === bundleKey);
                if (!stillExists) {
                    document.querySelectorAll(`#regSelectedBody tr[data-bundle-header="${bundleKey}"]`).forEach(h => h.remove());
                }
            }
            updateRegisterSummary();
            markRegisterDirty();
        }
        
        function removeRegisterRow(code) {
            const row = getSelectedRowByCode(code);
            let bundleKey = '';
            if (row) {
                const bundleInput = row.querySelector('input[data-role="bundle"]');
                bundleKey = (bundleInput?.value || '').trim();
                row.remove();
            }
            
            const tbody = document.getElementById('regSelectedBody');
            if (tbody && !tbody.querySelector('tr')) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--gray-500);padding:2rem">ì¢Œì¸¡ì—ì„œ ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>`;
            }
            initRegisterDragAndDrop();
            updateRegisterSummary();
            // í•´ë‹¹ ë¬¶ìŒì— ë” ì´ìƒ í–‰ì´ ì—†ìœ¼ë©´ í—¤ë”ë„ ì œê±°
            if (bundleKey) {
                const stillExists = tbody && tbody.querySelectorAll('tr[data-code] input[data-role="bundle"]').length &&
                    Array.from(tbody.querySelectorAll('tr[data-code] input[data-role="bundle"]')).some(input => (input.value || '').trim() === bundleKey);
                if (!stillExists) {
                    document.querySelectorAll(`#regSelectedBody tr[data-bundle-header="${bundleKey}"]`).forEach(h => h.remove());
                }
            }
            updateRegisterSummary();
            markRegisterDirty();
        }
        
        function updateRegisterSummary() {
            const rows = Array.from(document.querySelectorAll('#regSelectedBody tr[data-code]'));
            const itemCount = rows.length;
            const totalQty = rows.reduce((sum, r) => {
                const qty = parseInt(r.querySelector('input[data-role="qty"]')?.value || '0', 10) || 0;
                return sum + qty;
            }, 0);
            
            const itemEl = document.getElementById('regItemCount');
            const qtyEl = document.getElementById('regTotalQty');
            if (itemEl) itemEl.textContent = String(itemCount);
            if (qtyEl) qtyEl.textContent = String(totalQty);
        }
        
        // ë°œì£¼ ë“±ë¡ íƒ­ - ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        let draggedRegisterRow = null;
        function initRegisterDragAndDrop() {
            const tbody = document.getElementById('regSelectedBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr.draggable-row');
            rows.forEach(function(row) {
                row.draggable = true;
                row.removeEventListener('dragstart', handleRegisterDragStart);
                row.removeEventListener('dragend', handleRegisterDragEnd);
                row.removeEventListener('dragover', handleRegisterDragOver);
                row.removeEventListener('dragleave', handleRegisterDragLeave);
                row.removeEventListener('drop', handleRegisterDrop);
                
                row.addEventListener('dragstart', handleRegisterDragStart);
                row.addEventListener('dragend', handleRegisterDragEnd);
                row.addEventListener('dragover', handleRegisterDragOver);
                row.addEventListener('dragleave', handleRegisterDragLeave);
                row.addEventListener('drop', handleRegisterDrop);
            });
        }
        
        function handleRegisterDragStart(e) {
            draggedRegisterRow = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleRegisterDragEnd(e) {
            this.style.opacity = '';
            const tbody = document.getElementById('regSelectedBody');
            if (tbody) {
                const allRows = tbody.querySelectorAll('tr.draggable-row');
                allRows.forEach(function(r) {
                    r.classList.remove('drag-over');
                });
            }
        }
        
        function handleRegisterDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            // ë¬¶ìŒ í—¤ë” í–‰ì€ ë“œë¡­ ëŒ€ìƒì—ì„œ ì œì™¸
            if (this.hasAttribute('data-bundle-header')) return;
            if (this !== draggedRegisterRow && this.classList.contains('draggable-row')) {
                this.classList.add('drag-over');
            }
        }
        
        function handleRegisterDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleRegisterDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            // ë¬¶ìŒ í—¤ë” í–‰ì€ ë“œë¡­ ëŒ€ìƒì—ì„œ ì œì™¸
            if (this.hasAttribute('data-bundle-header')) return;
            if (draggedRegisterRow && this !== draggedRegisterRow && this.classList.contains('draggable-row')) {
                const tbody = document.getElementById('regSelectedBody');
                if (tbody) {
                    const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));
                    const draggedIndex = allRows.indexOf(draggedRegisterRow);
                    const targetIndex = allRows.indexOf(this);
                    if (draggedIndex < targetIndex) {
                        tbody.insertBefore(draggedRegisterRow, this.nextSibling);
                    } else {
                        tbody.insertBefore(draggedRegisterRow, this);
                    }
                    markRegisterDirty();
                }
            }
        }
        
        function resetRegisterForm() {
            if (!confirm('ì‘ì„± ì¤‘ì¸ ë°œì£¼ ë“±ë¡ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            document.getElementById('regSiteSelect').value = '';
            document.getElementById('regContractSelect').value = '';
            document.getElementById('regContractSelect').disabled = true;
            document.getElementById('regContractSelect').innerHTML = '<option value="">í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>';
            document.getElementById('regContractSearch').value = '';
            hideContractSearchResults();
            document.getElementById('regOrderNote').value = '';
            document.getElementById('regContractInfo').style.display = 'none';
            document.getElementById('regMaterialKeyword').value = '';
            document.getElementById('regMaterialCategory').value = '';
            document.getElementById('regMaterialSerial').value = 'false';
            document.getElementById('bundleKeyInput').value = '';
            document.getElementById('bundleCountInput').value = '1';
            document.getElementById('regSelectedBody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--gray-500);padding:2rem">ì¢Œì¸¡ì—ì„œ ìì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</td></tr>`;
            updateRegisterSummary();
            isRegisterDirty = false;
            renderMaterialSearchResults();
        }
        
        function mockTempSave() {
            alert('ğŸ’¾ (ëª©ì—…) ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            isRegisterDirty = false;
            closeLeaveConfirm();
        }
        
        function submitRegisterOrder() {
            const contract = document.getElementById('regContractSelect').value;
            const rows = Array.from(document.querySelectorAll('#regSelectedBody tr[data-code]'));
            
            if (!contract) return alert('ê²¬ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if (!rows.length) return alert('ë°œì£¼ ìì¬ë¥¼ 1ì¢… ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            
            // ë°œì£¼ì¼ì€ ë“±ë¡ ì‹œì ì˜ ë‚ ì§œë¡œ ìë™ ì„¤ì •
            const orderDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
            
            alert('âœ… (ëª©ì—…) ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            isRegisterDirty = false;
            switchTab('list');
        }
        
        function applyBundleQuantity() {
            const key = (document.getElementById('bundleKeyInput')?.value || '').trim();
            const count = parseInt(document.getElementById('bundleCountInput')?.value || '0', 10);
            
            if (!key) return alert('ë¬¶ìŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: CCTV-1ì‹)');
            if (!count || count <= 0) return alert('ì‹ ìˆ˜ëŸ‰ì„ 1 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            const rows = Array.from(document.querySelectorAll('#regSelectedBody tr[data-code]'));
            let affected = 0;
            let firstMatchedRow = null;
            rows.forEach(row => {
                const bundleInput = row.querySelector('input[data-role="bundle"]');
                const qtyInput = row.querySelector('input[data-role="qty"]');
                if (!bundleInput || !qtyInput) return;
                
                if ((bundleInput.value || '').trim() === key) {
                    const base = parseInt(row.getAttribute('data-unit-per-set') || qtyInput.value || '0', 10) || 0;
                    qtyInput.value = String(base * count);
                    affected++;
                    if (!firstMatchedRow) firstMatchedRow = row;
                }
            });
            
            if (!affected) {
                alert('í•´ë‹¹ ë¬¶ìŒ IDë¥¼ ê°€ì§„ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.\në°œì£¼ í’ˆëª©ì˜ ë¬¶ìŒ IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            updateRegisterSummary();
            markRegisterDirty();
            
            // ë¬¶ìŒ ìš”ì•½ í—¤ë”(ì‹œê°ì  êµ¬ë¶„ìš©) ì¶”ê°€/ê°±ì‹ 
            if (firstMatchedRow) {
                let header = document.querySelector(`#regSelectedBody tr[data-bundle-header="${key}"]`);
                if (!header) {
                    header = document.createElement('tr');
                    header.setAttribute('data-bundle-header', key);
                    header.style.background = 'var(--gray-50)';
                    firstMatchedRow.parentNode.insertBefore(header, firstMatchedRow);
                }
                header.innerHTML = `<td colspan="7" style="font-size:0.8125rem;color:var(--gray-600);padding:0.35rem 0.75rem">
                    ë¬¶ìŒ: <strong>${key}</strong> (${count}ì‹)
                </td>`;
            }
            alert(`ğŸ”— ë¬¶ìŒ "${key}"ì˜ ë°œì£¼ ìˆ˜ëŸ‰ì´ ì‹ ìˆ˜ëŸ‰ ${count} ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        // ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬
        function openSetSelectModal() {
            document.getElementById('setSelectModal').classList.add('active');
        }
        
        function closeSetSelectModal() {
            document.getElementById('setSelectModal').classList.remove('active');
            selectedSetId = null;
        }
        
        function selectSet(setId) {
            selectedSetId = setId;
            document.querySelectorAll('input[name="setSelect"]').forEach(r => r.checked = false);
            event.target.closest('label').querySelector('input').checked = true;
        }
        
        function loadSelectedSet() {
            if (!selectedSetId) return alert('ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');

            // ìƒ˜í”Œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„ íƒëœ ì„¸íŠ¸ì— ë”°ë¼ ë‹¤ë¥¸ ë°ì´í„°)
            const setData = {
                '1': [
                    ['CAM-001', 'IPì¹´ë©”ë¼ 2MP', '2MP, IP67', 50, 'ê°œ'],
                    ['CAM-002', 'IPì¹´ë©”ë¼ 4MP', '4MP, ì‹¤ë‚´ìš©', 20, 'ê°œ'],
                    ['NVR-016', 'NVR 16ì±„ë„', '16CH, H.265', 10, 'ê°œ'],
                    ['CBL-C6', 'UTP ì¼€ì´ë¸” CAT6', '305m/ë°•ìŠ¤', 30, 'ë°•ìŠ¤'],
                    ['NET-024', 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', '24í¬íŠ¸, 250W', 5, 'ê°œ'],
                    ['ACC-001', 'ë¸Œë¼ì¼“', 'ë²”ìš©í˜•, ìŠ¤í‹¸', 70, 'ê°œ'],
                    ['ACC-002', 'ì¼€ì´ë¸” íƒ€ì´', '200mm, í°ìƒ‰', 200, 'ê°œ'],
                    ['HDD-4TB', 'HDD 4TB', '4TB, 7200RPM', 10, 'ê°œ']
                ],
                '2': [
                    ['NET-024', 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', '24í¬íŠ¸, 250W', 10, 'ê°œ'],
                    ['CBL-C6', 'UTP ì¼€ì´ë¸” CAT6', '305m/ë°•ìŠ¤', 50, 'ë°•ìŠ¤'],
                    ['ACC-002', 'ì¼€ì´ë¸” íƒ€ì´', '200mm, í°ìƒ‰', 50, 'ê°œ']
                ],
                '3': [
                    ['ACC-001', 'ë¸Œë¼ì¼“', 'ë²”ìš©í˜•, ìŠ¤í‹¸', 10, 'ê°œ'],
                    ['ACC-002', 'ì¼€ì´ë¸” íƒ€ì´', '200mm, í°ìƒ‰', 100, 'ê°œ']
                ]
            };
            
            const materials = setData[selectedSetId] || [];
            
            // ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
            const editModal = document.getElementById('editOrderModal');
            if (editModal && editModal.classList.contains('active')) {
                // ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ì— ìì¬ ì¶”ê°€
                const tbody = document.getElementById('editMaterialList');
                materials.forEach(([code, name, spec, qty, unit]) => {
                    // ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì¸ì§€ í™•ì¸
                    const existingRows = tbody.querySelectorAll('tr.draggable-row');
                    let alreadyExists = false;
                    for (let row of existingRows) {
                        const nameCell = row.querySelector('td:nth-child(3)');
                        if (nameCell && nameCell.textContent.trim() === name) {
                            alreadyExists = true;
                            break;
                        }
                    }
                    if (!alreadyExists) {
                        tbody.insertAdjacentHTML('beforeend',
                            '<tr draggable="true" class="draggable-row">' +
                                '<td style="cursor:move;color:var(--gray-400);text-align:center">â‹®â‹®</td>' +
                                '<td><strong>' + code + '</strong></td>' +
                                '<td>' + name + '</td>' +
                                '<td>' + spec + '</td>' +
                                '<td><input type="number" class="form-input" value="' + qty + '" min="1" style="padding:0.25rem"></td>' +
                                '<td>' + unit + '</td>' +
                                '<td><select class="form-select" style="padding:0.25rem;font-size:0.875rem"><option value="new" selected>ì‹ í’ˆ</option><option value="used">ì¤‘ê³ </option></select></td>' +
                                '<td><button type="button" class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="this.closest(\'tr\').remove(); initEditDragAndDrop();">ì‚­ì œ</button></td>' +
                            '</tr>'
                        );
                    }
                });
                initEditDragAndDrop();
                alert('âœ… ì„¸íŠ¸ê°€ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!\nìˆ˜ëŸ‰ì„ ì¡°ì •í•˜ê±°ë‚˜ ìì¬ë¥¼ ì¶”ê°€/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                // ë°œì£¼ ë“±ë¡ í™”ë©´ì— ìì¬ ì¶”ê°€
                materials.forEach(([code, name, spec, qty, unit]) => {
                    // MATERIALSì— ì—†ì„ ê²½ìš°ë„ ëŒ€ë¹„í•´ì„œ ì¶”ê°€
                    if (!MATERIALS.find(m => m.code === code)) {
                        MATERIALS.push({ code, name, spec, unit, category: 'ë¶€ìì¬', useYn: 'Y', serialTracking: false });
                    }
                    addMaterialToRegister(code, qty);
                });
                alert('âœ… ì„¸íŠ¸ê°€ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!\nìˆ˜ëŸ‰ì„ ì¡°ì •í•˜ê±°ë‚˜ ìì¬ë¥¼ ì¶”ê°€/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            closeSetSelectModal();
        }
        
        document.getElementById('regOrderNote')?.addEventListener('input', markRegisterDirty);
        
        // ì´ˆê¸° ë Œë”
        renderMaterialSearchResults();
        updateRegisterSummary();
        
        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); });
        
        // ë°œì£¼ ìˆ˜ì • ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìë™ ì´ˆê¸°í™”
        const editOrderModal = document.getElementById('editOrderModal');
        if (editOrderModal) {
            const observer = new MutationObserver(function(mutations) {
                if (editOrderModal.classList.contains('active')) {
                    setTimeout(initEditDragAndDrop, 100);
                }
            });
            observer.observe(editOrderModal, { attributes: true, attributeFilter: ['class'] });
        }
    </script>
</body>
</html>
