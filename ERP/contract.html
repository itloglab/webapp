<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>견적 관리 - 건설 자재 ERP</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav class="nav">
        <a href="dashboard.html">📊 대시보드</a>
        <a href="contract.html" class="active">📋 견적</a>
        <a href="inventory.html">📦 재고</a>
        <a href="order.html">📝 발주</a>
        <a href="receiving.html">📥 입고</a>
        <a href="shipment.html">🚚 출고</a>
        <!-- <a href="purchase.html">🛒 구매</a> -->
        <a href="as.html">🔧 AS</a>
        <a href="materials.html">📁 자재정보</a>
        <a href="project.html">📊 현장 통합 현황</a>
    </nav>

    <main class="main">
        <div class="search-box">
            <div class="search-row">
                <select class="filter-select">
                    <option>상태 전체</option>
                    <option>견적</option>
                    <option>수주</option>
                    <option>발주</option>
                    <option>완료</option>
                </select>
                <div style="display:flex;gap:0.5rem;flex:1;min-width:200px">
                    <input type="text" class="search-input" placeholder="견적/본사/현장명 검색..." style="flex:1">
                    <button class="btn btn-primary" onclick="handleSearch()">검색</button>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">초기화</button>
            </div>
        </div>

        <div class="summary-box" style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;flex-wrap:wrap;gap:1.5rem">
                <span class="summary-item">전체: <strong>45건</strong></span>
                <span class="summary-item">견적: <strong>8건</strong></span>
                <span class="summary-item">수주: <strong>15건</strong></span>
                <span class="summary-item">발주: <strong>19건</strong></span>
                <span class="summary-item">완료: <strong>3건</strong></span>
            </div>
            <button class="btn btn-primary" id="actionContractAddBtn" onclick="openContractAddModal()" style="white-space:nowrap">+ 새 견적 등록</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>견적 번호</th>
                        <th>견적명</th>
                        <th>본사</th>
                        <th>현장</th>
                        <th>금액</th>
                        <th>진행률</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr onclick="showDetail('order')" style="cursor:pointer">
                        <td><strong>QT260110-01</strong></td>
                        <td>강남 오피스텔 CCTV 설치</td>
                        <td>대우건설</td>
                        <td>강남 오피스텔</td>
                        <td>150M</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <div class="progress-bar" style="width:60px">
                                    <div class="progress-fill" style="width:80%"></div>
                                </div><span style="font-size:0.75rem">80%</span>
                            </div>
                        </td>
                        <td><span class="status-badge status-active">발주</span></td>
                        <td onclick="event.stopPropagation()">
                            <div style="display:flex;gap:0.5rem">
                                <button class="btn btn-primary btn-sm" onclick="openStatusChangeModal(this, event)">상태변경</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewQuoteDocument('QT260110-01', event)">견적서 보기</button>
                            </div>
                        </td>
                    </tr>
                    <tr onclick="showDetail('order')" style="cursor:pointer">
                        <td><strong>QT260115-01</strong></td>
                        <td>판교 공장 센서 설치</td>
                        <td>현대건설</td>
                        <td>판교 테크노밸리</td>
                        <td>200M</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <div class="progress-bar" style="width:60px">
                                    <div class="progress-fill medium" style="width:60%"></div>
                                </div><span style="font-size:0.75rem">60%</span>
                            </div>
                        </td>
                        <td><span class="status-badge status-active">발주</span></td>
                        <td onclick="event.stopPropagation()">
                            <div style="display:flex;gap:0.5rem">
                                <button class="btn btn-primary btn-sm" onclick="openStatusChangeModal(this, event)">상태변경</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewQuoteDocument('QT260115-01', event)">견적서 보기</button>
                            </div>
                        </td>
                    </tr>
                    <tr onclick="showDetail('approved')" style="cursor:pointer">
                        <td><strong>QT260118-01</strong></td>
                        <td>인천 물류센터 통합 설치</td>
                        <td>삼성물산</td>
                        <td>인천 물류센터</td>
                        <td>180M</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <div class="progress-bar" style="width:60px">
                                    <div class="progress-fill low" style="width:30%"></div>
                                </div><span style="font-size:0.75rem">30%</span>
                            </div>
                        </td>
                        <td><span class="status-badge status-approved">수주</span></td>
                        <td onclick="event.stopPropagation()">
                            <div style="display:flex;gap:0.5rem">
                                <button class="btn btn-primary btn-sm" onclick="openStatusChangeModal(this, event)">상태변경</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewQuoteDocument('QT260118-01', event)">견적서 보기</button>
                            </div>
                        </td>
                    </tr>
                    <tr onclick="showDetail('quote')" style="cursor:pointer">
                        <td><strong>QT260120-01</strong></td>
                        <td>분당 아파트 CCTV 설치</td>
                        <td>GS건설</td>
                        <td>분당 아파트</td>
                        <td>120M</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <div class="progress-bar" style="width:60px">
                                    <div class="progress-fill low" style="width:0%"></div>
                                </div><span style="font-size:0.75rem">0%</span>
                            </div>
                        </td>
                        <td><span class="status-badge status-pending">견적</span></td>
                        <td onclick="event.stopPropagation()">
                            <div style="display:flex;gap:0.5rem">
                                <button class="btn btn-primary btn-sm" onclick="openStatusChangeModal(this, event)">상태변경</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewQuoteDocument('QT260120-01', event)">견적서 보기</button>
                            </div>
                        </td>
                    </tr>
                    <tr onclick="showDetail('complete')" style="cursor:pointer">
                        <td><strong>QT251215-01</strong></td>
                        <td>서초 빌딩 CCTV 교체</td>
                        <td>대우건설</td>
                        <td>서초 빌딩</td>
                        <td>80M</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <div class="progress-bar" style="width:60px">
                                    <div class="progress-fill" style="width:100%"></div>
                                </div><span style="font-size:0.75rem">100%</span>
                            </div>
                        </td>
                        <td><span class="status-badge status-complete">완료</span></td>
                        <td onclick="event.stopPropagation()">
                            <div style="display:flex;gap:0.5rem">
                                <button class="btn btn-primary btn-sm" onclick="openStatusChangeModal(this, event)">상태변경</button>
                                <button class="btn btn-secondary btn-sm" onclick="viewQuoteDocument('QT251215-01', event)">견적서 보기</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- 현장: 본사 등록 모달 -->
    <div class="modal" id="officeModal">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h2 class="modal-title">🏛️ 본사 등록</h2>
                <button class="close-btn" onclick="closeModal('officeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">본사 코드</label>
                    <input type="text" class="form-input" placeholder="자동 생성" disabled value="HO-004 (자동 생성)">
                </div>
                <div class="form-group">
                    <label class="form-label">본사명 *</label>
                    <input type="text" class="form-input" id="officeName" placeholder="예: 대우건설, 삼성물산">
                </div>
                <div class="form-group">
                    <label class="form-label">비고</label>
                    <input type="text" class="form-input" id="officeNote" placeholder="특이사항">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('officeModal')">취소</button>
                <button class="btn btn-primary" onclick="saveOffice()">등록</button>
            </div>
        </div>
    </div>


    <div class="modal" id="contractDetailModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">📋 견적 상세 - QT260110-01</h2>
                <button class="close-btn" onclick="closeModal('contractDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" data-detail-tab="info" onclick="switchContractDetailTab('info', event)">기본 정보</button>
                    <button class="tab" data-detail-tab="materials" onclick="switchContractDetailTab('materials', event)">자재 진행 현황</button>
                    <button class="tab" data-detail-tab="shipment" onclick="switchContractDetailTab('shipment', event)">출고 이력</button>
                </div>
                <!-- 기본 정보 탭 -->
                <div id="contractDetailInfoTab" class="detail-tab-content">
                    <div class="info-box" id="detailInfo">
                        <div class="info-row"><span class="info-label">견적 번호</span><strong>QT260110-01</strong></div>
                        <div class="info-row" id="orderCodeRow" style="display:none"><span class="info-label">발주
                                코드</span><strong id="orderCode">IT260204-01</strong></div>
                        <div class="info-row"><span class="info-label">견적명</span><strong>강남 오피스텔 CCTV 설치 공사</strong></div>
                        <div class="info-row"><span class="info-label">본사</span><span>대우건설</span></div>
                        <div class="info-row"><span class="info-label">현장</span><span>강남 오피스텔 (SITE-2024-001)</span></div>
                        <div class="info-row"><span class="info-label">소유 구분</span><span>판매</span></div>
                        <div class="info-row"><span class="info-label">품질 구분</span><span>신품</span></div>
                        <div class="info-row"><span class="info-label">현장 유형</span><span>신규</span></div>
                        <div class="info-row"><span class="info-label">영업 담당자</span><span>김영업</span></div>
                        <div class="info-row"><span class="info-label">견적일</span><span>2024-01-10</span></div>
                        <div class="info-row"><span class="info-label">착공/준공 예정</span><span>2024-01-15 ~ 2024-06-30</span>
                        </div>
                        <div class="info-row"><span class="info-label">견적 금액</span><strong
                                style="color:var(--primary)">150,000,000원</strong></div>
                        <div class="info-row"><span class="info-label">상태</span><span class="status-badge status-active"
                                id="statusBadge">발주</span></div>
                    </div>
                    <div class="info-box highlight">
                        <div style="font-weight:600;margin-bottom:0.5rem">📊 진행 현황</div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem"><span>전체
                                진행률</span><strong style="color:var(--primary)">80%</strong></div>
                        <div class="progress-bar" style="height:8px">
                            <div class="progress-fill" style="width:80%"></div>
                        </div>
                        <div style="display:flex;gap:2rem;margin-top:0.75rem;font-size:0.8125rem">
                            <span>자재 출고: <strong>96 / 120개</strong></span>
                            <span>남은 자재: <strong>24개</strong></span>
                        </div>
                    </div>
                    <div style="font-weight:600;margin:1.25rem 0 0.5rem;font-size:0.875rem">📋 상태 이력</div>
                    <div class="table-container" style="box-shadow:none;margin:0">
                        <table>
                            <thead><tr><th style="width:140px">변경일시</th><th style="width:80px">변경 전</th><th style="width:80px">변경 후</th><th style="width:80px">변경자</th><th>비고</th></tr></thead>
                            <tbody id="detailStatusHistory">
                                <tr><td style="font-size:0.8125rem">2024-01-15 10:00</td><td>견적</td><td>수주</td><td>김영업</td><td style="font-size:0.875rem">계약 확정</td></tr>
                                <tr><td style="font-size:0.8125rem">2024-01-16 09:30</td><td>수주</td><td>발주</td><td>이담당</td><td style="font-size:0.875rem">착공에 따른 상태 변경</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 자재 진행 현황 탭 -->
                <div id="contractDetailMaterialsTab" class="detail-tab-content" style="display:none">
                    <!-- 상단 KPI -->
                    <div class="summary-box" style="margin-top:0.5rem">
                        <span class="summary-item">진행률: <strong>80%</strong></span>
                        <span class="summary-item">출고 완료: <strong>96 / 120</strong></span>
                        <span class="summary-item">미출고(잔여): <strong style="color:var(--danger)">24</strong></span>
                        <span class="summary-item">부족(예상): <strong style="color:var(--danger)">6개</strong></span>
                        <span class="summary-item">품목 수: <strong>6종</strong></span>
                    </div>
                    
                    <!-- 전체 테이블(진행 중심 컬럼) -->
                    <div style="font-weight:600;margin:1.25rem 0 0.5rem;font-size:0.875rem">📦 자재 진행 현황</div>
                    <div class="table-container" style="box-shadow:none;margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th>자재</th>
                                    <th style="width:120px">견적 기준</th>
                                    <th style="width:120px">출고</th>
                                    <th style="width:120px">잔여</th>
                                    <th style="width:110px">상태</th>
                                    <th>비고</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>IP카메라 2MP</strong><div style="font-size:0.8125rem;color:var(--gray-500)">2MP, IP67</div></td>
                                    <td>60</td>
                                    <td>48</td>
                                    <td><strong style="color:var(--danger)">12</strong></td>
                                    <td><span class="status-badge status-warning">부분출고</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">납기 확인 필요</td>
                                </tr>
                                <tr>
                                    <td><strong>NVR 16채널</strong><div style="font-size:0.8125rem;color:var(--gray-500)">16CH, H.265</div></td>
                                    <td>10</td>
                                    <td>10</td>
                                    <td>0</td>
                                    <td><span class="status-badge status-ok">출고완료</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">-</td>
                                </tr>
                                <tr>
                                    <td><strong>UTP 케이블</strong><div style="font-size:0.8125rem;color:var(--gray-500)">CAT6, 305m</div></td>
                                    <td>30</td>
                                    <td>24</td>
                                    <td><strong style="color:var(--danger)">6</strong></td>
                                    <td><span class="status-badge status-warning">부분출고</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">추가 출고 예정</td>
                                </tr>
                                <tr>
                                    <td><strong>PoE 스위치 24포트</strong><div style="font-size:0.8125rem;color:var(--gray-500)">24포트, 250W</div></td>
                                    <td>8</td>
                                    <td>2</td>
                                    <td><strong style="color:var(--danger)">6</strong></td>
                                    <td><span class="status-badge status-warning">부족</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">자재팀 확인 필요</td>
                                </tr>
                                <tr>
                                    <td><strong>브라켓</strong><div style="font-size:0.8125rem;color:var(--gray-500)">범용형</div></td>
                                    <td>8</td>
                                    <td>4</td>
                                    <td><strong style="color:var(--danger)">4</strong></td>
                                    <td><span class="status-badge status-pending">미출고</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">출고 요청</td>
                                </tr>
                                <tr>
                                    <td><strong>케이블 타이</strong><div style="font-size:0.8125rem;color:var(--gray-500)">200mm</div></td>
                                    <td>4</td>
                                    <td>8</td>
                                    <td><span style="color:var(--gray-400)">-</span></td>
                                    <td><span class="status-badge status-ok">출고완료</span></td>
                                    <td style="font-size:0.875rem;color:var(--gray-600)">여유분 포함</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td style="font-weight:700">합계</td>
                                    <td style="font-weight:700">120</td>
                                    <td style="font-weight:700">96</td>
                                    <td style="font-weight:700;color:var(--danger)">24</td>
                                    <td colspan="2" style="color:var(--gray-500);font-size:0.8125rem">* 잔여 = 견적 기준 - 출고 (목업)</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- 출고 이력 탭(기존은 분리만) -->
                <div id="contractDetailShipmentTab" class="detail-tab-content" style="display:none">
                    <div class="summary-box">
                        <span class="summary-item">출고 건: <strong>3건</strong></span>
                        <span class="summary-item">완료: <strong>1건</strong></span>
                        <span class="summary-item">진행중: <strong>1건</strong></span>
                        <span class="summary-item">부분출고: <strong>1건</strong></span>
                    </div>
                    
                    <div class="table-container" style="box-shadow:none;margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th>출고 번호</th>
                                    <th style="width:110px">출고일</th>
                                    <th style="width:100px">출고자재</th>
                                    <th style="width:90px">담당자</th>
                                    <th style="width:90px">상태</th>
                                    <th style="width:70px">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 출고 건 1 -->
                                <tr data-shipment="OUT-2024-050" style="cursor:pointer" onclick="toggleShipmentRow('OUT-2024-050')">
                                    <td><strong>OUT-2024-050</strong></td>
                                    <td>2024-02-03</td>
                                    <td>3종 54개</td>
                                    <td>이출고</td>
                                    <td><span class="status-badge status-complete">완료</span></td>
                                    <td onclick="event.stopPropagation()">
                                        <a href="#" class="btn-link" onclick="toggleShipmentRow('OUT-2024-050'); return false;">상세</a>
                                    </td>
                                </tr>
                                <tr id="shipmentDetail-OUT-2024-050" style="display:none;background:var(--gray-50)">
                                    <td colspan="6" style="padding:0.75rem 1rem">
                                        <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">📦 출고 자재</div>
                                        <table style="margin:0">
                                            <thead>
                                                <tr>
                                                    <th>자재명</th>
                                                    <th style="width:140px">규격</th>
                                                    <th style="width:90px">수량</th>
                                                    <th style="width:90px">상태</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>IP카메라 2MP</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">2MP, IP67</td>
                                                    <td>30</td>
                                                    <td><span class="status-badge status-ok">완료</span></td>
                                                </tr>
                                                <tr>
                                                    <td>NVR 16채널</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">16CH, H.265</td>
                                                    <td>10</td>
                                                    <td><span class="status-badge status-ok">완료</span></td>
                                                </tr>
                                                <tr>
                                                    <td>UTP 케이블</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">CAT6, 305m</td>
                                                    <td>14</td>
                                                    <td><span class="status-badge status-ok">완료</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                
                                <!-- 출고 건 2 -->
                                <tr data-shipment="OUT-2024-049" style="cursor:pointer" onclick="toggleShipmentRow('OUT-2024-049')">
                                    <td><strong>OUT-2024-049</strong></td>
                                    <td>2024-02-02</td>
                                    <td>2종 26개</td>
                                    <td>이출고</td>
                                    <td><span class="status-badge status-active">진행중</span></td>
                                    <td onclick="event.stopPropagation()">
                                        <a href="#" class="btn-link" onclick="toggleShipmentRow('OUT-2024-049'); return false;">상세</a>
                                    </td>
                                </tr>
                                <tr id="shipmentDetail-OUT-2024-049" style="display:none;background:var(--gray-50)">
                                    <td colspan="6" style="padding:0.75rem 1rem">
                                        <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">📦 출고 자재</div>
                                        <table style="margin:0">
                                            <thead>
                                                <tr>
                                                    <th>자재명</th>
                                                    <th style="width:140px">규격</th>
                                                    <th style="width:90px">수량</th>
                                                    <th style="width:90px">상태</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>IP카메라 2MP</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">2MP, IP67</td>
                                                    <td>18</td>
                                                    <td><span class="status-badge status-active">진행중</span></td>
                                                </tr>
                                                <tr>
                                                    <td>브라켓</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">범용형</td>
                                                    <td>8</td>
                                                    <td><span class="status-badge status-pending">대기</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                
                                <!-- 출고 건 3 -->
                                <tr data-shipment="OUT-2024-048" style="cursor:pointer;background:#FFF8E1" onclick="toggleShipmentRow('OUT-2024-048')">
                                    <td><strong>OUT-2024-048</strong></td>
                                    <td>2024-02-01</td>
                                    <td>1종 5개</td>
                                    <td>이출고</td>
                                    <td><span class="status-badge status-warning">부분출고</span></td>
                                    <td onclick="event.stopPropagation()">
                                        <a href="#" class="btn-link" onclick="toggleShipmentRow('OUT-2024-048'); return false;">상세</a>
                                    </td>
                                </tr>
                                <tr id="shipmentDetail-OUT-2024-048" style="display:none;background:var(--gray-50)">
                                    <td colspan="6" style="padding:0.75rem 1rem">
                                        <div style="font-weight:600;margin-bottom:0.5rem;font-size:0.875rem">📦 출고 자재</div>
                                        <table style="margin:0">
                                            <thead>
                                                <tr>
                                                    <th>자재명</th>
                                                    <th style="width:140px">규격</th>
                                                    <th style="width:90px">수량</th>
                                                    <th style="width:90px">상태</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>UTP 케이블</td>
                                                    <td style="font-size:0.8125rem;color:var(--gray-500)">CAT6, 305m</td>
                                                    <td>5</td>
                                                    <td><span class="status-badge status-warning">부분</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="margin-top:0.5rem;color:var(--gray-500);font-size:0.8125rem">
                            * 출고 건 행을 클릭하거나 “상세”를 누르면 출고 자재가 펼쳐집니다. (목업)
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="detailEditButton"
                    onclick="closeModal('contractDetailModal'); openEditContractModal()">수정</button>
                <button class="btn btn-secondary"
                    onclick="event.stopPropagation(); closeModal('contractDetailModal')">닫기</button>
            </div>
        </div>
    </div>

    <!-- 견적 목록 상태 변경 모달 -->
    <div class="modal" id="statusChangeModal">
        <div class="modal-content" style="max-width:480px">
            <div class="modal-header">
                <h2 class="modal-title">상태 변경 - <span id="statusChangeContractNo">QT260110-01</span></h2>
                <button class="close-btn" onclick="closeStatusChangeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">현재 상태</label>
                    <input type="text" class="form-input" id="statusCurrentValue" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">변경 상태 *</label>
                    <div class="status-pill-group">
                        <label class="status-pill-label">
                            <input type="radio" name="statusNextValue" value="quote" required>
                            <span class="status-pill status-pill-quote">
                                <span class="status-pill-dot"></span>
                                견적
                            </span>
                        </label>
                        <label class="status-pill-label">
                            <input type="radio" name="statusNextValue" value="approved">
                            <span class="status-pill status-pill-approved">
                                <span class="status-pill-dot"></span>
                                수주
                            </span>
                        </label>
                        <label class="status-pill-label">
                            <input type="radio" name="statusNextValue" value="order">
                            <span class="status-pill status-pill-order">
                                <span class="status-pill-dot"></span>
                                발주
                            </span>
                        </label>
                        <label class="status-pill-label">
                            <input type="radio" name="statusNextValue" value="complete">
                            <span class="status-pill status-pill-complete">
                                <span class="status-pill-dot"></span>
                                완료
                            </span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">수정사유 *</label>
                    <textarea class="form-textarea" id="statusChangeNote" rows="3" placeholder="수정사유를 입력해주세요" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStatusChangeModal()">취소</button>
                <button class="btn btn-primary" onclick="submitStatusChange()">저장</button>
            </div>
        </div>
    </div>

    <!-- 견적서 보기 모달 -->
    <div class="modal" id="quoteViewModal">
        <div class="modal-content" style="max-width:fit-content;max-height:90vh;width:auto">
            <div class="modal-header">
                <h2 class="modal-title">견적서 보기 - <span id="quoteViewNo">QT260110-01</span></h2>
                <button class="close-btn" onclick="closeQuoteViewModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:1rem;overflow:auto">
                <img src="quote.png" alt="견적서" id="quoteViewImage" style="max-width:100%;height:auto;border:1px solid var(--gray-300);display:block">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQuoteViewModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- 계약(견적) 수정 모달 -->
    <div class="modal" id="editContractModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">견적 수정 - <span id="editContractNo">QT260110-01</span></h2>
                <button class="close-btn" onclick="closeEditContractModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editContractForm">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">견적명 *</label><input type="text"
                                class="form-input" id="editContractName" value="강남 오피스텔 CCTV 설치 공사" required></div>
                        <div class="form-group"><label class="form-label">견적 유형</label><select class="form-select"
                                id="editContractType">
                                <option value="">선택</option>
                                <option selected>CCTV 설치</option>
                                <option>네트워크 구축</option>
                                <option>센서 설치</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">본사 *</label><select class="form-select"
                                id="editContractOffice" required>
                                <option value="">본사 선택</option>
                                <option selected>대우건설</option>
                                <option>현대건설</option>
                                <option>삼성물산</option>
                                <option>GS건설</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">현장 *</label><select class="form-select"
                                id="editContractSite" required>
                                <option value="">현장 선택</option>
                                <option selected>강남 오피스텔</option>
                                <option>판교 공장</option>
                                <option>인천 물류센터</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">소유 구분</label><select class="form-select"
                                id="editContractOwnership">
                                <option value="">선택</option>
                                <option selected>판매</option>
                                <option>임대</option>
                                <option>바이백</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">품질 구분</label><select class="form-select"
                                id="editContractQuality">
                                <option value="">선택</option>
                                <option selected>신품</option>
                                <option>중고</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">현장 유형 *</label><select class="form-select"
                                id="editContractSiteType" required>
                                <option value="">선택</option>
                                <option selected>신규</option>
                                <option>이전설치</option>
                                <option>유지보수</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">견적일 *</label><input type="date"
                                class="form-input" id="editContractDate" value="2024-01-10" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">견적 금액 *</label><input type="number"
                                class="form-input" id="editContractAmount" value="150000000" required></div>
                        <div class="form-group"><label class="form-label">상태</label><select class="form-select"
                                id="editContractStatus">
                                <option value="quote">견적</option>
                                <option value="approved">수주</option>
                                <option value="order" selected>발주</option>
                                <option value="complete">완료</option>
                            </select></div>
                    </div>
                    <div class="form-group"><label class="form-label">비고</label><textarea class="form-textarea"
                            id="editContractScope" placeholder="작업 범위 및 상세 내용">CCTV 카메라 60대 설치, 관제실 구축, 네트워크 배선 공사</textarea></div>
                    <div class="form-group"><label class="form-label">수정 사유 *</label><textarea class="form-textarea"
                            id="editContractReason" placeholder="수정 사유를 입력해주세요" rows="3" required></textarea></div>
                    <div class="form-group">
                        <label class="form-label">견적서 파일 (이미지/PDF/Excel)</label>
                        <input type="file" class="form-input" accept="image/*,.pdf,.xlsx,.xls" multiple
                            onchange="previewImages(this, 'editImagePreview')">
                        <div id="editImagePreview" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditContractModal()">취소</button>
                <button class="btn btn-primary" onclick="submitEditContract()">저장</button>
            </div>
        </div>
    </div>

    <div class="modal" id="contractAddModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">새 견적 등록</h2>
                <button class="close-btn" onclick="closeModal('contractAddModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="contractForm">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">견적명 *</label><input type="text"
                                class="form-input" placeholder="예: 강남 오피스텔 CCTV 설치" required></div>
                        <div class="form-group"><label class="form-label">견적 유형</label><select class="form-select">
                                <option value="">선택</option>
                                <option>CCTV 설치</option>
                                <option>네트워크 구축</option>
                                <option>센서 설치</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">본사 *</label><select class="form-select"
                                required>
                                <option value="">본사 선택</option>
                                <option>대우건설</option>
                                <option>현대건설</option>
                                <option>삼성물산</option>
                                <option>GS건설</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">현장 *</label><select class="form-select"
                                required>
                                <option value="">현장 선택</option>
                                <option>강남 오피스텔</option>
                                <option>판교 공장</option>
                                <option>인천 물류센터</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">소유 구분</label><select class="form-select">
                                <option value="">선택</option>
                                <option>판매</option>
                                <option>임대</option>
                                <option>바이백</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">품질 구분</label><select class="form-select">
                                <option value="">선택</option>
                                <option>신품</option>
                                <option>중고</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">현장 유형 *</label><select class="form-select"
                                required>
                                <option value="">선택</option>
                                <option>신규</option>
                                <option>이전설치</option>
                                <option>유지보수</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">견적일</label><input type="date"
                                class="form-input"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">견적 금액</label><input type="number"
                                class="form-input" placeholder="150000000"></div>
                    </div>
                    <div class="form-group"><label class="form-label">비고</label><textarea class="form-textarea"
                            placeholder="작업 범위 및 상세 내용"></textarea></div>
                    <div class="form-group">
                        <label class="form-label">견적서 파일 (이미지/PDF/Excel)</label>
                        <input type="file" class="form-input" accept="image/*,.pdf,.xlsx,.xls" multiple
                            onchange="previewImages(this)">
                        <div id="imagePreview" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('contractAddModal')">취소</button>
                <button class="btn btn-success" onclick="submitForm()">등록</button>
            </div>
        </div>
    </div>

    <script>

        // 현장 탭
        function openOfficeModal() { document.getElementById('officeModal').classList.add('active'); }
        function openSiteAddModal() {
            document.getElementById('addOffice').value = '';
            document.getElementById('addSiteSelectWrap').style.display = 'none';
            document.getElementById('addClient').value = '';
            document.getElementById('siteAddModal').classList.add('active');
        }
        function onAddOfficeChange() {
            var office = document.getElementById('addOffice').value;
            var wrap = document.getElementById('addSiteSelectWrap');
            var client = document.getElementById('addClient');
            if (office) { wrap.style.display = 'block'; client.value = office; } else { wrap.style.display = 'none'; client.value = ''; }
        }
        function openSiteEditModal(siteCode) {
            document.getElementById('editSiteCode').textContent = siteCode;
            document.getElementById('siteEditModal').classList.add('active');
        }
        function showSiteDetail(siteCode) {
            document.getElementById('detailSiteCode').textContent = siteCode;
            document.getElementById('detailCode').textContent = siteCode;
            document.getElementById('siteDetailModal').classList.add('active');
        }
        function saveOffice() {
            var name = document.getElementById('officeName').value.trim();
            if (!name) { alert('본사명을 입력해주세요.'); return; }
            if (confirm('본사를 등록하시겠습니까?')) {
                alert('✅ 본사가 등록되었습니다!\n본사: ' + name);
                closeModal('officeModal');
            }
        }
        function saveSite() {
            var office = document.getElementById('addOffice').value;
            if (!office) { alert('본사를 선택해주세요.'); return; }
            if (confirm('새 현장을 등록하시겠습니까?\n본사: ' + office)) {
                alert('✅ 현장이 등록되었습니다!\n현장 코드: SITE-006');
                closeModal('siteAddModal');
            }
        }
        function updateSite() {
            if (confirm('현장 정보를 수정하시겠습니까?')) {
                alert('✅ 현장 정보가 수정되었습니다.');
                closeModal('siteEditModal');
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        let currentStatus = 'order';

        function showDetail(status) {
            currentStatus = status;
            const modal = document.getElementById('contractDetailModal');
            const statusBadge = document.getElementById('statusBadge');
            const orderCodeRow = document.getElementById('orderCodeRow');

            // 상태별 UI 업데이트
            if (status === 'quote') {
                statusBadge.className = 'status-badge status-pending';
                statusBadge.textContent = '견적';
                orderCodeRow.style.display = 'none';
            } else if (status === 'approved') {
                statusBadge.className = 'status-badge status-approved';
                statusBadge.textContent = '수주';
                orderCodeRow.style.display = 'flex';
            } else if (status === 'order') {
                statusBadge.className = 'status-badge status-active';
                statusBadge.textContent = '발주';
                orderCodeRow.style.display = 'flex';
            } else if (status === 'complete') {
                statusBadge.className = 'status-badge status-complete';
                statusBadge.textContent = '완료';
                orderCodeRow.style.display = 'flex';
            }

            modal.classList.add('active');
            // 기본 정보 탭으로 초기화
            switchContractDetailTab('info');
        }

        function handleAction(event) {
            if (event) event.stopPropagation();
            if (currentStatus === 'quote') {
                if (confirm('수주를 확정하시겠습니까?\n발주코드가 자동 생성됩니다.')) {
                    const orderCode = generateOrderCode();
                    alert(`✅ 수주가 확정되었습니다!\n발주코드: ${orderCode}`);
                    currentStatus = 'approved';
                    showDetail('approved');
                }
                return;
            }
            if (currentStatus === 'approved') {
                if (confirm('상태를 "발주"로 변경하시겠습니까?')) {
                    alert('✅ 상태가 발주로 변경되었습니다.');
                    currentStatus = 'order';
                    showDetail('order');
                }
                return;
            }
            if (currentStatus === 'order') {
                if (confirm('상태를 "완료"로 변경하시겠습니까?')) {
                    alert('✅ 상태가 완료로 변경되었습니다.');
                    currentStatus = 'complete';
                    showDetail('complete');
                }
                return;
            }
        }

        function switchContractDetailTab(tab, event) {
            if (event) event.stopPropagation();
            document.querySelectorAll('#contractDetailModal .tabs .tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#contractDetailModal .detail-tab-content').forEach(c => c.style.display = 'none');

            const btn = document.querySelector(`#contractDetailModal .tabs .tab[data-detail-tab="${tab}"]`);
            if (btn) btn.classList.add('active');

            if (tab === 'materials') {
                document.getElementById('contractDetailMaterialsTab').style.display = 'block';
            } else if (tab === 'shipment') {
                document.getElementById('contractDetailShipmentTab').style.display = 'block';
            } else {
                document.getElementById('contractDetailInfoTab').style.display = 'block';
            }

            // 기본 정보 탭에서만 수정 버튼 표시
            const editBtn = document.getElementById('detailEditButton');
            if (editBtn) {
                editBtn.style.display = tab === 'info' ? 'inline-flex' : 'none';
            }
        }

        function toggleShipmentRow(shipmentNo) {
            const row = document.getElementById('shipmentDetail-' + shipmentNo);
            if (!row) return;
            const isOpen = row.style.display !== 'none';
            row.style.display = isOpen ? 'none' : 'table-row';
        }

        function openContractAddModal() { document.getElementById('contractAddModal').classList.add('active'); }

        let statusChangeTargetRow = null;

        function generateOrderCode() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const seq = '01'; // 실제로는 서버에서 순번 관리
            const code = `IT${year}${month}${day}-${seq}`;
            document.getElementById('orderCode').textContent = code;
            return code;
        }


        function openEditContractModal() {
            const editForm = document.getElementById('editContractForm');
            if (editForm) editForm.reset();
            const editPreview = document.getElementById('editImagePreview');
            if (editPreview) editPreview.innerHTML = '';
            // 목업 기본값 재설정
            document.getElementById('editContractName').value = '강남 오피스텔 CCTV 설치 공사';
            document.getElementById('editContractType').value = 'CCTV 설치';
            document.getElementById('editContractOffice').value = '대우건설';
            document.getElementById('editContractSite').value = '강남 오피스텔';
            document.getElementById('editContractOwnership').value = '판매';
            // 수정 사유 필드 초기화
            const editContractReason = document.getElementById('editContractReason');
            if (editContractReason) editContractReason.value = '';
            document.getElementById('editContractQuality').value = '신품';
            document.getElementById('editContractSiteType').value = '신규';
            document.getElementById('editContractDate').value = '2024-01-10';
            document.getElementById('editContractAmount').value = '150000000';
            document.getElementById('editContractScope').value = 'CCTV 카메라 60대 설치, 관제실 구축, 네트워크 배선 공사';
            document.getElementById('editContractModal').classList.add('active');
        }
        function closeEditContractModal() { document.getElementById('editContractModal').classList.remove('active'); }
        function submitEditContract() {
            const form = document.getElementById('editContractForm');
            if (form && !form.checkValidity()) {
                form.reportValidity();
                return;
            }
            // 수정 사유 필수 검증
            const editContractReason = document.getElementById('editContractReason');
            if (editContractReason && !editContractReason.value.trim()) {
                alert('수정 사유를 입력해주세요.');
                editContractReason.focus();
                return;
            }
            alert('✅ 견적 정보가 수정되었습니다.');
            closeEditContractModal();
        }

        function getStatusMeta(statusKey) {
            const map = {
                quote: { text: '견적', badgeClass: 'status-pending' },
                approved: { text: '수주', badgeClass: 'status-approved' },
                order: { text: '발주', badgeClass: 'status-active' },
                complete: { text: '완료', badgeClass: 'status-complete' }
            };
            return map[statusKey] || map.quote;
        }

        function getStatusKeyFromText(statusText) {
            if (statusText === '견적') return 'quote';
            if (statusText === '수주') return 'approved';
            if (statusText === '발주') return 'order';
            if (statusText === '완료') return 'complete';
            return 'quote';
        }

        function viewQuoteDocument(quoteNo, event) {
            if (event) event.stopPropagation();
            document.getElementById('quoteViewNo').textContent = quoteNo;
            document.getElementById('quoteViewModal').classList.add('active');
        }

        function closeQuoteViewModal() {
            document.getElementById('quoteViewModal').classList.remove('active');
        }

        function openStatusChangeModal(trigger, event) {
            if (event) event.stopPropagation();
            statusChangeTargetRow = trigger.closest('tr');
            if (!statusChangeTargetRow) return;

            const contractNo = statusChangeTargetRow.querySelector('td:first-child strong')?.textContent || '-';
            const badge = statusChangeTargetRow.querySelector('td:nth-child(7) .status-badge');
            const currentText = badge ? badge.textContent.trim() : '견적';
            const currentKey = getStatusKeyFromText(currentText);

            document.getElementById('statusChangeContractNo').textContent = contractNo;
            document.getElementById('statusCurrentValue').value = currentText;
            const nextRadio = document.querySelector(`input[name="statusNextValue"][value="${currentKey}"]`);
            if (nextRadio) nextRadio.checked = true;
            document.getElementById('statusChangeNote').value = '';
            document.getElementById('statusChangeModal').classList.add('active');
        }

        function closeStatusChangeModal() {
            document.getElementById('statusChangeModal').classList.remove('active');
            statusChangeTargetRow = null;
        }

        function submitStatusChange() {
            if (!statusChangeTargetRow) return;

            const checkedStatus = document.querySelector('input[name="statusNextValue"]:checked');
            const nextKey = checkedStatus ? checkedStatus.value : '';
            if (!nextKey) {
                alert('변경 상태를 선택해주세요.');
                const firstRadio = document.querySelector('input[name="statusNextValue"]');
                if (firstRadio) firstRadio.focus();
                return;
            }

            const note = document.getElementById('statusChangeNote').value.trim();
            if (!note) {
                alert('수정사유를 입력해주세요.');
                document.getElementById('statusChangeNote').focus();
                return;
            }
            const meta = getStatusMeta(nextKey);

            const statusCell = statusChangeTargetRow.querySelector('td:nth-child(7)');
            if (statusCell) {
                statusCell.innerHTML = `<span class="status-badge ${meta.badgeClass}">${meta.text}</span>`;
            }

            statusChangeTargetRow.setAttribute('onclick', `showDetail('${nextKey}')`);
            const detailLink = statusChangeTargetRow.querySelector('a.btn-link');
            if (detailLink) {
                detailLink.setAttribute('onclick', `showDetail('${nextKey}')`);
            }

            const contractNo = statusChangeTargetRow.querySelector('td:first-child strong')?.textContent || '';
            const noteText = note ? `\n수정사유: ${note}` : '';
            alert(`✅ 상태가 변경되었습니다.\n견적번호: ${contractNo}\n변경 상태: ${meta.text}${noteText}`);
            closeStatusChangeModal();
        }

        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); });

        function previewImages(input, targetId = 'imagePreview') {
            const preview = document.getElementById(targetId);
            if (!preview) return;
            preview.innerHTML = '';
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.innerHTML += `<div style="position:relative"><img src="${e.target.result}" style="width:80px;height:80px;object-fit:cover;border-radius:4px;border:1px solid var(--gray-200)"><button type="button" onclick="this.parentElement.remove()" style="position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:12px;cursor:pointer">×</button></div>`;
                };
                reader.readAsDataURL(file);
            });
        }

        function submitForm() { alert('✅ 견적이 등록되었습니다!'); closeModal('contractAddModal'); }

        function handleSearch() {
            const searchInput = document.querySelector('.search-input');
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('검색어를 입력해주세요.');
                return;
            }
            // 검색 로직 (목업)
            alert('🔍 검색 기능: ' + keyword);
        }

        function resetFilters() {
            const searchInput = document.querySelector('.search-input');
            const filterSelects = document.querySelectorAll('.filter-select');
            
            if (searchInput) searchInput.value = '';
            filterSelects.forEach(select => {
                select.selectedIndex = 0;
            });
            alert('✅ 필터가 초기화되었습니다.');
        }
    </script>
</body>

</html>