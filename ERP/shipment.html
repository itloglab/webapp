<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê³  ê´€ë¦¬ - ê±´ì„¤ ìì¬ ERP</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .contract-select-grid {
            display: grid;
            grid-template-columns: 1.5fr 1.2fr 1.2fr 1fr;
            gap: 1rem;
            align-items: start;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s;
        }
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--gray-50);
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .autocomplete-item-info {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }
        @media (max-width: 1200px) {
            .contract-select-grid {
                grid-template-columns: 1fr 2fr;
            }
            .contract-select-grid > div:nth-child(n+3) {
                grid-column: span 2;
            }
        }
        @media (max-width: 768px) {
            .contract-select-grid {
                grid-template-columns: 1fr;
            }
            .contract-select-grid > div:nth-child(n+3) {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="dashboard.html">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
        <a href="contract.html">ğŸ“‹ ê²¬ì </a>
        <a href="inventory.html">ğŸ“¦ ì¬ê³ </a>
        <a href="order.html">ğŸ“ ë°œì£¼</a>
        <a href="receiving.html">ğŸ“¥ ì…ê³ </a>
        <a href="shipment.html" class="active">ğŸšš ì¶œê³ </a>
        <!-- <a href="purchase.html">ğŸ›’ êµ¬ë§¤</a> -->
        <a href="as.html">ğŸ”§ AS</a>
        <a href="materials.html">ğŸ“ ìì¬ì •ë³´</a>
        <a href="project.html">ğŸ“Š í˜„ì¥ í†µí•© í˜„í™©</a>
    </nav>
    
    <main class="main">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">ì¶œê³  ëª©ë¡</button>
            <button class="tab" onclick="switchTab('register')">ì¶œê³  ë“±ë¡</button>
        </div>
        
        <!-- ì¶œê³  ëª©ë¡ íƒ­ -->
        <div id="listTab" class="tab-content">
            <div class="search-box">
                <div class="search-row">
                    <select class="filter-select">
                        <option>ìƒíƒœ ì „ì²´</option>
                        <option>ì™„ë£Œ</option>
                        <option>ì§„í–‰ì¤‘</option>
                    </select>
                    <select class="filter-select">
                        <option>í˜„ì¥ ì „ì²´</option>
                        <option>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</option>
                        <option>íŒêµ ê³µì¥</option>
                        <option>ì¸ì²œ ë¬¼ë¥˜ì„¼í„°</option>
                    </select>
                    <select class="filter-select">
                        <option>ê¸°ê°„ ì „ì²´</option>
                        <option>ì˜¤ëŠ˜</option>
                        <option>ì´ë²ˆ ì£¼</option>
                        <option>ì´ë²ˆ ë‹¬</option>
                    </select>
                    <div style="display:flex;gap:0.5rem;flex:1;min-width:200px">
                        <input type="text" class="search-input" placeholder="ì¶œê³ ë²ˆí˜¸/ë°œì£¼ë²ˆí˜¸/ìì¬ëª… ê²€ìƒ‰..." style="flex:1">
                        <button class="btn btn-primary" onclick="handleSearch()">ê²€ìƒ‰</button>
                    </div>
                    <label style="display:flex;align-items:center;gap:0.375rem;font-size:0.8125rem;white-space:nowrap">
                        <input type="checkbox" id="preShipmentOnly" onchange="filterPreShipment()"> ì„ ì¶œê³ ë§Œ ë³´ê¸°
                    </label>
                    <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="summary-box" style="display:flex;justify-content:space-between;align-items:center">
                <div style="display:flex;flex-wrap:wrap;gap:1.5rem">
                    <span class="summary-item">ì „ì²´: <strong>85ê±´</strong></span>
                    <span class="summary-item">ì™„ë£Œ: <strong>72ê±´</strong></span>
                    <span class="summary-item">ì§„í–‰ì¤‘: <strong>13ê±´</strong></span>
                    <span class="summary-item">ì´ˆê³¼ì¶œê³ : <strong>3ê±´</strong></span>
                </div>
                <button class="btn btn-primary" onclick="switchTab('register')" style="white-space:nowrap">+ ì‹ ê·œ ì¶œê³ </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ì¶œê³  ë²ˆí˜¸</th>
                            <th>ë°œì£¼</th>
                            <th>í˜„ì¥</th>
                            <th>ìì¬</th>
                            <th>ì¶œê³ ì¼</th>
                            <th>ë‹´ë‹¹ì</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="showDetail('OUT-2024-050')" style="cursor:pointer">
                            <td><strong>OUT-2024-050</strong></td>
                            <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                            <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                            <td>3ì¢… 54ê°œ</td>
                            <td>2024-02-03</td>
                            <td>ì´ì¶œê³ </td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary btn-sm" onclick="openShipmentConfirmModal('OUT-2024-050')">ì¶œê³ í™•ì¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="printShipmentDocument('OUT-2024-050')">ì¶œê³ ì¦ ì¶œë ¥</button>
                            </td>
                        </tr>
                        <tr onclick="showDetail('OUT-2024-049')" style="cursor:pointer">
                            <td><strong>OUT-2024-049</strong></td>
                            <td><span class="status-badge status-warning">ì„ ì¶œê³ </span></td>
                            <td>íŒêµ ê³µì¥</td>
                            <td>5ì¢… 120ê°œ</td>
                            <td>2024-02-02</td>
                            <td>ì´ì¶œê³ </td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary btn-sm" onclick="openShipmentConfirmModal('OUT-2024-049')">ì¶œê³ í™•ì¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="printShipmentDocument('OUT-2024-049')">ì¶œê³ ì¦ ì¶œë ¥</button>
                            </td>
                        </tr>
                        <tr onclick="showDetail('OUT-2024-048')" style="cursor:pointer" style="background:#FFF8E1">
                            <td><strong>OUT-2024-048</strong></td>
                            <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                            <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                            <td>1ì¢… 5ê°œ</td>
                            <td>2024-02-01</td>
                            <td>ì´ì¶œê³ </td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary btn-sm" onclick="openShipmentConfirmModal('OUT-2024-048')">ì¶œê³ í™•ì¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="printShipmentDocument('OUT-2024-048')">ì¶œê³ ì¦ ì¶œë ¥</button>
                            </td>
                        </tr>
                        <tr onclick="showDetail('OUT-2024-047')" style="cursor:pointer">
                            <td><strong>OUT-2024-047</strong></td>
                            <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260120-01</a></td>
                            <td>ì¸ì²œ ë¬¼ë¥˜ì„¼í„°</td>
                            <td>8ì¢… 200ê°œ</td>
                            <td>2024-01-30</td>
                            <td>ê¹€ì¶œê³ </td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary btn-sm" onclick="openShipmentConfirmModal('OUT-2024-047')">ì¶œê³ í™•ì¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="printShipmentDocument('OUT-2024-047')">ì¶œê³ ì¦ ì¶œë ¥</button>
                            </td>
                        </tr>
                        <tr onclick="showDetail('OUT-2024-046')" style="cursor:pointer">
                            <td><strong>OUT-2024-046</strong></td>
                            <td><a href="#" class="btn-link" onclick="event.stopPropagation()">IT260115-01</a></td>
                            <td>ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</td>
                            <td>2ì¢… 30ê°œ</td>
                            <td>2024-01-28</td>
                            <td>ì´ì¶œê³ </td>
                            <td onclick="event.stopPropagation()">
                                <button class="btn btn-primary btn-sm" onclick="openShipmentConfirmModal('OUT-2024-046')">ì¶œê³ í™•ì¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="printShipmentDocument('OUT-2024-046')">ì¶œê³ ì¦ ì¶œë ¥</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <button class="page-btn">â—€</button>
                    <button class="page-btn active">1</button>
                    <button class="page-btn">2</button>
                    <button class="page-btn">3</button>
                    <button class="page-btn">â–¶</button>
                </div>
            </div>
        </div>
        
        <!-- ì¶œê³  ë“±ë¡ íƒ­ -->
        <div id="registerTab" class="tab-content" style="display:none">
            <div class="card">
                <div class="card-header" style="padding:0.5rem 1rem"><span class="card-title" style="font-size:0.9375rem">ğŸ“ ì¶œê³  ê¸°ë³¸ì •ë³´</span></div>
                <div class="card-body" style="padding:0.75rem 1rem">
                    <!-- í•œ ì¤„ ë°°ì¹˜: ê²€ìƒ‰(2) + í˜„ì¥/ë°œì£¼ ì„ íƒ + ìµœê·¼ ë°œì£¼ ê±´(1) -->
                    <div class="contract-select-grid" style="display:grid;grid-template-columns:1.5fr 1.2fr 1.2fr 1fr;gap:1rem;align-items:start">
                        <!-- ì¢Œì¸¡: í†µí•© ê²€ìƒ‰ -->
                        <div>
                            <label class="form-label" style="margin-bottom:0.375rem">ğŸ” ê²€ìƒ‰</label>
                            <div style="position:relative">
                                <input type="text" class="form-input" id="shipOrderSearch" placeholder="ë³¸ì‚¬, í˜„ì¥ ë˜ëŠ” ë°œì£¼ë²ˆí˜¸ ê²€ìƒ‰..." oninput="handleOrderSearch()" onfocus="handleOrderSearch()" onkeydown="handleOrderSearchKeydown(event)" onblur="setTimeout(() => hideOrderSearchResults(), 200)">
                                <div id="orderSearchResults" class="autocomplete-dropdown" style="display:none"></div>
                            </div>
                        </div>
                        
                        <!-- ì¤‘ì•™: í˜„ì¥ ì„ íƒ -->
                        <div class="form-group" style="margin-bottom:0">
                            <label class="form-label">í˜„ì¥ ì„ íƒ *</label>
                            <select class="form-select" id="shipSiteSelect" onchange="loadShipmentSite()">
                                <option value="">í˜„ì¥ ì„ íƒ</option>
                                <option value="ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”">ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” (ê°•ë‚¨ê±´ì„¤)</option>
                                <option value="ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥">íŒêµ ê³µì¥ (ì‚¼ì„±ë¬¼ì‚°)</option>
                                <option value="ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°">ì¸ì²œ ë¬¼ë¥˜ì„¼í„° (ì¸ì²œê±´ì„¤)</option>
                            </select>
                        </div>
                        
                        <!-- ì¤‘ì•™: ë°œì£¼ ì„ íƒ -->
                        <div class="form-group" style="margin-bottom:0">
                            <label class="form-label">ë°œì£¼ ì„ íƒ *</label>
                            <select class="form-select" id="shipOrderSelect" onchange="loadShipmentOrder()" disabled>
                                <option value="">í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            </select>
                        </div>
                        
                        <!-- ìš°ì¸¡: ìµœê·¼ ë°œì£¼ ê±´ -->
                        <div>
                            <label class="form-label" style="margin-bottom:0.375rem">ğŸ“‹ ìµœê·¼ ë°œì£¼ ê±´ (2ì£¼ ì´ë‚´)</label>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openRecentOrdersModal()" style="width:100%;font-size:0.8125rem;padding:0.5rem 0.75rem;white-space:nowrap;text-align:center">
                                ìµœê·¼ ë°œì£¼ ê±´ ì„ íƒ
                            </button>
                        </div>
                    </div>
                    <div class="info-box highlight" id="orderInfo" style="display:none;margin-top:0.5rem;padding:0.5rem 0.75rem;font-size:0.8125rem">
                        <div style="font-weight:600;margin-bottom:0.5rem">ğŸ“‹ ë°œì£¼ ì •ë³´</div>
                        <div style="font-size:0.875rem;margin-bottom:0.75rem" id="orderInfoDetails">
                            <!-- ë°œì£¼ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <div style="font-size:0.8125rem;color:var(--gray-500)" id="orderProgressDetails">
                            <!-- ë°œì£¼ ì§„í–‰ë¥  ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top:1rem">
                <div class="card-header"><span class="card-title">ğŸ“ ì¶œê³  ì •ë³´</span></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ì¶œê³  ë²ˆí˜¸</label>
                            <input type="text" class="form-input" value="OUT-2024-051 (ìë™ ìƒì„±)" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì¶œê³  ì¼ì‹œ *</label>
                            <input type="datetime-local" class="form-input" id="shipmentDate" value="2024-02-03T14:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë¹„ê³ </label>
                        <input type="text" class="form-input" id="shipmentNote" placeholder="ì¶œê³  ê´€ë ¨ íŠ¹ì´ì‚¬í•­">
                    </div>
                    <div class="form-group" id="preShipmentReasonGroup" style="display:none">
                        <label class="form-label">ì„ ì¶œê³  ì‚¬ìœ  *</label>
                        <input type="text" class="form-input" id="preShipmentReason" placeholder="ì„ ì¶œê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
                    </div>
                </div>
            </div>
            
            <div class="card" id="asMaterialContainer" style="margin-top:1rem;display:none">
                <div class="card-header">
                    <span class="card-title">ğŸ”§ AS ì¶œê³  ìì¬ ì„ íƒ (ASê±´ì´ ìˆëŠ” ê²½ìš°ë§Œ ë…¸ì¶œ)</span>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addSelectedAsMaterials()">ì¶œê³  ëª©ë¡ì— ì¶”ê°€</button>
                </div>
                <div class="card-body">
                    <div style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:0.75rem" id="asMaterialCaption">
                        í•´ë‹¹ í˜„ì¥ì˜ AS ìì¬ë¥¼ ì„ íƒí•´ ì¶œê³  ìì¬ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <div class="table-container" style="box-shadow:none;margin:0">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:40px"></th>
                                    <th>ìì¬ ì½”ë“œ</th>
                                    <th>ìì¬ëª…</th>
                                    <th>ê·œê²©</th>
                                    <th style="width:90px">AS ì…ê³  ìˆ˜ëŸ‰</th>
                                    <th style="width:120px">ì¶œê³  ìˆ˜ëŸ‰</th>
                                    <th style="width:120px">êµì²´ì¶œê³  ì—¬ë¶€</th>
                                     <th style="width:90px">í’ˆì§ˆ</th>
                                    <th style="width:90px">ì‹œë¦¬ì–¼</th>
                                </tr>
                            </thead>
                            <tbody id="asMaterialList">
                                <tr>
                                     <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                        í˜„ì¥ì„ ì„ íƒí•˜ë©´ AS ìì¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top:1rem">
                <div class="card-header">
                    <span class="card-title">ğŸ“¦ ì¶œê³  ìì¬ ì„ íƒ</span>
                </div>
                <div class="card-body">
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                        <div style="flex:1;position:relative">
                            <input type="text" class="form-input" id="materialSearch" placeholder="ìì¬ ì½”ë“œ, ìì¬ëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..." style="width:100%" autocomplete="off" oninput="handleMaterialSearch()" onkeydown="handleMaterialKeydown(event)" onfocus="handleMaterialFocus()" onblur="setTimeout(() => hideMaterialAutocomplete(), 200)">
                            <div id="materialAutocomplete" class="autocomplete-dropdown" style="display:none"></div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="addMaterial()">+ ìì¬ ì¶”ê°€</button>
                    </div>
                    <div class="table-container" style="box-shadow:none">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìì¬ ì½”ë“œ</th>
                                    <th>ìì¬ëª…</th>
                                    <th>ê·œê²©</th>
                                    <th>ë°œì£¼/ì¶œê³ </th>
                                    <th style="width:120px">ì¶œê³  ìˆ˜ëŸ‰</th>
                                    <th style="width:90px">í’ˆì§ˆ</th>
                                    <th style="width:90px">ì‹œë¦¬ì–¼ ì—¬ë¶€</th>
                                    <th style="width:100px">ì‹œë¦¬ì–¼</th>
                                    <th style="width:50px">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="materialList">
                                <tr>
                                    <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                        ë°œì£¼ë¥¼ ì„ íƒí•˜ë©´ ì¶œê³  ìì¬ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.25rem">
                <button class="btn btn-secondary" onclick="switchTab('list')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmShipment()">ì¶œê³  ë“±ë¡</button>
            </div>
        </div>
    </main>
    
    <!-- ì¶œê³  ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="detailModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">ğŸšš ì¶œê³  ìƒì„¸ - <span id="detailShipmentNo">OUT-2024-050</span></h2>
                <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-row"><span class="info-label">ì¶œê³  ë²ˆí˜¸</span><strong id="detailNo">OUT-2024-050</strong></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼</span><a href="#" class="btn-link" id="detailOrder">IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜</a></div>
                    <div class="info-row"><span class="info-label">í˜„ì¥</span><span id="detailSite">ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</span></div>
                    <div class="info-row"><span class="info-label">ì¶œê³ ì¼</span><span id="detailDate">2024-02-03 14:00</span></div>
                    <div class="info-row"><span class="info-label">ë‹´ë‹¹ì</span><span id="detailUser">ì´ì¶œê³ </span></div>
                    <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="status-badge status-complete" id="detailStatus">ì™„ë£Œ</span></div>
                </div>
                
                <div id="overOrderReasonBox" style="display:none">
                    <div class="info-box" style="background:#FFF8E1;border:1px solid var(--warning)">
                        <div style="font-weight:600;color:var(--warning);margin-bottom:0.25rem">âš ï¸ ì´ˆê³¼ ì¶œê³ </div>
                        <div style="font-size:0.875rem" id="detailOverReason">í˜„ì¥ ì¶”ê°€ ìš”ì²­ìœ¼ë¡œ ì¸í•œ ê¸´ê¸‰ ì¶œê³ </div>
                    </div>
                </div>
                
                <div style="font-weight:600;margin:1rem 0 0.5rem;font-size:0.875rem">ğŸ“¦ ì¶œê³  ìì¬</div>
                <table>
                    <thead>
                        <tr>
                            <th>ìì¬ ì½”ë“œ</th>
                            <th>ìì¬ëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ì†Œìœ êµ¬ë¶„</th>
                            <th>í’ˆì§ˆ</th>
                            <th>ì‹œë¦¬ì–¼</th>
                        </tr>
                    </thead>
                    <tbody id="detailMaterials">
                        <tr>
                            <td><strong>CAM-001</strong></td>
                            <td>IPì¹´ë©”ë¼ 2MP</td>
                            <td>30ê°œ</td>
                            <td>ì†Œìœ </td>
                            <td>ì‹ í’ˆ</td>
                            <td><a href="#" class="btn-link" onclick="showSerialList()">30ê°œ ë³´ê¸°</a></td>
                        </tr>
                        <tr>
                            <td><strong>NVR-001</strong></td>
                            <td>NVR 16ì±„ë„</td>
                            <td>5ê°œ</td>
                            <td>ì†Œìœ </td>
                            <td>ì‹ í’ˆ</td>
                            <td><a href="#" class="btn-link" onclick="showSerialList()">5ê°œ ë³´ê¸°</a></td>
                        </tr>
                        <tr>
                            <td><strong>CBL-001</strong></td>
                            <td>UTP ì¼€ì´ë¸”</td>
                            <td>10ë°•ìŠ¤</td>
                            <td>ì†Œìœ </td>
                            <td>ì‹ í’ˆ</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
                <button class="btn btn-primary">ì¶œê³ ì¦ ì¶œë ¥</button>
            </div>
        </div>
    </div>

    <!-- ì¶œê³  í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="confirmModal">
        <div class="modal-content lg">
            <div class="modal-header">
                <h2 class="modal-title">âœ… ì¶œê³  í™•ì¸ - <span id="confirmShipmentNo">OUT-2024-050</span></h2>
                <button class="close-btn" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-row"><span class="info-label">ì¶œê³  ë²ˆí˜¸</span><strong id="confirmDetailNo">OUT-2024-050</strong></div>
                    <div class="info-row"><span class="info-label">ë°œì£¼</span><a href="#" class="btn-link" id="confirmDetailOrder">IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜</a></div>
                    <div class="info-row"><span class="info-label">í˜„ì¥</span><span id="confirmDetailSite">ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</span></div>
                    <div class="info-row"><span class="info-label">ì¶œê³ ì¼</span><span id="confirmDetailDate">2024-02-03 14:00</span></div>
                    <div class="info-row"><span class="info-label">ë‹´ë‹¹ì</span><span id="confirmDetailUser">ì´ì¶œê³ </span></div>
                </div>

                <div style="font-weight:600;margin:1rem 0 0.5rem;font-size:0.875rem">ğŸ“¦ ì¶œê³  ìì¬</div>
                <table>
                    <thead>
                        <tr>
                            <th>ìì¬ ì½”ë“œ</th>
                            <th>ìì¬ëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>í’ˆì§ˆ</th>
                            <th>ì‹œë¦¬ì–¼</th>
                        </tr>
                    </thead>
                    <tbody id="confirmDetailMaterials">
                        <tr>
                            <td><strong>CAM-001</strong></td>
                            <td>IPì¹´ë©”ë¼ 2MP</td>
                            <td>30ê°œ</td>
                            <td>ì‹ í’ˆ</td>
                            <td><a href="#" class="btn-link" onclick="showSerialList();return false;">30ê°œ ë³´ê¸°</a></td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top:1.5rem">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                        <label class="form-label" style="margin-bottom:0">ì¶œê³  í™•ì¸ ì„œëª…</label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">ì§€ìš°ê¸°</button>
                    </div>
                    <div style="border:1px solid var(--gray-300);border-radius:8px;padding:0.5rem;background:#fafafa">
                        <canvas id="signaturePad" width="600" height="160" style="width:100%;height:160px;display:block;background:#fff;border-radius:4px;cursor:crosshair"></canvas>
                        <div style="margin-top:0.25rem;font-size:0.75rem;color:var(--gray-500)">ë§ˆìš°ìŠ¤ ë˜ëŠ” í„°ì¹˜ë¡œ ì„œëª…í•´ ì£¼ì„¸ìš”.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="submitShipmentConfirm()">ì¶œê³ í™•ì¸ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ì‹œë¦¬ì–¼ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="serialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì‹œë¦¬ì–¼ ì„ íƒ - <span id="serialMaterialName">IPì¹´ë©”ë¼ 2MP</span></h2>
                <button class="close-btn" onclick="closeModal('serialModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box highlight" style="margin-bottom:1rem">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>ì¶œê³  ìˆ˜ëŸ‰: <strong id="serialQty">4</strong>ê°œ</div>
                        <button class="btn btn-sm btn-secondary" onclick="selectAllSerials()">ì „ì²´ ì„ íƒ</button>
                    </div>
                </div>
                
                <div style="max-height:300px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:6px">
                    <table style="margin:0">
                        <thead style="position:sticky;top:0;background:#fff">
                            <tr>
                                <th style="width:40px"></th>
                                <th>ì‹œë¦¬ì–¼ ë²ˆí˜¸</th>
                                <th>ìœ„ì¹˜</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="serialList">
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-001</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-002</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-003</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check" checked></td>
                                <td><strong>CAM-2024-004</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-005</strong></td>
                                <td>ë³¸ì‚¬ì°½ê³  A-01-03</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-006</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-007</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-01</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="serial-check"></td>
                                <td><strong>CAM-2024-008</strong></td>
                                <td>ê°•ë‚¨ì°½ê³  B-01-02</td>
                                <td><span class="status-badge status-ok">ì •ìƒ</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="info-box" style="margin-top:1rem;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        ì„ íƒ: <strong id="selectedCount">4</strong>ê°œ / ì¶œê³ ìˆ˜ëŸ‰: <strong id="requiredCount">4</strong>ê°œ
                    </div>
                    <div id="serialMatchStatus">
                        <span style="color:var(--success);font-weight:600">âœ… ì¼ì¹˜</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('serialModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmSerialSelection()">ì„ íƒ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ìµœê·¼ ë°œì£¼ ê±´ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="recentOrdersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“‹ ìµœê·¼ ë°œì£¼ ê±´ ì„ íƒ</h2>
                <button class="close-btn" onclick="closeModal('recentOrdersModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;flex-direction:column;gap:0.5rem">
                    <button type="button" class="btn btn-secondary" onclick="selectRecentOrderFromModal('IT260115-01')" style="font-size:0.875rem;padding:0.75rem;text-align:left;justify-content:flex-start">
                        <div style="font-weight:600;margin-bottom:0.25rem">IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)">ê°•ë‚¨ê±´ì„¤ > ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”</div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="selectRecentOrderFromModal('IT260118-01')" style="font-size:0.875rem;padding:0.75rem;text-align:left;justify-content:flex-start">
                        <div style="font-weight:600;margin-bottom:0.25rem">IT260118-01 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)">ì‚¼ì„±ë¬¼ì‚° > íŒêµ ê³µì¥</div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="selectRecentOrderFromModal('IT260120-01')" style="font-size:0.875rem;padding:0.75rem;text-align:left;justify-content:flex-start">
                        <div style="font-weight:600;margin-bottom:0.25rem">IT260120-01 - ì¸ì²œ ë¬¼ë¥˜ì„¼í„° í†µí•© ì„¤ì¹˜</div>
                        <div style="font-size:0.8125rem;color:var(--gray-600)">ì¸ì²œê±´ì„¤ > ì¸ì²œ ë¬¼ë¥˜ì„¼í„°</div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('recentOrdersModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ì‹œë¦¬ì–¼ ëª©ë¡ ë³´ê¸° ëª¨ë‹¬ (ìƒì„¸ì—ì„œ ì‚¬ìš©) -->
    <div class="modal" id="serialListModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì¶œê³  ì‹œë¦¬ì–¼ ëª©ë¡</h2>
                <button class="close-btn" onclick="closeModal('serialListModal')">&times;</button>
            </div>
            <div class="modal-body">
                <table>
                    <thead>
                        <tr>
                            <th>ì‹œë¦¬ì–¼ ë²ˆí˜¸</th>
                            <th>ìì¬ëª…</th>
                            <th>ì¶œê³  ìœ„ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><strong>CAM-2024-015</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>ë³¸ì‚¬ì°½ê³  A-01-01</td></tr>
                        <tr><td><strong>CAM-2024-016</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>ë³¸ì‚¬ì°½ê³  A-01-01</td></tr>
                        <tr><td><strong>CAM-2024-017</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>ë³¸ì‚¬ì°½ê³  A-01-02</td></tr>
                        <tr><td><strong>CAM-2024-018</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>ë³¸ì‚¬ì°½ê³  A-01-02</td></tr>
                        <tr><td><strong>CAM-2024-019</strong></td><td>IPì¹´ë©”ë¼ 2MP</td><td>ë³¸ì‚¬ì°½ê³  A-01-03</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('serialListModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentSerialMaterial = null;
        let requiredQty = 0;
        let orderSearchSelectedIndex = -1;
        
        // ë°œì£¼ ë°ì´í„° êµ¬ì¡°
        const ORDERS_DATA = {
            'ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”': {
                company: 'ê°•ë‚¨ê±´ì„¤',
                site: 'ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”',
                orders: [
                    { 
                        value: 'IT260115-01', 
                        text: 'IT260115-01 - ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…” CCTV ì„¤ì¹˜',
                        contract: 'CT-2024-001',
                        progress: 80,
                        materials: [
                            { name: 'IPì¹´ë©”ë¼ 2MP', ordered: 120, shipped: 116, remaining: 4, unit: 'ê°œ' },
                            { name: 'NVR 16ì±„ë„', ordered: 10, shipped: 10, remaining: 0, unit: 'ê°œ' },
                            { name: 'UTP ì¼€ì´ë¸”', ordered: 50, shipped: 30, remaining: 20, unit: 'ë°•ìŠ¤' }
                        ]
                    }
                ]
            },
            'ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥': {
                company: 'ì‚¼ì„±ë¬¼ì‚°',
                site: 'íŒêµ ê³µì¥',
                orders: [
                    { 
                        value: 'IT260118-01', 
                        text: 'IT260118-01 - íŒêµ ê³µì¥ ì„¼ì„œ ì„¤ì¹˜',
                        contract: 'CT-2024-002',
                        progress: 60,
                        materials: [
                            { name: 'ì˜¨ë„ ì„¼ì„œ', ordered: 20, shipped: 12, remaining: 8, unit: 'ê°œ' }
                        ]
                    }
                ]
            },
            'ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°': {
                company: 'ì¸ì²œê±´ì„¤',
                site: 'ì¸ì²œ ë¬¼ë¥˜ì„¼í„°',
                orders: [
                    { 
                        value: 'IT260120-01', 
                        text: 'IT260120-01 - ì¸ì²œ ë¬¼ë¥˜ì„¼í„° í†µí•© ì„¤ì¹˜',
                        contract: 'CT-2024-003',
                        progress: 40,
                        materials: [
                            { name: 'IPì¹´ë©”ë¼ 2MP', ordered: 80, shipped: 32, remaining: 48, unit: 'ê°œ' },
                            { name: 'NVR 32ì±„ë„', ordered: 5, shipped: 2, remaining: 3, unit: 'ê°œ' }
                        ]
                    }
                ]
            }
        };
        
        const ALL_ORDERS = [];
        Object.keys(ORDERS_DATA).forEach(key => {
            const data = ORDERS_DATA[key];
            data.orders.forEach(order => {
                ALL_ORDERS.push({
                    ...order,
                    key: key,
                    searchText: `${data.company} ${data.site} ${order.text}`.toLowerCase()
                });
            });
        });

        // í˜„ì¥ë³„ AS ìì¬(ëª©ì—…)
        const AS_MATERIALS_BY_SITE = {
            'ê°•ë‚¨ê±´ì„¤_ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”': [
                { code: 'CAM-AS-001', name: 'IPì¹´ë©”ë¼ 2MP (AS)', spec: '2MP, IP67', requestQty: 3, unit: 'ê°œ', serial: true },
                { code: 'NVR-AS-016', name: 'NVR 16ì±„ë„ (AS)', spec: '16CH, H.265', requestQty: 1, unit: 'ê°œ', serial: true }
            ],
            'ì‚¼ì„±ë¬¼ì‚°_íŒêµ ê³µì¥': [
                { code: 'SEN-AS-001', name: 'ì˜¨ë„ ì„¼ì„œ (AS)', spec: 'ì‚°ì—…ìš©, -40~85C', requestQty: 5, unit: 'ê°œ', serial: false }
            ],
            'ì¸ì²œê±´ì„¤_ì¸ì²œ ë¬¼ë¥˜ì„¼í„°': []
        };

        // ì¶œê³  ìì¬ ê²€ìƒ‰ìš© ë§ˆìŠ¤í„° ìì¬ (ìì¬ ë§ˆìŠ¤í„°ì™€ ë™ì¼ ë°ì´í„°)
        const SHIPMENT_MATERIALS = [
            { code: 'CAM-001', name: 'IPì¹´ë©”ë¼ 2MP ì‹¤ì™¸í˜•', spec: '2MP, 1920x1080, IR 30m, IP67', unit: 'ê°œ', category: 'CCTV', serialTracking: true },
            { code: 'CAM-002', name: 'IPì¹´ë©”ë¼ 4MP ì‹¤ë‚´ìš©', spec: '4MP, 2560x1440, WDR, ì‹¤ë‚´ìš© ë”', unit: 'ê°œ', category: 'CCTV', serialTracking: true },
            { code: 'CAM-003', name: 'IPì¹´ë©”ë¼ 5MP ì‹¤ì™¸í˜•', spec: '5MP, 2592x1944, IR 40m, IP67', unit: 'ê°œ', category: 'CCTV', serialTracking: true },
            { code: 'NVR-016', name: 'NVR 16ì±„ë„', spec: '16CH, H.265, 2Bay', unit: 'ê°œ', category: 'ë…¹í™”ê¸°', serialTracking: true },
            { code: 'NVR-032', name: 'NVR 32ì±„ë„', spec: '32CH, H.265, 4Bay', unit: 'ê°œ', category: 'ë…¹í™”ê¸°', serialTracking: true },
            { code: 'MON-032', name: '32ì¸ì¹˜ ëª¨ë‹ˆí„°', spec: '32\", FHD, ë²½ê±¸ì´/ìŠ¤íƒ ë“œ ê²¸ìš©', unit: 'ê°œ', category: 'ëª¨ë‹ˆí„°', serialTracking: false },
            { code: 'SW-024P', name: 'PoE ìŠ¤ìœ„ì¹˜ 24í¬íŠ¸', spec: '24í¬íŠ¸ PoE, 250W, ê¸°ê°€ë¹„íŠ¸', unit: 'ê°œ', category: 'ë„¤íŠ¸ì›Œí¬', serialTracking: false },
            { code: 'SW-008P', name: 'PoE ìŠ¤ìœ„ì¹˜ 8í¬íŠ¸', spec: '8í¬íŠ¸ PoE, 120W, ê¸°ê°€ë¹„íŠ¸', unit: 'ê°œ', category: 'ë„¤íŠ¸ì›Œí¬', serialTracking: false },
            { code: 'CBL-C6-305', name: 'UTP ì¼€ì´ë¸” CAT6', spec: 'CAT6, 305m/Box, LSZH', unit: 'ë°•ìŠ¤', category: 'ì¼€ì´ë¸”', serialTracking: false },
            { code: 'CBL-C5E-305', name: 'UTP ì¼€ì´ë¸” CAT5E', spec: 'CAT5E, 305m/Box, PVC', unit: 'ë°•ìŠ¤', category: 'ì¼€ì´ë¸”', serialTracking: false },
            { code: 'BRKT-CAM-UNV', name: 'ì¹´ë©”ë¼ ë²½ë¶€ ë¸Œë¼ì¼“', spec: 'ì•Œë£¨ë¯¸ëŠ„, ë²”ìš©í˜•', unit: 'ê°œ', category: 'ë¶€ìì¬', serialTracking: false },
            { code: 'BRKT-POLE', name: 'ì¹´ë©”ë¼ í´ ë¸Œë¼ì¼“', spec: 'í´ ë§ˆìš´íŠ¸, ìŠ¤í…Œì¸ë¦¬ìŠ¤ ë°´ë“œ í¬í•¨', unit: 'ê°œ', category: 'ë¶€ìì¬', serialTracking: false },
            { code: 'TIE-200W', name: 'ì¼€ì´ë¸” íƒ€ì´ 200mm', spec: '200mm, ë°±ìƒ‰, 100EA/PK', unit: 'íŒ©', category: 'ë¶€ìì¬', serialTracking: false },
            { code: 'TIE-300B', name: 'ì¼€ì´ë¸” íƒ€ì´ 300mm', spec: '300mm, í‘ìƒ‰, 100EA/PK', unit: 'íŒ©', category: 'ë¶€ìì¬', serialTracking: false },
            { code: 'JBOX-150', name: 'ë°©ìˆ˜ ì ê²€í•¨ 150x150', spec: '150x150x70, IP66', unit: 'ê°œ', category: 'ë¶€ìì¬', serialTracking: false },
            { code: 'CON-UTP', name: 'UTP RJ45 ì»¤ë„¥í„°', spec: 'CAT6, 100EA/PK', unit: 'íŒ©', category: 'ì»¤ë„¥í„°', serialTracking: false },
            { code: 'PS-48V-2A', name: '48V 2A ì–´ëŒ‘í„°', spec: '48V DC, 2A, í”ŒëŸ¬ê·¸í˜•', unit: 'ê°œ', category: 'ì „ì›', serialTracking: false },
            { code: 'HDD-4TB', name: 'HDD 4TB', spec: '4TB, 3.5\", 7200RPM', unit: 'ê°œ', category: 'ì €ì¥ì¥ì¹˜', serialTracking: true },
            { code: 'SEN-TEMP', name: 'ì˜¨ë„ ì„¼ì„œ', spec: ' -40~85â„ƒ, MODBUS RTU', unit: 'ê°œ', category: 'ì„¼ì„œ', serialTracking: true },
            { code: 'SEN-HUMI', name: 'ì˜¨ìŠµë„ ì„¼ì„œ', spec: '0~100%RH, -20~60â„ƒ, RS-485', unit: 'ê°œ', category: 'ì„¼ì„œ', serialTracking: true }
        ];

        let materialAutocompleteIndex = -1;
        let materialAutocompleteItems = [];
        
        function loadShipmentSite() {
            const siteKey = document.getElementById('shipSiteSelect').value;
            const orderSelect = document.getElementById('shipOrderSelect');
            const orderInfo = document.getElementById('orderInfo');
            
            // ë°œì£¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            orderSelect.innerHTML = '<option value="">ë°œì£¼ ì„ íƒ</option>';
            orderSelect.disabled = !siteKey;
            
            if (!siteKey) {
                orderInfo.style.display = 'none';
                return;
            }
            
            const siteData = ORDERS_DATA[siteKey];
            // ì„ ì¶œê³ ëŠ” í˜„ì¥ ì„ íƒ í›„ í•­ìƒ ì„ íƒ ê°€ëŠ¥
            orderSelect.insertAdjacentHTML('beforeend', '<option value="PRE_SHIPMENT">ì„ ì¶œê³ </option>');
            if (!siteData || !siteData.orders || siteData.orders.length === 0) {
                orderInfo.style.display = 'none';
            } else {
                siteData.orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.value;
                    option.textContent = order.text;
                    orderSelect.appendChild(option);
                });
            }
            
            // ê¸°ì¡´ ë°œì£¼ ì •ë³´ ìˆ¨ê¸°ê¸°
            orderInfo.style.display = 'none';
            orderSelect.value = '';
            renderAsMaterialList();
        }
        
        function loadShipmentOrder() {
            const siteKey = document.getElementById('shipSiteSelect').value;
            const orderId = document.getElementById('shipOrderSelect').value;
            const orderInfo = document.getElementById('orderInfo');
            const orderInfoDetails = document.getElementById('orderInfoDetails');
            const orderProgressDetails = document.getElementById('orderProgressDetails');
            const preShipmentReasonGroup = document.getElementById('preShipmentReasonGroup');
            const materialTbody = document.getElementById('materialList');
            
            if (!orderId || !siteKey) {
                orderInfo.style.display = 'none';
                if (preShipmentReasonGroup) preShipmentReasonGroup.style.display = 'none';
                if (materialTbody) {
                    materialTbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                ë°œì£¼ë¥¼ ì„ íƒí•˜ë©´ ì¶œê³  ìì¬ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤.
                            </td>
                        </tr>`;
                }
                return;
            }
            
            const siteData = ORDERS_DATA[siteKey];
            if (!siteData) {
                orderInfo.style.display = 'none';
                if (preShipmentReasonGroup) preShipmentReasonGroup.style.display = 'none';
                if (materialTbody) {
                    materialTbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                ì¶œê³  ìì¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>`;
                }
                return;
            }

            if (orderId === 'PRE_SHIPMENT') {
                orderInfoDetails.innerHTML = `ê²¬ì : <strong>-</strong> | í˜„ì¥: <strong>${siteData.site}</strong> | ë°œì£¼ì²˜: <strong>${siteData.company}</strong> | ì§„í–‰ë¥ : <strong style="color:var(--gray-500)">-</strong>`;
                orderProgressDetails.innerHTML = '<div>â€¢ ì„ ì¶œê³  ê±´ì…ë‹ˆë‹¤. ì¶œê³  ìì¬ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                orderInfo.style.display = 'block';
                if (preShipmentReasonGroup) preShipmentReasonGroup.style.display = 'block';
                if (materialTbody) {
                    materialTbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                ì„ ì¶œê³  ê±´ì…ë‹ˆë‹¤. ìš°ì¸¡ ê²€ìƒ‰ì„ í†µí•´ ì¶œê³  ìì¬ë¥¼ ì§ì ‘ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                            </td>
                        </tr>`;
                }
                return;
            }
            const order = siteData.orders.find(o => o.value === orderId);
            
            if (order) {
                // ë°œì£¼ ì •ë³´ ì—…ë°ì´íŠ¸
                orderInfoDetails.innerHTML = `ê²¬ì : <strong>${order.contract}</strong> | í˜„ì¥: <strong>${siteData.site}</strong> | ë°œì£¼ì²˜: <strong>${siteData.company}</strong> | ì§„í–‰ë¥ : <strong style="color:var(--primary)">${order.progress}%</strong>`;
                
                // ë°œì£¼ ì§„í–‰ë¥  ì •ë³´ ì—…ë°ì´íŠ¸
                let progressHtml = '';
                order.materials.forEach(material => {
                    if (material.remaining > 0) {
                        progressHtml += `<div>â€¢ ${material.name}: ${material.ordered}${material.unit} ì¤‘ ${material.shipped}${material.unit} ì¶œê³  (<strong style="color:var(--danger)">ë‚¨ì€ ${material.remaining}${material.unit}</strong>)</div>`;
                    } else {
                        progressHtml += `<div>â€¢ ${material.name}: ${material.ordered}${material.unit} ì¤‘ ${material.shipped}${material.unit} ì¶œê³  (ì™„ë£Œ)</div>`;
                    }
                });
                orderProgressDetails.innerHTML = progressHtml;
                orderInfo.style.display = 'block';
                if (preShipmentReasonGroup) preShipmentReasonGroup.style.display = 'none';
                
                // ë°œì£¼ ìì¬ë¥¼ ì¶œê³  ìì¬ ëª©ë¡ìœ¼ë¡œ ìë™ ë¡œë“œ
                if (materialTbody) {
                    materialTbody.innerHTML = '';
                    order.materials.forEach(material => {
                        const master = SHIPMENT_MATERIALS.find(m => m.name === material.name) || {};
                        const code = master.code || '-';
                        const spec = master.spec || '-';
                        const unit = master.unit || material.unit || '';
                        const shipped = typeof material.shipped === 'number'
                            ? material.shipped
                            : (material.ordered - (material.remaining || 0));
                        const remaining = material.remaining != null ? material.remaining : 0;
                        const defaultQty = remaining > 0 ? remaining : 1;
                        const serialTracking = !!master.serialTracking;
                        const materialId = `ORD-${order.value}-${code}`;
                        
                        materialTbody.insertAdjacentHTML('beforeend', `
                            <tr data-material="${materialId}">
                                <td><strong>${code}</strong></td>
                                <td>${material.name}</td>
                                <td style="font-size:0.8125rem;color:var(--gray-500)">${spec}</td>
                                <td>${material.ordered} / ${shipped}</td>
                                <td>
                                    <div style="display:flex;align-items:center;gap:0.25rem">
                                        <input type="number" class="form-input" value="${defaultQty}" min="1" style="padding:0.25rem;width:60px" onchange="checkOverOrder(this, ${remaining}, '${unit}')">
                                        <span style="font-size:0.8125rem;color:var(--gray-500)">${unit}</span>
                                    </div>
                                </td>
                                <td>
                                    <select class="form-select" style="padding:0.25rem;font-size:0.8125rem">
                                        <option>ì‹ í’ˆ</option>
                                        <option>ì¤‘ê³ </option>
                                    </select>
                                </td>
                                <td>
                                    <input type="checkbox" ${serialTracking ? '' : ''} onchange="toggleSerialButton(this)">
                                </td>
                                <td>
                                    ${serialTracking
                                        ? `<button class="btn btn-sm btn-secondary serial-select-btn" onclick="openSerialModal('${code}', '${material.name}', ${defaultQty})" disabled>ì„ íƒ</button>`
                                        : '<span style="color:var(--gray-500);font-size:0.75rem">-</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="removeMaterialRow(this)">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `);
                    });
                }
            } else {
                orderInfo.style.display = 'none';
                if (materialTbody) {
                    materialTbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">
                                ì¶œê³  ìì¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>`;
                }
            }
        }
        
        function selectRecentOrder(orderId) {
            let foundOrder = null;
            let foundKey = null;
            
            Object.keys(ORDERS_DATA).forEach(key => {
                const siteData = ORDERS_DATA[key];
                const order = siteData.orders.find(o => o.value === orderId);
                if (order) {
                    foundOrder = order;
                    foundKey = key;
                }
            });
            
            if (!foundOrder || !foundKey) return;
            
            // ë“œë¡­ë‹¤ìš´ì— ìë™ ì„ íƒ
            document.getElementById('shipSiteSelect').value = foundKey;
            loadShipmentSite();
            
            setTimeout(() => {
                document.getElementById('shipOrderSelect').value = orderId;
                loadShipmentOrder();
            }, 50);
        }
        
        // í†µí•© ê²€ìƒ‰ ê¸°ëŠ¥
        function handleOrderSearch() {
            const query = document.getElementById('shipOrderSearch').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('orderSearchResults');
            
            if (!query) {
                resultsDiv.style.display = 'none';
                orderSearchSelectedIndex = -1;
                return;
            }
            
            const results = ALL_ORDERS.filter(order => 
                order.searchText.includes(query)
            ).slice(0, 10); // ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);text-align:center;padding:1rem">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            resultsDiv.innerHTML = '';
            results.forEach((order, index) => {
                const siteData = ORDERS_DATA[order.key];
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.dataset.index = index;
                item.onclick = () => selectOrderFromSearch(order.key, order.value);
                item.onmouseover = () => highlightOrderSearchItem(index);
                
                item.innerHTML = `
                    <div class="autocomplete-item-name">${order.text}</div>
                    <div class="autocomplete-item-info">${siteData.company} > ${siteData.site}</div>
                `;
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.style.display = 'block';
            orderSearchSelectedIndex = -1;
        }
        
        function handleOrderSearchKeydown(event) {
            const resultsDiv = document.getElementById('orderSearchResults');
            const items = resultsDiv.querySelectorAll('.autocomplete-item');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                orderSearchSelectedIndex = Math.min(orderSearchSelectedIndex + 1, items.length - 1);
                highlightOrderSearchItem(orderSearchSelectedIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                orderSearchSelectedIndex = Math.max(orderSearchSelectedIndex - 1, -1);
                highlightOrderSearchItem(orderSearchSelectedIndex);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (orderSearchSelectedIndex >= 0 && items[orderSearchSelectedIndex]) {
                    items[orderSearchSelectedIndex].click();
                }
            } else if (event.key === 'Escape') {
                hideOrderSearchResults();
            }
        }
        
        function highlightOrderSearchItem(index) {
            const items = document.querySelectorAll('#orderSearchResults .autocomplete-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            orderSearchSelectedIndex = index;
        }
        
        function selectOrderFromSearch(siteKey, orderId) {
            document.getElementById('shipSiteSelect').value = siteKey;
            loadShipmentSite();
            
            setTimeout(() => {
                document.getElementById('shipOrderSelect').value = orderId;
                loadShipmentOrder();
            }, 50);
            
            // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            document.getElementById('shipOrderSearch').value = '';
            hideOrderSearchResults();
        }
        
        function hideOrderSearchResults() {
            document.getElementById('orderSearchResults').style.display = 'none';
            orderSearchSelectedIndex = -1;
        }

        function renderAsMaterialList() {
            const siteKey = document.getElementById('shipSiteSelect').value;
            const container = document.getElementById('asMaterialContainer');
            const tbody = document.getElementById('asMaterialList');
            const caption = document.getElementById('asMaterialCaption');

            if (!siteKey) {
                container.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">í˜„ì¥ì„ ì„ íƒí•˜ë©´ AS ìì¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                return;
            }

            container.style.display = 'block';
            const list = AS_MATERIALS_BY_SITE[siteKey] || [];
            if (!list.length) {
                caption.textContent = 'í•´ë‹¹ í˜„ì¥ì— ì¶œê³  ê°€ëŠ¥í•œ AS ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--gray-500);padding:1.5rem">í‘œì‹œí•  AS ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            caption.textContent = 'í•´ë‹¹ í˜„ì¥ì˜ AS ìì¬ë¥¼ ì„ íƒí•´ ì¶œê³  ìì¬ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            tbody.innerHTML = '';
            list.forEach(material => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-as-code="${material.code}">
                        <td style="text-align:center"><input type="checkbox" class="as-material-check"></td>
                        <td><strong>${material.code}</strong></td>
                        <td>${material.name}</td>
                        <td style="font-size:0.8125rem;color:var(--gray-500)">${material.spec}</td>
                        <td>${material.requestQty}</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.25rem">
                                <input type="number" class="form-input as-shipment-qty" value="${material.requestQty}" min="1" max="${material.requestQty}" style="padding:0.25rem;width:70px">
                                <span style="font-size:0.8125rem;color:var(--gray-500)">${material.unit}</span>
                            </div>
                        </td>
                        <td>
                            <select class="form-select as-shipment-type" style="padding:0.25rem;font-size:0.8125rem">
                                <option value="ì¬ì¶œê³ " selected>ì¬ì¶œê³ </option>
                                <option value="êµì²´ì¶œê³ ">êµì²´ì¶œê³ </option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select as-material-quality" style="padding:0.25rem;font-size:0.8125rem">
                                <option value="ì¤‘ê³ " selected>ì¤‘ê³ </option>
                                <option value="ì‹ í’ˆ">ì‹ í’ˆ</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-secondary" style="padding:0.25rem 0.5rem" ${material.serial ? '' : 'disabled'}>ì„ íƒ</button>
                        </td>
                    </tr>
                `);
            });
        }

        function addSelectedAsMaterials() {
            const siteKey = document.getElementById('shipSiteSelect').value;
            if (!siteKey) return alert('í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');

            const list = AS_MATERIALS_BY_SITE[siteKey] || [];
            const rows = Array.from(document.querySelectorAll('#asMaterialList tr[data-as-code]'));
            const selected = rows.filter(row => {
                const cb = row.querySelector('.as-material-check');
                return cb && cb.checked;
            });

            if (!selected.length) {
                alert('ì¶”ê°€í•  AS ìì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const tbody = document.getElementById('materialList');
            let addedCount = 0;

            selected.forEach(row => {
                const code = row.dataset.asCode;
                const material = list.find(m => m.code === code);
                if (!material) return;
                const qtyInput = row.querySelector('.as-shipment-qty');
                const shipQty = qtyInput ? parseInt(qtyInput.value, 10) : NaN;
                if (!shipQty || shipQty < 1 || shipQty > material.requestQty) return;
                const shipmentTypeSelect = row.querySelector('.as-shipment-type');
                const shipmentType = shipmentTypeSelect ? shipmentTypeSelect.value : 'ì¬ì¶œê³ ';
                const qualitySelect = row.querySelector('.as-material-quality');
                const selectedQuality = qualitySelect ? qualitySelect.value : 'ì¤‘ê³ ';

                const exists = Array.from(tbody.querySelectorAll('tr[data-material]')).some(tr => {
                    const codeCell = tr.querySelector('td:first-child strong');
                    return codeCell && codeCell.textContent.trim() === material.code;
                });
                if (exists) return;

                const materialId = 'AS-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-material="${materialId}">
                        <td><strong>${material.code}</strong></td>
                        <td>${material.name}</td>
                        <td style="font-size:0.8125rem;color:var(--gray-500)">${material.spec}</td>
                        <td>AS(${shipmentType}) / 0</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.25rem">
                                <input type="number" class="form-input" value="${shipQty}" min="1" max="${material.requestQty}" style="padding:0.25rem;width:60px" onchange="checkOverOrder(this, ${material.requestQty}, '${material.unit}')">
                                <span style="font-size:0.8125rem;color:var(--gray-500)">${material.unit}</span>
                            </div>
                        </td>
                        <td>
                            <select class="form-select" style="padding:0.25rem;font-size:0.8125rem">
                                <option ${selectedQuality === 'ì¤‘ê³ ' ? 'selected' : ''}>ì¤‘ê³ </option>
                                <option ${selectedQuality === 'ì‹ í’ˆ' ? 'selected' : ''}>ì‹ í’ˆ</option>
                            </select>
                        </td>
                        <td>
                            <input type="checkbox" onchange="toggleSerialButton(this)">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary serial-select-btn" onclick="openSerialModal('${material.code}', '${material.name}', ${shipQty})" disabled>ì„ íƒ</button>
                        </td>
                        <td><button class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="removeMaterialRow(this)">ì‚­ì œ</button></td>
                    </tr>
                `);
                addedCount += 1;
            });

            selected.forEach(row => {
                const cb = row.querySelector('.as-material-check');
                if (cb) cb.checked = false;
            });

            if (addedCount === 0) {
                alert('ì„ íƒí•œ AS ìì¬ê°€ ì´ë¯¸ ì¶œê³  ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.');
            } else {
                alert(`AS ìì¬ ${addedCount}ê±´ì´ ì¶œê³  ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            if (tabName === 'list') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('listTab').style.display = 'block';
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('registerTab').style.display = 'block';
            }
        }
        
        // loadOrderInfoëŠ” loadShipmentOrderë¡œ ëŒ€ì²´ë¨
        
        function openRecentOrdersModal() {
            document.getElementById('recentOrdersModal').classList.add('active');
        }
        
        function selectRecentOrderFromModal(orderId) {
            selectRecentOrder(orderId);
            closeModal('recentOrdersModal');
        }
        
        function handleMaterialSearch() {
            const keyword = document.getElementById('materialSearch').value.trim().toLowerCase();
            const dropdown = document.getElementById('materialAutocomplete');

            if (!keyword) {
                hideMaterialAutocomplete();
                return;
            }

            const filtered = SHIPMENT_MATERIALS.filter(m =>
                m.code.toLowerCase().includes(keyword) ||
                m.name.toLowerCase().includes(keyword) ||
                m.category.toLowerCase().includes(keyword)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--gray-500);cursor:default">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                dropdown.style.display = 'block';
                return;
            }

            materialAutocompleteItems = filtered;
            materialAutocompleteIndex = -1;

            dropdown.innerHTML = filtered.map((m, idx) => `
                <div class="autocomplete-item" data-index="${idx}" onclick="selectMaterial(${idx})" onmouseover="highlightMaterial(${idx})">
                    <div class="autocomplete-item-name">${m.name}</div>
                    <div class="autocomplete-item-info">${m.code} | ${m.spec} | ${m.category}</div>
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        function handleMaterialKeydown(event) {
            const dropdown = document.getElementById('materialAutocomplete');
            if (dropdown.style.display === 'none' || materialAutocompleteItems.length === 0) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const keyword = document.getElementById('materialSearch').value.trim();
                    if (keyword) addMaterialByName(keyword);
                }
                return;
            }

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                materialAutocompleteIndex = Math.min(materialAutocompleteIndex + 1, materialAutocompleteItems.length - 1);
                highlightMaterial(materialAutocompleteIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                materialAutocompleteIndex = Math.max(materialAutocompleteIndex - 1, -1);
                highlightMaterial(materialAutocompleteIndex);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (materialAutocompleteIndex >= 0) selectMaterial(materialAutocompleteIndex);
            } else if (event.key === 'Escape') {
                hideMaterialAutocomplete();
            }
        }

        function handleMaterialFocus() {
            const keyword = document.getElementById('materialSearch').value.trim();
            if (keyword) handleMaterialSearch();
        }

        function highlightMaterial(index) {
            const items = document.querySelectorAll('#materialAutocomplete .autocomplete-item');
            items.forEach((item, i) => item.classList.toggle('selected', i === index));
            materialAutocompleteIndex = index;
        }

        function selectMaterial(index) {
            const material = materialAutocompleteItems[index];
            if (!material) return;
            addMaterialFromData(material);
            hideMaterialAutocomplete();
        }

        function hideMaterialAutocomplete() {
            const dropdown = document.getElementById('materialAutocomplete');
            if (dropdown) dropdown.style.display = 'none';
            materialAutocompleteIndex = -1;
        }

        function addMaterialFromData(material) {
            const tbody = document.getElementById('materialList');
            const exists = Array.from(tbody.querySelectorAll('tr[data-material]')).some(tr => {
                const codeCell = tr.querySelector('td:first-child strong');
                return codeCell && codeCell.textContent.trim() === material.code;
            });
            if (exists) return alert('ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì…ë‹ˆë‹¤.');

            const materialId = 'MAT-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            tbody.insertAdjacentHTML('beforeend', `
                <tr data-material="${materialId}">
                    <td><strong>${material.code}</strong></td>
                    <td>${material.name}</td>
                    <td style="font-size:0.8125rem;color:var(--gray-500)">${material.spec}</td>
                    <td>- / -</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:0.25rem">
                            <input type="number" class="form-input" value="1" min="1" style="padding:0.25rem;width:60px" onchange="checkOverOrder(this, 0, '${material.unit}')">
                            <span style="font-size:0.8125rem;color:var(--gray-500)">${material.unit}</span>
                        </div>
                    </td>
                    <td>
                        <select class="form-select" style="padding:0.25rem;font-size:0.8125rem">
                            <option>ì‹ í’ˆ</option>
                            <option>ì¤‘ê³ </option>
                        </select>
                    </td>
                    <td><input type="checkbox" onchange="toggleSerialButton(this)"></td>
                    <td><button class="btn btn-sm btn-secondary serial-select-btn" onclick="openSerialModal('${material.code}', '${material.name}', 1)" disabled>ì„ íƒ</button></td>
                    <td><button class="btn btn-sm" style="background:var(--danger);color:#fff" onclick="removeMaterialRow(this)">ì‚­ì œ</button></td>
                </tr>
            `);
            document.getElementById('materialSearch').value = '';
        }

        function addMaterialByName(name) {
            const keyword = (name || '').trim().toLowerCase();
            if (!keyword) return;
            const found = SHIPMENT_MATERIALS.find(m =>
                m.name.toLowerCase().includes(keyword) ||
                m.code.toLowerCase().includes(keyword)
            );
            if (found) {
                addMaterialFromData(found);
            } else {
                addMaterialFromData({
                    code: name.trim(),
                    name: name.trim(),
                    spec: '-',
                    unit: 'ê°œ',
                    serialTracking: false
                });
            }
        }

        function addMaterial() {
            const search = document.getElementById('materialSearch').value.trim();
            if (!search) return alert('ìì¬ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”');
            addMaterialByName(search);
            hideMaterialAutocomplete();
        }

        function toggleSerialButton(checkbox) {
            const row = checkbox.closest('tr');
            if (!row) return;
            const button = row.querySelector('.serial-select-btn');
            if (!button) return;
            button.disabled = !checkbox.checked;
        }
        
        function removeMaterialRow(btn) {
            const row = btn.closest('tr');
            const materialId = row.dataset.material;
            // ì´ˆê³¼ ì‚¬ìœ  í–‰ë„ í•¨ê»˜ ì‚­ì œ
            const reasonRow = document.querySelector(`tr.over-reason-row[data-for="${materialId}"]`);
            if (reasonRow) reasonRow.remove();
            row.remove();
        }
        
        function checkOverOrder(input, remaining, unit) {
            const qty = parseInt(input.value) || 0;
            const row = input.closest('tr');
            const materialId = row.dataset.material;
            
            // ê¸°ì¡´ ì´ˆê³¼ ì‚¬ìœ  í–‰ ì°¾ê¸°
            let reasonRow = document.querySelector(`tr.over-reason-row[data-for="${materialId}"]`);
            
            if (qty > remaining && remaining > 0) {
                const overQty = qty - remaining;
                if (!reasonRow) {
                    // ì´ˆê³¼ ì‚¬ìœ  í–‰ ì¶”ê°€
                    row.insertAdjacentHTML('afterend', `
                        <tr class="over-reason-row" data-for="${materialId}" style="background:#FFF8E1">
                            <td colspan="9" style="padding:0.5rem 1rem">
                                <div style="display:flex;align-items:center;gap:1rem">
                                    <span style="color:var(--warning);font-weight:600;white-space:nowrap">âš ï¸ ${overQty}${unit} ì´ˆê³¼</span>
                                    <input type="text" class="form-input over-reason-input" placeholder="ì´ˆê³¼ ì¶œê³  ì‚¬ìœ  ì…ë ¥ *" style="flex:1;padding:0.375rem">
                                </div>
                            </td>
                        </tr>
                    `);
                } else {
                    // ì´ˆê³¼ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
                    reasonRow.querySelector('span').innerHTML = `âš ï¸ ${overQty}${unit} ì´ˆê³¼`;
                }
            } else {
                // ì´ˆê³¼ ì•„ë‹ˆë©´ ì‚¬ìœ  í–‰ ì œê±°
                if (reasonRow) reasonRow.remove();
            }
        }
        
        function openSerialModal(materialCode, materialName, qty) {
            currentSerialMaterial = materialCode;
            requiredQty = qty;
            
            document.getElementById('serialMaterialName').textContent = materialName;
            document.getElementById('serialQty').textContent = qty;
            document.getElementById('requiredCount').textContent = qty;
            
            updateSerialCount();
            document.getElementById('serialModal').classList.add('active');
        }
        
        function selectAllSerials() {
            const checkboxes = document.querySelectorAll('.serial-check');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach((cb, index) => {
                cb.checked = !allChecked && index < requiredQty;
            });
            
            updateSerialCount();
        }
        
        function updateSerialCount() {
            const checked = document.querySelectorAll('.serial-check:checked').length;
            document.getElementById('selectedCount').textContent = checked;
            
            const statusEl = document.getElementById('serialMatchStatus');
            if (checked === requiredQty) {
                statusEl.innerHTML = '<span style="color:var(--success);font-weight:600">âœ… ì¼ì¹˜</span>';
            } else if (checked < requiredQty) {
                statusEl.innerHTML = `<span style="color:var(--danger);font-weight:600">âŒ ${requiredQty - checked}ê°œ ë¶€ì¡±</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:var(--warning);font-weight:600">âš ï¸ ${checked - requiredQty}ê°œ ì´ˆê³¼</span>`;
            }
        }
        
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('serial-check')) {
                updateSerialCount();
            }
        });
        
        function confirmSerialSelection() {
            const checked = document.querySelectorAll('.serial-check:checked').length;
            
            if (checked !== requiredQty) {
                alert(`ì¶œê³  ìˆ˜ëŸ‰(${requiredQty}ê°œ)ê³¼ ì„ íƒí•œ ì‹œë¦¬ì–¼ ìˆ˜(${checked}ê°œ)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                return;
            }
            
            alert('âœ… ì‹œë¦¬ì–¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeModal('serialModal');
        }
        
        function showDetail(shipmentNo) {
            document.getElementById('detailShipmentNo').textContent = shipmentNo;
            document.getElementById('detailNo').textContent = shipmentNo;
            
            // ì´ˆê³¼ ì¶œê³  ê±´ì¸ ê²½ìš°
            if (shipmentNo === 'OUT-2024-048') {
                document.getElementById('overOrderReasonBox').style.display = 'block';
                document.getElementById('detailStatus').className = 'status-badge status-warning';
                document.getElementById('detailStatus').textContent = 'ì´ˆê³¼';
            } else {
                document.getElementById('overOrderReasonBox').style.display = 'none';
                document.getElementById('detailStatus').className = 'status-badge status-complete';
                document.getElementById('detailStatus').textContent = 'ì™„ë£Œ';
            }
            
            document.getElementById('detailModal').classList.add('active');
        }
        
        function printShipmentDocument(shipmentNo) {
            // ì¶œê³ ì¦ ì¶œë ¥ ê¸°ëŠ¥
            alert(`ì¶œê³ ì¦ ì¶œë ¥: ${shipmentNo}\n\nì¶œê³ ì¦ íŒŒì¼ì„ ì—´ê±°ë‚˜ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì´ ì—¬ê¸°ì— êµ¬í˜„ë©ë‹ˆë‹¤.`);
            // ì˜ˆì‹œ: window.open(`/shipments/${shipmentNo}.pdf`, '_blank');
        }
        
        function openShipmentConfirmModal(shipmentNo) {
            // ê°„ë‹¨íˆ ì„ íƒëœ ì¶œê³  ë²ˆí˜¸ë§Œ ì „ë‹¬í•˜ì—¬ ì¶œê³  í™•ì¸ ëª¨ë‹¬ì„ ì˜¤í”ˆ
            document.getElementById('confirmShipmentNo').textContent = shipmentNo;
            document.getElementById('confirmDetailNo').textContent = shipmentNo;
            // TODO: ì‹¤ì œ êµ¬í˜„ ì‹œ shipmentNo ê¸°ë°˜ìœ¼ë¡œ ìƒì„¸ ë°ì´í„° ë°”ì¸ë”©
            document.getElementById('confirmModal').classList.add('active');
            initSignaturePad();
        }
        
        let signaturePad, signaturePadCtx, isDrawing = false;
        
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            signaturePad = canvas;
            signaturePadCtx = canvas.getContext('2d');
            signaturePadCtx.strokeStyle = '#111827';
            signaturePadCtx.lineWidth = 2;
            signaturePadCtx.lineCap = 'round';
            signaturePadCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                if (e.touches && e.touches[0]) {
                    return {
                        x: e.touches[0].clientX - rect.left,
                        y: e.touches[0].clientY - rect.top
                    };
                }
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            };
            
            const startDraw = (e) => {
                isDrawing = true;
                const pos = getPos(e);
                signaturePadCtx.beginPath();
                signaturePadCtx.moveTo(pos.x, pos.y);
                e.preventDefault();
            };
            
            const draw = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                signaturePadCtx.lineTo(pos.x, pos.y);
                signaturePadCtx.stroke();
                e.preventDefault();
            };
            
            const endDraw = (e) => {
                if (!isDrawing) return;
                isDrawing = false;
                e.preventDefault();
            };
            
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            canvas.onmousedown = startDraw;
            canvas.onmousemove = draw;
            canvas.onmouseup = endDraw;
            canvas.onmouseleave = endDraw;
            
            // í„°ì¹˜ ì´ë²¤íŠ¸
            canvas.ontouchstart = startDraw;
            canvas.ontouchmove = draw;
            canvas.ontouchend = endDraw;
        }
        
        function clearSignature() {
            if (!signaturePad || !signaturePadCtx) return;
            signaturePadCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        }
        
        function submitShipmentConfirm() {
            alert('âœ… ì¶œê³ ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì„œëª… ë°ì´í„°ëŠ” ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.)');
            closeModal('confirmModal');
        }
        
        function showSerialList() {
            document.getElementById('serialListModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function confirmShipment() {
            const order = document.getElementById('shipOrderSelect').value;
            const preShipmentReasonGroup = document.getElementById('preShipmentReasonGroup');
            const preShipmentReasonInput = document.getElementById('preShipmentReason');
            
            if (!order) {
                alert('ë°œì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            // ì„ ì¶œê³ ì¸ ê²½ìš° ì„ ì¶œê³  ì‚¬ìœ  í•„ìˆ˜ ì…ë ¥
            if (order === 'PRE_SHIPMENT') {
                if (!preShipmentReasonInput || !preShipmentReasonInput.value.trim()) {
                    alert('ì„ ì¶œê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    if (preShipmentReasonInput) preShipmentReasonInput.focus();
                    return;
                }
            }
            
            // ê°œë³„ ì´ˆê³¼ ì‚¬ìœ  í™•ì¸
            const reasonInputs = document.querySelectorAll('.over-reason-input');
            for (const input of reasonInputs) {
                if (!input.value.trim()) {
                    alert('ëª¨ë“  ì´ˆê³¼ ì¶œê³  í•­ëª©ì˜ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    input.focus();
                    return;
                }
            }
            
            if (confirm('ì¶œê³ ë¥¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°œì£¼: IT260115-01\ní˜„ì¥: ê°•ë‚¨ ì˜¤í”¼ìŠ¤í…”')) {
                alert('âœ… ì¶œê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì¶œê³  ë²ˆí˜¸: OUT-2024-051');
                switchTab('list');
            }
        }
        
        function filterPreShipment() {
            const checkbox = document.getElementById('preShipmentOnly');
            const rows = document.querySelectorAll('#listTab tbody tr');
            
            rows.forEach(row => {
                const shipmentCell = row.querySelector('td:nth-child(2)');
                if (shipmentCell) {
                    const isPreShipment = shipmentCell.textContent.includes('ì„ ì¶œê³ ');
                    if (checkbox.checked) {
                        row.style.display = isPreShipment ? '' : 'none';
                    } else {
                        row.style.display = '';
                    }
                }
            });
        }
        
        function handleSearch() {
            // ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„
        }
        
        function resetFilters() {
            // í•„í„° ì´ˆê¸°í™”
            document.getElementById('preShipmentOnly').checked = false;
            filterPreShipment();
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal').forEach(m => {
            m.onclick = e => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            };
        });
    </script>
</body>
</html>
